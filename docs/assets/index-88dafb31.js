import{c as Oe}from"./_commonjsHelpers-725317a4.js";/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const De=y=>m=>typeof m=="function"?((v,D)=>(customElements.define(v,D),D))(y,m):((v,D)=>{const{kind:k,elements:P}=D;return{kind:k,elements:P,finisher(ht){customElements.define(v,ht)}}})(y,m);/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const Ee=(y,m)=>m.kind==="method"&&m.descriptor&&!("value"in m.descriptor)?{...m,finisher(v){v.createProperty(m.key,y)}}:{kind:"field",key:Symbol(),placement:"own",descriptor:{},originalKey:m.key,initializer(){typeof m.initializer=="function"&&(this[m.key]=m.initializer.call(this))},finisher(v){v.createProperty(m.key,y)}},Te=(y,m,v)=>{m.constructor.createProperty(v,y)};function Re(y){return(m,v)=>v!==void 0?Te(y,m,v):Ee(y,m)}/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */function Fe(y){return Re({...y,state:!0})}/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */var gt;((gt=window.HTMLSlotElement)===null||gt===void 0?void 0:gt.prototype.assignedElements)!=null;var Ot={exports:{}};(function(y,m){(function(v,D){y.exports=D()})(Oe,()=>(()=>{var v={d:(h,t)=>{for(var e in t)v.o(t,e)&&!v.o(h,e)&&Object.defineProperty(h,e,{enumerable:!0,get:t[e]})},o:(h,t)=>Object.prototype.hasOwnProperty.call(h,t),r:h=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(h,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(h,"__esModule",{value:!0})}},D={};v.r(D),v.d(D,{Arpeggiator:()=>Tt,Arpeggio:()=>Rt,ArpeggioNote:()=>ft,ButtonEvent:()=>rt,ButtonEventData:()=>nt,ButtonInput:()=>o,ChannelPressureMessage:()=>Y,Chord:()=>V,ChordFinder:()=>Ft,ChordProgression:()=>At,ChordProgressionPlayer:()=>Kt,Clip:()=>st,ClipBend:()=>U,ClipCC:()=>j,ClipNote:()=>J,ClipPlayer:()=>ee,ClipRecorder:()=>se,ClipRecorderEvent:()=>yt,ClipRecorderEventData:()=>Mt,Clock:()=>Et,ClockChildFinishedEvent:()=>B,ClockChildFinishedEventData:()=>N,ContinueMessage:()=>W,ControlChangeMessage:()=>F,Cue:()=>he,EventSubscriber:()=>oe,Flexinome:()=>ue,Gamepads:()=>ce,Keyboard:()=>le,Metronome:()=>ae,MidiAccess:()=>lt,MidiAccessPortEvent:()=>Pt,MidiAccessPortEventData:()=>kt,MidiBus:()=>_e,MidiIn:()=>pe,MidiInEvent:()=>f,MidiInEventData:()=>p,MidiMessageBase:()=>K,MidiOut:()=>ge,MiscController:()=>fe,Note:()=>et,NoteOffMessage:()=>T,NoteOnMessage:()=>O,NotePressureMessage:()=>A,PS4Controller:()=>me,PitchBendMessage:()=>R,ProgramChangeMessage:()=>G,PropertyTracker:()=>b,Repeat:()=>ye,Scale:()=>Z,ScaleTemplate:()=>d,SliderEvent:()=>Bt,SliderEventData:()=>Nt,SliderInput:()=>Q,SongPositionMessage:()=>X,StartMessage:()=>$,StopMessage:()=>H,TickMessage:()=>z,TickReceiver:()=>ke,TickSender:()=>Pe,TimeSig:()=>it,TimeSigDivision:()=>ct,ToneJSMidiOut:()=>Be,Tween:()=>M,WebAudioMidiOut:()=>Se,WebAudioMidiOutChannel:()=>pt,pitch:()=>w});class k{constructor(t){this.cancel=!1,this.source=t}}class P{constructor(){this._handlers=[]}get handlers(){return this._handlers}add(t){if(!t)throw new Error("Invalid handler value");if(typeof t=="function"){const e=new ht(t);return this.handlers.push(e),e}return this.handlers.push(t),t}remove(t){this._handlers=this._handlers.filter(e=>!t(e))}trigger(t){for(const e of this.handlers){if(t!=null&&t.cancel)break;e.on&&e.logic(t)}}}class ht{constructor(t,e){this._on=!0,this._logic=t,this.ref=e}get logic(){return this._logic}get ref(){return this._ref}set ref(t){this._ref=t}get on(){return this._on}set on(t){this._on=t}withRef(t){return this.ref=t,this}}class Et{constructor(t=5){this._children=[],this._msPerTick=t}get msPerTick(){return this._msPerTick}get children(){return this._children}get running(){return!!this._timer}start(){return!this.running&&(this._timer=setInterval(()=>this.updateChildren(),this.msPerTick),this._lastUpdateTime=new Date().getTime(),!0)}stop(){return!!this.running&&(clearTimeout(this._timer),this._timer=null,this._lastUpdateTime=null,!0)}addChild(t){return this._children.push(t),t}stopChildren(t){for(const e of this._children)t(e)&&e.finish()}updateChildren(){const t=new Date().getTime(),e=t-this._lastUpdateTime;this._lastUpdateTime=t;for(const s of this._children)s.isFinished||s.update(e);this._children=this._children.filter(s=>!s.isFinished)}}class N extends k{constructor(t){super(t)}}class B extends P{}class b{constructor(t){this.value=t,this.oldValue=t}get isDirty(){return this.value!==this.oldValue}accept(){this.oldValue=this.value}undo(){this.value=this.oldValue}}class Tt{constructor(t,e,s){this._channel=0,this._speed=1,this._beatTracker=new b(0),this._running=!0,this._isFinished=!1,this._finished=new B,this._notes=[],this.arpeggio=t,this.metronome=e,this.midiOut=s}get arpeggio(){return this._arpeggio}set arpeggio(t){this._arpeggio=t}get chord(){return this._chord}set chord(t){this._chord=t,this._endAllNotes()}get channel(){return this._channel}set channel(t){this._channel=t}get ref(){return this._ref}set ref(t){this._ref=t}get metronome(){return this._metronome}set metronome(t){this._metronome=t}get midiOut(){return this._midiOut}set midiOut(t){this._midiOut=t}get speed(){return this._speed}set speed(t){this._speed=t}get beat(){return this._beatTracker.value}set beat(t){this._beatTracker.value=t}get beatTracker(){return this._beatTracker}get running(){return this._running}set running(t){this._running=t}get noteModifier(){return this._noteModifier}set noteModifier(t){this._noteModifier=t}get isFinished(){return this._isFinished}get finished(){return this._finished}update(t){if(!(this.running&&this.arpeggio&&this.metronome&&this.midiOut))return;const e=(this.metronome.totalBeat-this.metronome.totalBeatTracker.oldValue)*this.speed;if(e==0)return;this.beatTracker.accept(),this.beatTracker.value=(this.beatTracker.value+e)%this.arpeggio.duration;const s=this.beatTracker.oldValue,i=this.beatTracker.value;s>i&&this._endAllNotes();for(const n of this._notes){const r=n.arpNote;!r.contains(i)||i<s?n.stop():typeof r.velocity!="number"&&(n.velocity=r.velocity.update((i-r.start)/r.duration))}if(this._notes=this._notes.filter(n=>n.on),this.chord)for(const n of this.arpeggio.getNotesStartingInRange(s,i)){const r=n.createNote(this.chord,this.channel,(i-n.start)/n.duration);r&&(r.arpNote=n,this.noteModifier&&this.noteModifier(r),this._notes.push(r),this.midiOut.addNote(r))}}finish(){this._isFinished=!0,this._endAllNotes(),this.finished.trigger(new N(this))}withRef(t){return this._ref=t,this}_endAllNotes(){for(const t of this._notes)t.stop();this._notes=[]}}class L{constructor(t,e){this.start=t,this.duration=e}get start(){return this._start}set start(t){this._start=t}get duration(){return this._duration}set duration(t){if(t<0)throw new Error("Cannot set duration to negative value");this._duration=t}get end(){return this._start+this._duration}set end(t){this.duration=t-this._start}getPercent(t){return this.duration==0?0:(t-this.start)/this.duration}contains(t){return t>=this.start&&t<=this.end}}function g(h,t){return(h%t+t)%t}function q(h,t,e){const s=e(h),i=e(t);return s<i?-1:s>i?1:0}function w(h){let t={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[h[0]];if(t==null)throw new Error(h+" is not a valid pitch name");let e=-1;for(let s=1;s<h.length;s++){const i=h[s];if(i!="‚ôÆ")if(i=="b"||i=="‚ô≠")t--;else if(i=="#"||i=="‚ôØ")t++;else if(i=="x")t+=2;else if(i=="ùÑ™"[0]&&h.length>s+1&&h[s+1]=="ùÑ™"[1])t+=2,s++;else{if(!(i=="ùÑ´"[0]&&h.length>s+1&&h[s+1]=="ùÑ´"[1])){if(e=Number(h.substring(s)),Number.isNaN(e))throw new Error(h+" is not a valid pitch name");break}t-=2,s++}}return g(t,12)+12*(e+1)}function ot(h){return typeof h=="string"&&(h=w(h)),440*Math.pow(2,(h-69)/12)}class et{constructor(t,e,s,i){this._pitch=typeof t=="string"?w(t):t,this.velocityTracker=new b(Math.round(e)),this.onTracker=new b(!1),this.on=!0,this._channel=s,this.ref=i}get pitch(){return this._pitch}set pitch(t){this._pitch=t}get velocity(){return this.velocityTracker.value}set velocity(t){this.velocityTracker.value=Math.round(t)}get on(){return this.onTracker.value}set on(t){this.onTracker.value=t}get channel(){return this._channel}set channel(t){this._channel=t}start(){return!this.on&&(this.on=!0,!0)}stop(){return!!this.on&&(this.on=!1,!0)}}class ft extends L{constructor(t,e,s,i,n=null){super(t,e),this._channel=null,this.pitch=s,this.velocity=i,this.channel=n}get pitch(){return this._pitch}set pitch(t){this._pitch=t}get velocity(){return this._velocity}set velocity(t){this._velocity=t}get channel(){return this._channel}set channel(t){this._channel=t}createNote(t,e,s){var i;if(!t)return null;const n=this.pitch(t);return n==null||n<0||n>127?null:new et(n,typeof this.velocity=="number"?this.velocity:this.velocity.update(s),(i=this.channel)!==null&&i!==void 0?i:e)}}class Rt extends L{constructor(t){super(0,t),this.notes=[]}addNote(t,e,s,i,n=null){typeof t=="number"&&(t=[t]);for(const r of t)this.notes.push(new ft(r,e,s,i,n));return this}getNotesStartingInRange(t,e){return t<=e?this.notes.filter(s=>s.start>=t&&s.start<e):this.notes.filter(s=>s.start>=t||s.start<e)}getNotesEndingInRange(t,e){return t<=e?this.notes.filter(s=>s.end>=t&&s.end<e):this.notes.filter(s=>s.end>=t||s.end<e)}}class nt extends k{constructor(t){super(t)}}class rt extends P{}class o{constructor(t){this._activeMs=0,this.pressed=new rt,this.released=new rt,this.changed=new rt,this.valueTracker=new b(0),this._name=t}get value(){return this.valueTracker.value}get isPressed(){return this.valueTracker.value!=0}get name(){return this._name}get activeMs(){return this._activeMs}update(t){this.isPressed&&(this._activeMs+=t),this.valueTracker.isDirty&&(this.isPressed?this.valueTracker.oldValue==0?this.pressed.trigger(new nt(this)):this.changed.trigger(new nt(this)):(this.released.trigger(new nt(this)),this._activeMs=0)),this.valueTracker.accept()}}class mt{constructor(t){this.maxMovement=2,this.preferRoot=!0,this.preferredDirection="DOWN",this.precision="TIGHT",this.scale=null,t&&Object.assign(this,t)}}class V{constructor(){this._pitches=[],this._root=null,this._name=null}get pitches(){return this._pitches}get root(){return this._root}set root(t){this.setRoot(t)}get name(){return this._name==null&&V.nameGenerator!=null&&(this._name=V.nameGenerator(this)),this._name}addPitch(t){if(typeof t=="string"&&(t=w(t)),!this._pitches.find(e=>e==t)){this._name=null;for(let e=0;e<this._pitches.length;e++)if(this._pitches[e]>t)return this._pitches.splice(e,0,t),this;this._pitches.push(t)}return this}addPitches(t){for(const e of t)this.addPitch(e);return this}removePitches(t){const e=this._pitches.length;return this._pitches=this._pitches.filter(s=>!t(s)),this._pitches.length<e&&(this._name=null),this.root&&!this._pitches.find(s=>s==this.root)&&(this.root=null),this}setRoot(t){return typeof t=="string"&&(t=w(t)),this._root!=t&&(t==null||t==null?this._root=null:(this._root=t,this.addPitch(t)),this._name=null),this}getPitch(t){t=Math.round(t);const e=Math.floor(t/this.pitches.length);return t-=e*this.pitches.length,this.pitches[t]+12*e}contains(t){return typeof t=="string"&&(t=w(t)),t=g(t,12),this.pitches.find(e=>g(e,12)==t)!=null}duplicate(){const t=new V;return t._pitches=this.pitches.slice(),t._root=this.root,t._name=this.name,t}addDegrees(t,e=null){if(this.root==null)throw new Error("You cannot add degrees to the chord before its root has been set");for(const s of t.map(i=>i-1)){let i=this.root;s>=7&&(i+=12*Math.floor(s/7));let n={main:0,fallback:0};switch(s%7){case 1:n={main:2,fallback:1};break;case 2:n={main:4,fallback:3};break;case 3:n={main:5,fallback:6};break;case 4:n={main:7,fallback:6};break;case 5:n={main:9,fallback:8};break;case 6:n={main:11,fallback:10}}e==null||e.contains(i+n.main)||!e.contains(i+n.fallback)?i+=n.main:i+=n.fallback,this.addPitch(i)}return this}add2nd(t=null){return this.addDegrees([2],t)}add3rd(t=null){return this.addDegrees([3],t)}add4th(t=null){return this.addDegrees([4],t)}add5th(t=null){return this.addDegrees([5],t)}add6th(t=null){return this.addDegrees([6],t)}add7th(t=null){return this.addDegrees([7],t)}add9th(t=null){return this.addDegrees([9],t)}add11th(t=null){return this.addDegrees([11],t)}near(t,e=!1){typeof t=="string"&&(t=w(t));const s=this.pitches.reduce((n,r)=>n+r,0)/this.pitches.length;let i=Math.round((t-s)/6);if(i%2==1&&(i=i<0?i+1:i-1),i/=2,i!=0)for(let n=0;n<this.pitches.length;n++)this.pitches[n]+=12*i;if(e){for(let n=0;n<this.pitches.length;n++)t-this.pitches[n]>6?this.pitches[n]+=12:this.pitches[n]-t>6&&(this.pitches[n]-=12);this._pitches=this.pitches.sort((n,r)=>q(n,r,a=>a))}return this}fitPitch(t,e){typeof t=="string"&&(t=w(t));const s=new mt(e);let i=u=>this._isTightFit(u,s);s.precision=="MEDIUM"&&(i=u=>this._isMediumFit(u,s)),s.precision=="LOOSE"&&(i=u=>this._isLooseFit(u,s));let n=1;s.preferredDirection=="DOWN"?n=-1:s.preferredDirection=="RANDOM"&&(n=Math.random()>=.5?1:-1);let r=t,a=t;for(t%1!=0&&(r=n>0?Math.ceil(t):Math.floor(t),a=n>0?Math.floor(t):Math.ceil(t));;){const u=Math.abs(r-t)<=s.maxMovement,c=Math.abs(a-t)<=s.maxMovement;if(!u&&!c)break;const l=u?i(r):0,_=c?i(a):0;if(l+_>0){if(l>_)return r;if(_>l)return a;if(s.preferRoot){if(u&&g(r,12)==g(this.root,12))return r;if(c&&g(a,12)==g(this.root,12))return a}return Math.abs(r-t)<=Math.abs(a-t)?r:a}r+=n,a-=n}return Math.round(t)}_isTightFit(t,e){return this.contains(t)?1:0}_isMediumFit(t,e){if(this.contains(t))return 1;const s=e.scale;return s&&!s.contains(t)||this.contains(t+1)||this.contains(t-1)?0:.5}_isLooseFit(t,e){if(this.contains(t))return 1;const s=e.scale;return s?s.contains(t)?.5:0:.5}}function at(h,t){t||(t=s=>Number(s));let e=0;for(const s of h)e+=t(s);return e}function wt(h){const t=[];for(let e=0;e<h.length;e++)h.indexOf(h[e])==e&&t.push(h[e]);return t}function xt(h,t){if(!h||h.length==0)return null;let e=[];for(const s of h){const i=t(s),n=e.find(r=>r.value===i);return n?n.count++:e.push({value:i,count:1}),e.sort((r,a)=>q(r,a,u=>u.count)),e.pop().value}}V.nameGenerator=null;class Dt{constructor(t,e,s,i,n,r){this.shapeName="",this.name="",this.inverseName="",this.pitchMap=0,this.preference=0,this.intervals=[],this.root=0,this.shapeName=t,this.name=s,this.inverseName=i,this.pitchMap=this._getPitchMap(r,e),this.preference=n,this.intervals=e,this.root=r}_getPitchMap(t,e){const s=wt(e.map(n=>g(t+n,12)));let i=0;for(let n of s)i+=Math.pow(2,n);return i}}class vt{constructor(){this.shapeName="",this.name="",this.root=0,this.bass=0,this.pitches=[],this.pitchesAdded=[],this.pitchesRemoved=[]}}class Ft{constructor(){this.lookupData=[]}addChordLookup(t,e,s,i,n){if(!e||e.length==0)throw new Error("No intervals specified in chord lookup");if(e.find(r=>r==0)==null)throw new Error("Chord lookup intervals parameter must contain 0");if(this.lookupData.find(r=>r.shapeName==t))throw new Error("Attempted to add duplicate chord lookup");for(let r=0;r<12;r++)this.lookupData.push(new Dt(t,e,s,i,n,r));return this}removeChordLookup(t){return this.lookupData=this.lookupData.filter(e=>e.shapeName!=t),this}replaceChordLookup(t,e,s,i,n){return this.removeChordLookup(t),this.addChordLookup(t,e,s,i,n),this}withDefaultChordLookups(){return this.addChordLookup("M",[0,4,7],"{r}","{r}/{b}",10),this.addChordLookup("m",[0,3,7],"{r}m","{r}m/{b}",9),this.addChordLookup("M7",[0,4,7,11],"{r}M7","{r}M7/{b}",8),this.addChordLookup("7",[0,4,7,10],"{r}7","{r}7/{b}",8),this.addChordLookup("m7",[0,3,7,10],"{r}m7","{r}m7/{b}",8),this.addChordLookup("dim",[0,3,6],"{r}dim","{r}dim/{b}",7),this.addChordLookup("aug",[0,4,8],"{r}aug","{r}aug/{b}",7),this.addChordLookup("5",[0,7],"{r}5","{r}5",6),this.addChordLookup("sus2",[0,2,7],"{r}sus2","{r}sus2/{b}",6),this.addChordLookup("sus4",[0,5,7],"{r}sus4","{r}sus4/{b}",6),this.addChordLookup("dim7",[0,3,6,9],"{r}dim7","{r}dim7/{b}",5),this.addChordLookup("m7‚ô≠5",[0,3,6,10],"{r}m7‚ô≠5","{r}m7‚ô≠5/{b}",5),this.addChordLookup("M9",[0,4,7,11,14],"{r}M9","{r}M9/{b}",4),this.addChordLookup("9",[0,4,7,10,14],"{r}9","{r}9/{b}",4),this.addChordLookup("m9",[0,3,7,10,14],"{r}m9","{r}m9/{b}",4),this.addChordLookup("add9",[0,4,7,14],"{r}add9","{r}add9/{b}",4),this.addChordLookup("madd9",[0,3,7,14],"{r}madd9","{r}madd9/{b}",4),this.addChordLookup("M11",[0,4,7,11,14,17],"{r}M11","{r}M11/{b}",3),this.addChordLookup("11",[0,4,7,10,14,17],"{r}11","{r}11/{b}",3),this.addChordLookup("m11",[0,3,7,10,14,17],"{r}m11","{r}m11/{b}",3),this.addChordLookup("add11",[0,4,7,17],"{r}add11","{r}add11/{b}",3),this.addChordLookup("madd11",[0,3,7,17],"{r}madd11","{r}madd11/{b}",3),this.addChordLookup("mM7",[0,3,7,11],"{r}mM7","{r}mM7/{b}",2),this.addChordLookup("7‚ôØ5",[0,4,8,10],"{r}7‚ôØ5","{r}7‚ôØ5/{b}",2),this.addChordLookup("7‚ôØ9",[0,4,7,10,15],"{r}7‚ôØ9","{r}7‚ôØ9/{b}",2),this}findChord(t,e=null,s=null,i=null){if(t.length==0)return null;if(e!=null&&t.find(l=>l==e)==null)throw new Error("The root is not contained in the passed in pitches");t.length==1&&e==null&&(e=t[0]);const n=this._getAllPotentialChords(t,e,s,i),r=this._getPitchMap(t);let a=null;for(const l of n){const _=this._getPitchMapDistance(l.pitchMap,r);(a==null||_<a.distance||_==a.distance&&l.preference>a.chord.preference)&&(a={distance:_,chord:l})}if(a==null)return null;const u=new vt;u.shapeName=a.chord.shapeName;const c=[];for(const l of t)if((a.chord.pitchMap|Math.pow(2,g(l,12)))==a.chord.pitchMap){u.pitches.push(l);for(let _ of a.chord.intervals)if(g(a.chord.root+_,12)==g(l,12)){c.push({interval:_,pitch:l});break}}else u.pitchesRemoved.push(l);for(const l of a.chord.intervals)if(!u.pitches.find(_=>g(_,12)==g(a.chord.root+l,12))){const _=[];for(const I of c){const tt=l-I.interval;_.push(I.pitch+tt)}const C=xt(_,I=>I);u.pitches.push(C),u.pitchesAdded.push(C)}return u.pitches.sort((l,_)=>q(l,_,C=>C)),u.bass=u.pitches[0],u.root=u.pitches.find(l=>g(l,12)==g(a.chord.root,12)),u.name=u.bass==u.root?a.chord.name:a.chord.inverseName,u}_getAllPotentialChords(t,e=null,s=null,i=null){const n=this._getPitchMap(t);let r=this.lookupData;return e!=null&&(e=g(e,12),r=r.filter(a=>a.root==e)),s!=null&&(r=r.filter(a=>s.find(u=>u==a.shapeName))),i!=null&&(r=r.filter(a=>{const u=this._getPitchMap(i.pitches);return((a.pitchMap|n)-n|u)-u==0})),r}_getPitchMap(t){const e=wt(t.map(i=>g(i,12)));let s=0;for(let i of e)s+=Math.pow(2,i);return s}_getPitchMapDistance(t,e){let s=t^e,i=0;for(;s!=0;)s&=s-1,i++;return i}findChordByName(t){let e=null;for(const s of this.lookupData){if(e!=null&&e.shapeName==s.shapeName&&e.name==s.name)continue;const i=this._tryLookupMatchToChordName(s,t);if(i)return i;e=s}return null}_tryLookupMatchToChordName(t,e){const s=new vt;s.shapeName=t.shapeName;let i=this._getRegexStringFromLookupDataName(t.name),n=new RegExp(i).exec(e);if(n)s.name=t.name;else{if(i=this._getRegexStringFromLookupDataName(t.inverseName),n=new RegExp(i).exec(e),!n)return null;s.name=t.inverseName}if(s.root=w(n.groups.r)+12,n.groups.b!=null?s.bass=w(n.groups.b):s.bass=s.root,s.pitches=t.intervals.map(r=>r+s.root),s.bass!=s.root){const r=s.pitches.findIndex(a=>a%12==s.bass);r<0?s.pitches.push(s.bass):s.pitches[r]=s.bass}return s.pitches=s.pitches.sort((r,a)=>q(r,a,u=>u)),s}_getRegexStringFromLookupDataName(t){let e=t;for(;;){const s=e.indexOf("{"),i=e.indexOf("}");if(s<0&&i<0)break;if(s<0!=i<0)throw new Error(`'${t}' contains unmatched braces`);if(i<s)throw new Error(`'${t}' contains unmatched braces`);const n=e.slice(s+1,i);e=e.slice(0,s)+`(?<${n}>[A-G](?:‚ôÆ|b|#|‚ô≠|‚ôØ|x|ùÑ™|ùÑ´)*)`+e.slice(i+1)}return"^"+e+"$"}newChord(t){const e=this.findChordByName(t);return e==null?null:new V().addPitches(e.pitches).setRoot(e.root)}}class Qt extends L{constructor(t,e,s){super(t,e),this._chord=s}get chord(){return this._chord}set chord(t){this._chord=t}}class At extends L{constructor(t){super(0,t),this.chords=[]}addChord(t,e,s){const i=new Qt(t,e,s);let n=!1;for(const r of this.chords)if(r.start>=i.start&&r.end<=i.end)r.duration=0,n=!0;else if(r.end>i.start&&r.end<i.end)r.end=i.start;else if(r.start<i.end&&r.start>i.start){const a=r.end;r.start=i.end,r.end=a}return n&&this.removeChords(r=>r.duration==0),this.chords.push(i),this}removeChords(t){this.chords=this.chords.filter(e=>!t(e))}getChordsInRange(t,e){const s=[];for(const i of this.chords)t<=e?Math.max(t,i.start)<Math.min(e,i.end)&&s.push(i):(i.start<e||i.end>t)&&s.push(i);return s}getChordAt(t){return t=g(t,this.duration),this.chords.find(e=>e.start<=t&&e.end>t)}}class Lt extends k{constructor(t,e){super(t),this._chord=e}get chord(){return this._chord}}class qt extends P{}class Kt{constructor(t,e){this._speed=1,this._startBeat=0,this._beatCount=null,this._beatsPassed=0,this._isFinished=!1,this._finished=new B,this._chordChanged=new qt,this.chordProgression=t,this.metronome=e}get chordProgression(){return this._chordProgression}set chordProgression(t){this._chordProgression!==t&&(this._chordProgression=t)}get metronome(){return this._metronome}set metronome(t){this._metronome=t}get speed(){return this._speed}set speed(t){this._speed=t}get startBeat(){return this._startBeat}set startBeat(t){this._startBeat=t}get beatCount(){return this._beatCount}set beatCount(t){this._beatCount=t}get beatsPassed(){return this._beatsPassed}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}get currentChord(){return this._currentChord}get chordChanged(){return this._chordChanged}update(t){const e=(this.metronome.totalBeat-this.metronome.totalBeatTracker.oldValue)*this.speed;if(e==0)return;const s=this.beatsPassed+e,i=(this.startBeat+s)%this.chordProgression.duration;if(this._beatsPassed+=e,typeof this.beatCount=="number"&&this.beatsPassed>=this.beatCount)return void this.finish();const n=this.chordProgression.getChordAt(i);n!==this.currentChord&&(this._currentChord=n,this.chordChanged.trigger(new Lt(this,n==null?void 0:n.chord)))}finish(){this._isFinished=!0,this.finished.trigger(new N(this))}withRef(t){return this._ref=t,this}}class S{constructor(t,e){this._from=t,this._to=e}get from(){return this._from}get to(){return this._to}update(t){return this.from+this.tweenEquation(t)*(this.to-this.from)}tweenEquation(t){return t}then(t,e=1){return new bt(this).then(t,e)}toJSON(){return{type:"Linear",from:this.from,to:this.to}}}class bt{constructor(t,e=1){this._children=[],this._children.push({tween:t,weight:e})}get from(){return this._children[0].tween.from}get to(){return this._children[this._children.length-1].tween.to}update(t){const e=at(this._children,i=>i.weight)*t;let s=0;for(const i of this._children){if(s<=e&&s+i.weight>=e){const n=(e-s)/i.weight;return i.tween.update(n)}s+=i.weight}}then(t,e=1){return this._children.push({tween:t,weight:e}),this}toJSON(){return{type:"Multi",children:this._children.map(t=>{const e=t.tween.toJSON();return e.weight=t.weight,e})}}}class Vt extends S{constructor(t,e){super(t,e)}tweenEquation(t){return-(Math.cos(Math.PI*t)-1)/2}toJSON(){return{type:"SineInOut",from:this.from,to:this.to}}}class Jt extends S{constructor(t,e){super(t,e)}tweenEquation(t){return 1-Math.cos(t*Math.PI/2)}toJSON(){return{type:"SineIn",from:this.from,to:this.to}}}class jt extends S{constructor(t,e){super(t,e)}tweenEquation(t){return Math.sin(t*Math.PI/2)}toJSON(){return{type:"SineOut",from:this.from,to:this.to}}}class Ut extends S{constructor(t,e,s){super(t,e),this.steps=s}get steps(){return this._steps}set steps(t){this._steps=t}tweenEquation(t){return t=Math.min(t,.999),Math.floor(t*(this.steps+1))/this.steps}toJSON(){return{type:"Steps",from:this.from,to:this.to,steps:this.steps}}}class Gt extends S{constructor(t,e){super(t,e)}tweenEquation(t){if(t<.5)return 2*t*t;{const e=1-t;return 1-2*e*e}}toJSON(){return{type:"QuadraticInOut",from:this.from,to:this.to}}}class Yt extends S{constructor(t,e){super(t,e)}tweenEquation(t){return t*t}toJSON(){return{type:"QuadraticIn",from:this.from,to:this.to}}}class zt extends S{constructor(t,e){super(t,e)}tweenEquation(t){const e=1-t;return 1-e*e}toJSON(){return{type:"QuadraticOut",from:this.from,to:this.to}}}class Xt extends S{constructor(t,e){super(t,e)}tweenEquation(t){return t<.5?(t*=2,Math.pow(t,3)/2):(t=2*(1-t),1-Math.pow(t,3)/2)}toJSON(){return{type:"CubicInOut",from:this.from,to:this.to}}}class $t extends S{constructor(t,e){super(t,e)}tweenEquation(t){return Math.pow(t,3)}toJSON(){return{type:"CubicIn",from:this.from,to:this.to}}}class Wt extends S{constructor(t,e){super(t,e)}tweenEquation(t){const e=1-t;return 1-Math.pow(e,3)}toJSON(){return{type:"CubicOut",from:this.from,to:this.to}}}class Ht extends S{constructor(t,e){super(t,e)}tweenEquation(t){return t<.5?(t*=2,Math.pow(t,4)/2):(t=2*(1-t),1-Math.pow(t,4)/2)}toJSON(){return{type:"QuarticInOut",from:this.from,to:this.to}}}class Zt extends S{constructor(t,e){super(t,e)}tweenEquation(t){return Math.pow(t,4)}toJSON(){return{type:"QuarticIn",from:this.from,to:this.to}}}class te extends S{constructor(t,e){super(t,e)}tweenEquation(t){const e=1-t;return 1-Math.pow(e,4)}toJSON(){return{type:"QuarticOut",from:this.from,to:this.to}}}class M{static linear(t,e){return new S(t,e)}static sineInOut(t,e){return new Vt(t,e)}static sineIn(t,e){return new Jt(t,e)}static sineOut(t,e){return new jt(t,e)}static steps(t,e,s){return new Ut(t,e,s)}static quadraticInOut(t,e){return new Gt(t,e)}static quadraticIn(t,e){return new Yt(t,e)}static quadraticOut(t,e){return new zt(t,e)}static cubicInOut(t,e){return new Xt(t,e)}static cubicIn(t,e){return new $t(t,e)}static cubicOut(t,e){return new Wt(t,e)}static quarticInOut(t,e){return new Ht(t,e)}static quarticIn(t,e){return new Zt(t,e)}static quarticOut(t,e){return new te(t,e)}static load(t){const e=t.type;if(e=="Multi"){const n=t.children.map(a=>({tween:M.load(a),weight:a.weight})),r=new bt(n[0].tween,n[0].weight);for(let a=1;a<n.length;a++)r.then(n[a].tween,n[a].weight);return r}const s=t.from,i=t.to;switch(e){case"Linear":return M.linear(s,i);case"SineInOut":return M.sineInOut(s,i);case"SineIn":return M.sineIn(s,i);case"SineOut":return M.sineOut(s,i);case"Steps":return M.steps(s,i,t.steps);case"QuadraticInOut":return M.quadraticInOut(s,i);case"QuadraticIn":return M.quadraticIn(s,i);case"QuadraticOut":return M.quadraticOut(s,i);case"CubicInOut":return M.cubicInOut(s,i);case"CubicIn":return M.cubicIn(s,i);case"CubicOut":return M.cubicOut(s,i);case"QuarticInOut":return M.quarticInOut(s,i);case"QuarticIn":return M.quarticIn(s,i);case"QuarticOut":return M.quarticOut(s,i)}throw new Error("Unrecognised tween type: "+e)}}class J extends L{constructor(t,e,s,i,n=null,r=null){super(t,e),this._channel=null,this.pitch=typeof s=="string"?w(s):s,this.velocity=i,this.channel=n,this.ref=r}get pitch(){return this._pitch}set pitch(t){this._pitch=t}get velocity(){return this._velocity}set velocity(t){this._velocity=t}get channel(){return this._channel}set channel(t){this._channel=t}createNote(t,e){var s;return new et(this.pitch,typeof this.velocity=="number"?this.velocity:this.velocity.update(e),(s=this.channel)!==null&&s!==void 0?s:t,this.ref)}duplicate(){return new J(this.start,this.duration,this.pitch,this.velocity,this.channel,this.ref)}toJSON(){const t={start:this.start,duration:this.duration,pitch:this.pitch,velocity:this.velocity};return this.channel&&(t.channel=this.channel),this.ref&&(t.ref=this.ref),t}static load(t){const e=typeof t.velocity=="number"?t.velocity:M.load(t.velocity);return new J(t.start,t.duration,t.pitch,e,t.channel,t.ref)}}class j extends L{constructor(t,e,s,i,n=null){super(t,e),this._channel=null,this.controller=s,this.value=i,this.channel=n}get controller(){return this._controller}set controller(t){this._controller=t}get value(){return this._value}set value(t){this._value=t}get channel(){return this._channel}set channel(t){this._channel=t}duplicate(){return new j(this.start,this.duration,this.controller,this.value,this.channel)}toJSON(){const t={start:this.start,duration:this.duration,controller:this.controller,value:this.value};return this.channel&&(t.channel=this.channel),t}static load(t){const e=typeof t.value=="number"?t.value:M.load(t.value);return new j(t.start,t.duration,t.controller,e,t.channel)}}class U extends L{constructor(t,e,s,i=null){super(t,e),this._channel=null,this.percent=s,this.channel=i}get percent(){return this._percent}set percent(t){this._percent=t}get channel(){return this._channel}set channel(t){this._channel=t}duplicate(){return new U(this.start,this.duration,this.percent,this.channel)}toJSON(){const t={start:this.start,duration:this.duration,percent:this.percent};return this.channel&&(t.channel=this.channel),t}static load(t){const e=typeof t.percent=="number"?t.percent:M.load(t.percent);return new U(t.start,t.duration,e,t.channel)}}class st extends L{constructor(t){super(0,t),this.notes=[],this.controlChanges=[],this.bends=[]}addNote(t,e,s,i,n=null,r=null){typeof t=="number"&&(t=[t]),typeof s!="number"&&typeof s!="string"||(s=[s]);for(const a of t)for(const u of s)this.notes.push(new J(a,e,u,i,n,r));return this}addCC(t,e,s,i,n=null){typeof t=="number"&&(t=[t]);for(const r of t)this.controlChanges.push(new j(r,e,s,i,n));return this}addBend(t,e,s,i=null){typeof t=="number"&&(t=[t]);for(const n of t)this.bends.push(new U(n,e,s,i));return this}duplicate(){const t=new st(this.duration);return t.notes.push(...this.notes.map(e=>e.duplicate())),t.controlChanges.push(...this.controlChanges.map(e=>e.duplicate())),t.bends.push(...this.bends.map(e=>e.duplicate())),t}quantize(t,e=1){if(!t||t.length==0)throw new Error("You must provide a rhythm to quantize notes to");if(t.find(i=>i<=0)!=null)throw new Error("Quantize rhythm must contain only positive non-zero values");e=Math.min(1,Math.max(0,e));const s=at(t,i=>i);for(const i of this.notes){let n=Math.floor(i.start/s)*s,r=n;for(const a of t)n+=a,Math.abs(n-i.start)<Math.abs(r-i.start)&&(r=n);r%=this.duration,i.start+=e*(r-i.start)}}transpose(t){for(const e of this.notes)e.pitch+=t}invert(t){for(const e of this.notes)e.pitch=2*t-e.pitch}reverse(){for(const t of this.notes)t.start=this.end-t.end;for(const t of this.controlChanges)t.start=this.end-t.end;for(const t of this.bends)t.start=this.end-t.end}getNotesStartingInRange(t,e){return this._getChildrenStartingInRange(this.notes,t,e)}getNotesEndingInRange(t,e){return this._getChildrenEndingInRange(this.notes,t,e)}getControlChangesIntersectingRange(t,e){return this._getChildrenIntersectingRange(this.controlChanges,t,e)}getBendsIntersectingRange(t,e){return this._getChildrenIntersectingRange(this.bends,t,e)}_getChildrenStartingInRange(t,e,s){return e<=s?t.filter(i=>i.start>=e&&i.start<s):t.filter(i=>i.start>=e||i.start<s)}_getChildrenEndingInRange(t,e,s){return e<=s?t.filter(i=>i.end>=e&&i.end<s):t.filter(i=>i.end>=e||i.end<s)}_getChildrenIntersectingRange(t,e,s){return e<=s?t.filter(i=>Math.min(s,i.end)>=Math.max(e,i.start)):t.filter(i=>i.end>=e||i.start<=s)}toJSON(){return{start:this.start,duration:this.duration,notes:this.notes,controlChanges:this.controlChanges,bends:this.bends}}static load(t){const e=new st(t.duration);return e.start=t.start,e.notes.push(...t.notes.map(s=>J.load(s))),e.controlChanges.push(...t.controlChanges.map(s=>j.load(s))),e.bends.push(...t.bends.map(s=>U.load(s))),e}}class K{validateIntInRange(t,e,s,i){if((t=Math.round(t))<e)throw new Error(i+" cannot be less than "+e);if(t>s)throw new Error(i+" cannot be greater than "+s);return t}}class T extends K{constructor(t,e,s){super(),this.pitch=0,this.velocity=0,this.channel=0,this.pitch=typeof t=="string"?w(t):t,this.velocity=e,this.channel=s}toArray(){return[128+this.validateIntInRange(this.channel,0,15,"channel"),this.validateIntInRange(this.pitch,0,127,"pitch"),this.validateIntInRange(this.velocity,0,127,"velocity")]}duplicate(){return new T(this.pitch,this.velocity,this.channel)}}class O extends K{constructor(t,e,s){super(),this.pitch=0,this.velocity=0,this.channel=0,this.pitch=typeof t=="string"?w(t):t,this.velocity=e,this.channel=s}toArray(){return[144+this.validateIntInRange(this.channel,0,15,"channel"),this.validateIntInRange(this.pitch,0,127,"pitch"),this.validateIntInRange(this.velocity,0,127,"velocity")]}duplicate(){return new O(this.pitch,this.velocity,this.channel)}}class A extends K{constructor(t,e,s){super(),this.pitch=0,this.velocity=0,this.channel=0,this.pitch=typeof t=="string"?w(t):t,this.velocity=e,this.channel=s}toArray(){return[160+this.validateIntInRange(this.channel,0,15,"channel"),this.validateIntInRange(this.pitch,0,127,"pitch"),this.validateIntInRange(this.velocity,0,127,"velocity")]}duplicate(){return new A(this.pitch,this.velocity,this.channel)}}class F extends K{constructor(t,e,s){super(),this.controller=0,this.value=0,this.channel=0,this.controller=t,this.value=e,this.channel=s}toArray(){return[176+this.validateIntInRange(this.channel,0,15,"channel"),this.validateIntInRange(this.controller,0,127,"controller"),this.validateIntInRange(this.value,0,127,"value")]}duplicate(){return new F(this.controller,this.value,this.channel)}}class G extends K{constructor(t,e){super(),this.program=0,this.channel=0,this.program=t,this.channel=e}toArray(){return[192+this.validateIntInRange(this.channel,0,15,"channel"),this.validateIntInRange(this.program,0,127,"program")]}duplicate(){return new G(this.program,this.channel)}}class Y extends K{constructor(t,e){super(),this.value=t,this.channel=e}toArray(){return[208+this.validateIntInRange(this.channel,0,15,"channel"),this.validateIntInRange(this.value,0,127,"value")]}duplicate(){return new Y(this.value,this.channel)}}class R extends K{constructor(t,e){super(),this.percent=t,this.channel=e}toArray(){if(this.percent<-1)throw new Error("percent cannot be less than -1");if(this.percent>1)throw new Error("percent cannot be greater than 1");const t=Math.min(16383,this.validateIntInRange(8192*this.percent+8192,0,16384,"bend"));return[224+this.validateIntInRange(this.channel,0,15,"channel"),t%128,Math.floor(t/128)]}duplicate(){return new R(this.percent,this.channel)}static calculatePercent(t,e){let s=128*e+t;return s>=16383&&s<16384&&(s=16384),(s-8192)/8192}}class z{constructor(){}toArray(){return[248]}duplicate(){return new z}}class X{constructor(t){this.value=t}toArray(){if(this.value<0)throw new Error("value cannot be less than 0");if(this.value>16383)throw new Error("value cannot be greater than 16383");return[242,this.value%128,Math.floor(this.value/128)]}duplicate(){return new X(this.value)}}class ${constructor(){}toArray(){return[250]}duplicate(){return new $}}class W{constructor(){}toArray(){return[251]}duplicate(){return new W}}class H{constructor(){}toArray(){return[252]}duplicate(){return new H}}class ee{constructor(t,e,s){this._channel=0,this._speed=1,this._startBeat=0,this._beatCount=null,this._running=!0,this._beatsPassed=0,this._isFinished=!1,this._finished=new B,this._notes=[],this.clip=t,this.metronome=e,this.midiOut=s}get clip(){return this._clip}set clip(t){this._clip!==t&&(this._endAllNotes(),this._clip=t)}get channel(){return this._channel}set channel(t){this._channel=t}get ref(){return this._ref}set ref(t){this._ref=t}get metronome(){return this._metronome}set metronome(t){this._metronome=t}get midiOut(){return this._midiOut}set midiOut(t){this._midiOut=t}get speed(){return this._speed}set speed(t){this._speed=t}get startBeat(){return this._startBeat}set startBeat(t){this._startBeat=t}get beatCount(){return this._beatCount}set beatCount(t){this._beatCount=t}get running(){return this._running}set running(t){this._running=t}get noteModifier(){return this._noteModifier}set noteModifier(t){this._noteModifier=t}get beatsPassed(){return this._beatsPassed}get isFinished(){return this._isFinished}get finished(){return this._finished}start(){this.running=!0}pause(){this.running=!1}stop(){this.running=!1,this._beatsPassed=0}update(t){var e,s;if(!(this.running&&this.clip&&this.metronome&&this.midiOut))return;const i=(this.metronome.totalBeat-this.metronome.totalBeatTracker.oldValue)*this.speed;if(i==0)return;const n=this.beatsPassed,r=this.beatsPassed+i,a=(this.startBeat+n)%this.clip.duration,u=(this.startBeat+r)%this.clip.duration;if(a>u&&this._endAllNotes(),this._beatsPassed+=i,typeof this.beatCount=="number"&&this.beatsPassed>=this.beatCount)this.finish();else{for(const c of this._notes){const l=c.clipNote;l.contains(u)&&this.clip.notes.find(_=>_===l)?typeof l.velocity!="number"&&(c.velocity=l.velocity.update((u-l.start)/l.duration)):c.stop()}this._notes=this._notes.filter(c=>c.on);for(const c of this.clip.getNotesStartingInRange(a,u)){const l=c.createNote(this.channel,(u-c.start)/c.duration);l.clipNote=c,this.noteModifier&&this.noteModifier(l),this._notes.push(l),this.midiOut.addNote(l)}for(const c of this.clip.getControlChangesIntersectingRange(a,u)){const l=typeof c.value=="function";u>c.end&&c.start<a&&!l||this.midiOut.sendMessage(new F(c.controller,typeof c.value=="number"?c.value:c.value.update(Math.min(1,(u-c.start)/c.duration)),(e=c.channel)!==null&&e!==void 0?e:this.channel))}for(const c of this.clip.getBendsIntersectingRange(a,u)){const l=typeof c.percent=="function";u>c.end&&c.start<a&&!l||this.midiOut.sendMessage(new R(typeof c.percent=="number"?c.percent:c.percent.update(Math.min(1,(u-c.start)/c.duration)),(s=c.channel)!==null&&s!==void 0?s:this.channel))}}}finish(){this._isFinished=!0,this._endAllNotes(),this.finished.trigger(new N(this))}withRef(t){return this._ref=t,this}_endAllNotes(){for(const t of this._notes)t.stop();this._notes=[]}}class Mt extends k{constructor(t,e){super(t),this._clip=e}get clip(){return this._clip}}class yt extends P{}class se{constructor(t,e){this._beatCount=4,this._beatsPassed=0,this._clip=new st(4),this._newClip=new yt,this._inProgressNotes=[],this._onNoteOn=s=>{const i=s.message;this._inProgressNotes.push(new J(this._getClipPosition(this.beatsPassed),0,i.pitch,i.velocity,i.channel))},this._onNoteOff=s=>{const i=s.message,n=this._inProgressNotes.find(r=>r.pitch==i.pitch&&r.channel==i.channel);n&&(n.end=this._getClipPosition(this.beatsPassed),this._clip.notes.push(n),this._inProgressNotes=this._inProgressNotes.filter(r=>r.pitch!=i.pitch||r.channel!=i.channel))},this._onControlChange=s=>{const i=s.message;this._clip.controlChanges.push(new j(this._getClipPosition(this.beatsPassed),0,i.controller,i.value,i.channel))},this._onPitchBend=s=>{const i=s.message;this._clip.bends.push(new U(this._getClipPosition(this.beatsPassed),0,i.percent,i.channel))},this._isFinished=!1,this._finished=new B,this.metronome=t,this.midiIn=e}get metronome(){return this._metronome}set metronome(t){this._metronome=t}get midiIn(){return this._midiIn}set midiIn(t){this._midiIn!=t&&(this._removeMidiInSubscriptions(),this._midiIn=t,this._addMidiInSubscriptions())}_addMidiInSubscriptions(){this._midiIn&&!this.isFinished&&(this._midiIn.noteOn.add(this._onNoteOn),this._midiIn.noteOff.add(this._onNoteOff),this._midiIn.controlChange.add(this._onControlChange),this._midiIn.pitchBend.add(this._onPitchBend))}_removeMidiInSubscriptions(){this._midiIn&&(this._midiIn.noteOn.remove(t=>t.logic==this._onNoteOn),this._midiIn.noteOff.remove(t=>t.logic==this._onNoteOff),this._midiIn.controlChange.remove(t=>t.logic==this._onControlChange),this._midiIn.pitchBend.remove(t=>t.logic==this._onPitchBend))}get beatCount(){return this._beatCount}set beatCount(t){this._beatCount=t,this._clip.duration=t??0}get beatsPassed(){return this._beatsPassed}get newClip(){return this._newClip}_getClipPosition(t){return this.beatCount==null?t:t%this._clip.duration}get ref(){return this._ref}set ref(t){this._ref=t}update(t){if(this.isFinished||!this.midiIn||!this.metronome)return;const e=this.metronome.totalBeat-this.metronome.totalBeatTracker.oldValue;if(e==0)return;const s=this.beatsPassed,i=this.beatsPassed+e;this._getClipPosition(s),this._getClipPosition(i),this._beatsPassed+=e,this.beatCount!=null&&this.beatsPassed>=this.beatCount&&this.finish()}get isFinished(){return this._isFinished}get finished(){return this._finished}finish(){this._isFinished=!0,this._removeMidiInSubscriptions(),this.beatCount==null&&(this._clip.duration=this.beatsPassed);for(const t of this._inProgressNotes)t.end=this._clip.duration,this._clip.notes.push(t);this._inProgressNotes=[],this.newClip.trigger(new Mt(this,this._clip)),this.finished.trigger(new N(this))}withRef(t){return this._ref=t,this}}class ut{constructor(t){this._isFinished=!1,this._finished=new B,this._action=t}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}get action(){return this._action}update(t){}finish(){this._isFinished=!0,this.finished.trigger(new N(this))}withRef(t){return this._ref=t,this}}class ie extends ut{constructor(t,e){super(e),this._countPassed=0,this._msCount=t}get msCount(){return this._msCount}update(t){this._countPassed+=t,this._countPassed>=this.msCount&&(this.action(),this.finish())}}class ne extends ut{constructor(t,e){super(e),this._condition=t}get condition(){return this._condition}update(t){this.condition()&&(this.action(),this.finish())}}class re extends ut{constructor(t,e,s){super(s),this._beatsPassed=0,this._metronome=t,this._beatCount=e}get metronome(){return this._metronome}get beatCount(){return this._beatCount}update(t){this._beatsPassed+=this.metronome.totalBeatTracker.value-this.metronome.totalBeatTracker.oldValue,this._beatsPassed>=this.beatCount&&(this.action(),this.finish())}}class he{static when(t,e){return new ne(t,e)}static afterMs(t,e){return new ie(t,e)}static afterBeats(t,e,s){return new re(t,e,s)}}class oe{constructor(t){this.target=t}subscribe(t,e){this.target.addEventListener(t,e)}unsubscribe(t,e){this.target.removeEventListener(t,e)}}Number.prototype.near=function(h){typeof h=="string"&&(h=w(h));let t=h-this;return g(t,12)==6&&(t>0?t--:t++),this+12*Math.round(t/12)};class ct{constructor(t,e=null){this.count=1,this.swing=null,this.count=t,this.swing=e}}class it{constructor(t,e,s=.5){if(this.divisions=[],this.denominator=4,this.swing=0,e<=0||Math.log2(e)%1!=0)throw new Error("Invalid denominator");if(this.denominator=e,t.length==0)throw new Error("Expected at least one division");for(const i of t){let n;if(n=typeof i=="number"?new ct(i):new ct(i.count,i.swing),n.count<=0)throw new Error("Invalid division count");this.divisions.push(n)}this.swing=s}get beatsPerBar(){return this.divisions.length}get quarterNotesPerBar(){return at(this.divisions,t=>t.count)*(4/this.denominator)}applySwing(t,e=null){let s=e??this.swing;if(s==0)return t;let i=Math.floor(t);return t%=1,s=Math.max(-.99,Math.min(.99,s)),i+=t<=s?t/s*.5:.5+(t-s)/(1-s)*.5,i}quarterNoteToBeat(t){var e;const s=this.beatsPerBar,i=this.quarterNotesPerBar,n=Math.floor(t/i)*s;t%=i;let r=0;for(const a of this.divisions){if(!(t>=a.count)){let u=(e=a.swing)!==null&&e!==void 0?e:this.swing;if(u==0)r+=t/a.count;else{u=Math.max(-.99,Math.min(.99,u));const c=u*a.count;r+=t<=c?t/c*.5:.5+(t-c)/(a.count-c)*.5}break}t-=a.count,r++}return n+r}beatToQuarterNote(t){var e;const s=this.beatsPerBar,i=this.quarterNotesPerBar,n=Math.floor(t/s)*i;t%=s;let r=0;for(const a of this.divisions){if(!(t>=1)){let u=(e=a.swing)!==null&&e!==void 0?e:this.swing;if(u==.5)r+=t*a.count;else{u=Math.max(-.99,Math.min(.99,u));const c=u*a.count;r+=t<=.5?2*t*c:c+2*(t-.5)*(a.count-c)}break}r+=a.count,t--}return n+r}static commonTime(t=.5){return new it([1,1,1,1],4,t)}}class Ct{_atBarPosition(t,e){return e.oldValue===e.value?e.value===t:e.oldValue<e.value?t>e.oldValue&&t<=e.value:t<=e.value||t>e.oldValue}_atBarPositionMultiple(t,e){var s=e.oldValue/t,i=e.value/t;return i%1==0?i:Math.floor(s)===Math.floor(i)?-1:Math.floor(i)}}class ae extends Ct{constructor(t,e=null){if(super(),this._tempo=120,this._tempoMultiplier=1,this._timeSig=new b,this._totalQuarterNote=new b(0),this._totalBeat=new b(0),this._bar=new b(1),this._barQuarterNote=new b(0),this._barBeat=new b(0),this._enabled=new b(!0),this._isFinished=!1,this._finished=new B,this._positionChanged=new P,this._started=new P,this._continued=new P,this._stopped=new P,!t||t<0)throw new Error("Invalid tempo provided");this.timeSig=e||it.commonTime(),this._timeSig.accept(),this.tempo=t}get tempo(){return this._tempo}set tempo(t){this._tempo=t}get tempoMultiplier(){return this._tempoMultiplier}set tempoMultiplier(t){if(t<=0)throw new Error("Invalid tempoMultiplier.");this._tempoMultiplier=t}get ref(){return this._ref}set ref(t){this._ref=t}get timeSig(){return this._timeSig.oldValue}set timeSig(t){this._timeSig.value=t}get totalQuarterNote(){return this._totalQuarterNote.value}get totalQuarterNoteTracker(){return this._totalQuarterNote}get totalBeat(){return this._totalBeat.value}get totalBeatTracker(){return this._totalBeat}get bar(){return this._bar.value}get barTracker(){return this._bar}get barQuarterNote(){return this._barQuarterNote.value}get barQuarterNoteTracker(){return this._barQuarterNote}get barBeat(){return this._barBeat.value}get barBeatTracker(){return this._barBeat}get enabled(){return this._enabled.value}set enabled(t){this._enabled.value!=t&&(this._enabled.value=t,t?this.continued.trigger(new k(this)):this.stopped.trigger(new k(this)))}get isFinished(){return this._isFinished}get finished(){return this._finished}atBarBeat(t){return super._atBarPosition(t,this._barBeat)}atBarQuarterNote(t){return super._atBarPosition(t,this._barQuarterNote)}atBarBeatMultiple(t){return super._atBarPositionMultiple(t,this._barBeat)}atBarQuarterNoteMultiple(t){return super._atBarPositionMultiple(t,this._barQuarterNote)}update(t){const e=t*(this.tempo/6e4)*this.tempoMultiplier;return this.updateFromQuarterNoteDelta(e)}updateFromQuarterNoteDelta(t){if(this._enabled.accept(),!this.enabled)return!1;this._totalQuarterNote.oldValue==0&&this.started.trigger(new k(this)),this._totalQuarterNote.accept(),this._totalQuarterNote.value+=t,this._barQuarterNote.accept(),this._barQuarterNote.value+=t,this._bar.accept();let e=0;for(;e=this.timeSig.quarterNotesPerBar,!(this.barQuarterNote<e);)this._barQuarterNote.value-=e,this._bar.value++,this._timeSig.accept();this._barBeat.accept(),this._totalBeat.accept(),this._updateBeatValuesFromQuarterNoteValues()}_updateBeatValuesFromQuarterNoteValues(){this.timeSig.quarterNotesPerBar%1!=0&&Math.floor(this.barQuarterNote)+1>this.timeSig.quarterNotesPerBar?(this._barBeat.value=this.barQuarterNote,this._totalBeat.value=this.totalQuarterNote):(this._barBeat.value=this.timeSig.applySwing(this.barQuarterNote),this._totalBeat.value=this.totalQuarterNote-this.barQuarterNote+this.barBeat)}finish(){this._isFinished=!0,this._enabled.value=!1,this.finished.trigger(new N(this))}withRef(t){return this._ref=t,this}setSongPosition(t){this._timeSig.accept(),this._totalQuarterNote.value=t,this._totalQuarterNote.accept(),this._bar.value=Math.floor(t/this.timeSig.quarterNotesPerBar),this._bar.accept(),this._barQuarterNote.value=t-this.bar*this.timeSig.quarterNotesPerBar,this._barQuarterNote.accept(),this._updateBeatValuesFromQuarterNoteValues(),this._barBeat.accept(),this._totalBeat.accept(),this.positionChanged.trigger(new k(this))}get positionChanged(){return this._positionChanged}get started(){return this._started}get continued(){return this._continued}get stopped(){return this._stopped}}class ue extends Ct{constructor(t,e=null){super(),this._tempo=120,this._tempoMultiplier=1,this._timeSig=new b,this._totalQuarterNote=new b(0),this._totalBeat=new b(0),this._bar=new b(1),this._barQuarterNote=new b(0),this._barBeat=new b(0),this._enabled=new b(!0),this._isFinished=!1,this._finished=new B,this._positionChanged=new P,this._started=new P,this._continued=new P,this._stopped=new P,this.timeSig=e||it.commonTime(),this._timeSig.accept(),this.tempo=t}get tempo(){return this._tempo}set tempo(t){this._tempo=t}get tempoMultiplier(){return this._tempoMultiplier}set tempoMultiplier(t){if(t<=0)throw new Error("Invalid tempoMultiplier.");this._tempoMultiplier=t}get ref(){return this._ref}set ref(t){this._ref=t}get timeSig(){return this._timeSig.oldValue}set timeSig(t){this._timeSig.value=t}get totalQuarterNote(){return this._totalQuarterNote.value}get totalQuarterNoteTracker(){return this._totalQuarterNote}get totalBeat(){return this._totalBeat.value}get totalBeatTracker(){return this._totalBeat}get bar(){return this._bar.value}get barTracker(){return this._bar}get barQuarterNote(){return this._barQuarterNote.value}get barQuarterNoteTracker(){return this._barQuarterNote}get barBeat(){return this._barBeat.value}get barBeatTracker(){return this._barBeat}get enabled(){return this._enabled.value}set enabled(t){this._enabled.value!=t&&(this._enabled.value=t,t?this.continued.trigger(new k(this)):this.stopped.trigger(new k(this)))}get isFinished(){return this._isFinished}get finished(){return this._finished}atBarBeat(t){return super._atBarPosition(t,this._barBeat)}atBarQuarterNote(t){return super._atBarPosition(t,this._barQuarterNote)}atBarBeatMultiple(t){return super._atBarPositionMultiple(t,this._barBeat)}atBarQuarterNoteMultiple(t){return super._atBarPositionMultiple(t,this._barQuarterNote)}update(t){const e=t*(this.tempo/6e4)*this.tempoMultiplier;return this.updateFromQuarterNoteDelta(e)}updateFromQuarterNoteDelta(t){if(this._enabled.accept(),!this.enabled)return!1;this._totalQuarterNote.oldValue==0&&this.started.trigger(new k(this)),this._totalQuarterNote.accept(),this._totalQuarterNote.value+=t,this._barQuarterNote.accept(),this._barQuarterNote.value+=t,this._bar.accept();let e=0;for(;e=this.timeSig.quarterNotesPerBar,!(this.barQuarterNote<e);)this._barQuarterNote.value-=e,this._bar.value++,this._timeSig.accept();this._barBeat.accept(),this._totalBeat.accept(),this._barBeat.value=this.timeSig.quarterNoteToBeat(this.barQuarterNote),this._totalBeat.value=this.totalBeat-this._barBeat.oldValue+this.barBeat}finish(){this._isFinished=!0,this._enabled.value=!1,this.finished.trigger(new N(this))}withRef(t){return this._ref=t,this}setSongPosition(t){this._timeSig.accept(),this._totalQuarterNote.value=t,this._totalQuarterNote.accept(),this._bar.value=Math.floor(t/this.timeSig.quarterNotesPerBar),this._bar.accept(),this._barQuarterNote.value=t-this.bar*this.timeSig.quarterNotesPerBar,this._barQuarterNote.accept(),this._barBeat.value=this.timeSig.quarterNoteToBeat(this.barQuarterNote),this._barBeat.accept(),this._totalBeat.value=this.barBeat+this.bar*this.timeSig.beatsPerBar,this._totalBeat.accept(),this.positionChanged.trigger(new k(this))}get positionChanged(){return this._positionChanged}get started(){return this._started}get continued(){return this._continued}get stopped(){return this._stopped}}class ce{constructor(t){this._unmatched=[],this._matched=[null,null,null,null],this._isFinished=!1,this._finished=new B,this._updateProvider=t}get activeGamepads(){return this._matched.filter(t=>t!==null)}add(t){this._unmatched.push(t)}update(t){const e=this._updateProvider();for(let s=0;s<e.length&&s<4;s++)if(this._matched[s]==null&&e[s]!=null)for(let i=0;i<this._unmatched.length;i++){const n=this._unmatched[i];if(n.canMatch(e[s])){this._matched[s]=n,this._unmatched=this._unmatched.filter(r=>r!==n);break}}for(let s=0;s<4;s++){const i=this._matched[s];if(!i)continue;const n=e[s];if(n){for(let r=0;r<i.buttons.length&&r<n.buttons.length;r++){const a=i.buttons[r],u=n.buttons[r];a.valueTracker.value=u.value}for(let r=0;r<i.axes.length&&r<n.axes.length;r++){const a=i.axes[r],u=n.axes[r];a.valueTracker.value=u}i.update(t)}else this._matched[s]=null,this._unmatched.push(i)}}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}finish(){this._isFinished=!0,this.finished.trigger(new N(this))}withRef(t){return this._ref=t,this}}class le{constructor(t){this._buttons=[],this._isFinished=!1,this._finished=new B,this._escape=new o("escape"),this._f1=new o("f1"),this._f2=new o("f2"),this._f3=new o("f3"),this._f4=new o("f4"),this._f5=new o("f5"),this._f6=new o("f6"),this._f7=new o("f7"),this._f8=new o("f8"),this._f9=new o("f9"),this._f10=new o("f10"),this._f11=new o("f11"),this._f12=new o("f12"),this._backquote=new o("backquote"),this._numrow1=new o("numrow1"),this._numrow2=new o("numrow2"),this._numrow3=new o("numrow3"),this._numrow4=new o("numrow4"),this._numrow5=new o("numrow5"),this._numrow6=new o("numrow6"),this._numrow7=new o("numrow7"),this._numrow8=new o("numrow8"),this._numrow9=new o("numrow9"),this._numrow0=new o("numrow0"),this._minus=new o("minus"),this._equal=new o("equal"),this._backspace=new o("backspace"),this._tab=new o("tab"),this._q=new o("q"),this._w=new o("w"),this._e=new o("e"),this._r=new o("r"),this._t=new o("t"),this._y=new o("y"),this._u=new o("u"),this._i=new o("i"),this._o=new o("o"),this._p=new o("p"),this._leftBracket=new o("leftBracket"),this._rightBracket=new o("rightBracket"),this._enter=new o("enter"),this._capslock=new o("capslock"),this._a=new o("a"),this._s=new o("s"),this._d=new o("d"),this._f=new o("f"),this._g=new o("g"),this._h=new o("h"),this._j=new o("j"),this._k=new o("k"),this._l=new o("l"),this._semicolon=new o("semicolon"),this._quote=new o("quote"),this._backslash=new o("backslash"),this._leftShift=new o("leftShift"),this._intlBackslash=new o("intlBackslash"),this._z=new o("z"),this._x=new o("x"),this._c=new o("c"),this._v=new o("v"),this._b=new o("b"),this._n=new o("n"),this._m=new o("m"),this._comma=new o("comma"),this._period=new o("period"),this._slash=new o("slash"),this._rightShift=new o("rightShift"),this._leftCtrl=new o("leftCtrl"),this._leftAlt=new o("leftAlt"),this._space=new o("space"),this._rightAlt=new o("rightAlt"),this._rightCtrl=new o("rightCtrl"),this._insert=new o("insert"),this._home=new o("home"),this._pageUp=new o("pageUp"),this._delete=new o("delete"),this._end=new o("end"),this._pageDown=new o("pageDown"),this._up=new o("up"),this._left=new o("left"),this._down=new o("down"),this._right=new o("right"),this._numlock=new o("numlock"),this._numpadDivide=new o("numpadDivide"),this._numpadMultiply=new o("numpadMultiply"),this._numpadSubtract=new o("numpadSubtract"),this._numpad7=new o("numpad7"),this._numpad8=new o("numpad8"),this._numpad9=new o("numpad9"),this._numpadAdd=new o("numpadAdd"),this._numpad4=new o("numpad4"),this._numpad5=new o("numpad5"),this._numpad6=new o("numpad6"),this._numpad1=new o("numpad1"),this._numpad2=new o("numpad2"),this._numpad3=new o("numpad3"),this._numpadEnter=new o("numpadEnter"),this._numpad0=new o("numpad0"),this._numpadDecimal=new o("numpadDecimal"),this._activated=!1,this._onKeyDown=e=>{const s=this._getButtonByEventCode(e.code);s&&(s.valueTracker.value=1,s.update(0))},this._onKeyUp=e=>{const s=this._getButtonByEventCode(e.code);s&&(s.valueTracker.value=0,s.update(0))},this._eventSubscriber=t,this.buttons.push(this.f1,this.f2,this.f3,this.f4,this.f5,this.f6,this.f7,this.f8,this.f9,this.f10,this.f11,this.f12),this.buttons.push(this.backquote,this.numrow1,this.numrow2,this.numrow3,this.numrow4,this.numrow5,this.numrow6,this.numrow7,this.numrow8,this.numrow9,this.numrow0,this.minus,this.equal,this.backspace),this.buttons.push(this.tab,this.q,this.w,this.e,this.r,this.t,this.y,this.u,this.i,this.o,this.p,this.leftBracket,this.rightBracket,this.enter),this.buttons.push(this.capslock,this.a,this.s,this.d,this.f,this.g,this.h,this.j,this.k,this.l,this.semicolon,this.quote,this.backslash),this.buttons.push(this.leftShift,this.intlBackslash,this.z,this.x,this.c,this.v,this.b,this.n,this.m,this.comma,this.period,this.slash,this.rightShift),this.buttons.push(this.leftCtrl,this.leftAlt,this.space,this.rightAlt,this.rightCtrl),this.buttons.push(this.insert,this.home,this.pageUp,this.delete,this.end,this.pageDown),this.buttons.push(this.up,this.left,this.down,this.right),this.buttons.push(this.numlock,this.numpadDivide,this.numpadMultiply,this.numpadSubtract,this.numpad7,this.numpad8,this.numpad9,this.numpadAdd,this.numpad4,this.numpad5,this.numpad6,this.numpad1,this.numpad2,this.numpad3,this.numpadEnter,this.numpad0,this.numpadDecimal)}get buttons(){return this._buttons}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}get escape(){return this._escape}get f1(){return this._f1}get f2(){return this._f2}get f3(){return this._f3}get f4(){return this._f4}get f5(){return this._f5}get f6(){return this._f6}get f7(){return this._f7}get f8(){return this._f8}get f9(){return this._f9}get f10(){return this._f10}get f11(){return this._f11}get f12(){return this._f12}get backquote(){return this._backquote}get numrow1(){return this._numrow1}get numrow2(){return this._numrow2}get numrow3(){return this._numrow3}get numrow4(){return this._numrow4}get numrow5(){return this._numrow5}get numrow6(){return this._numrow6}get numrow7(){return this._numrow7}get numrow8(){return this._numrow8}get numrow9(){return this._numrow9}get numrow0(){return this._numrow0}get minus(){return this._minus}get equal(){return this._equal}get backspace(){return this._backspace}get tab(){return this._tab}get q(){return this._q}get w(){return this._w}get e(){return this._e}get r(){return this._r}get t(){return this._t}get y(){return this._y}get u(){return this._u}get i(){return this._i}get o(){return this._o}get p(){return this._p}get leftBracket(){return this._leftBracket}get rightBracket(){return this._rightBracket}get enter(){return this._enter}get capslock(){return this._capslock}get a(){return this._a}get s(){return this._s}get d(){return this._d}get f(){return this._f}get g(){return this._g}get h(){return this._h}get j(){return this._j}get k(){return this._k}get l(){return this._l}get semicolon(){return this._semicolon}get quote(){return this._quote}get backslash(){return this._backslash}get leftShift(){return this._leftShift}get intlBackslash(){return this._intlBackslash}get z(){return this._z}get x(){return this._x}get c(){return this._c}get v(){return this._v}get b(){return this._b}get n(){return this._n}get m(){return this._m}get comma(){return this._comma}get period(){return this._period}get slash(){return this._slash}get rightShift(){return this._rightShift}get leftCtrl(){return this._leftCtrl}get leftAlt(){return this._leftAlt}get space(){return this._space}get rightAlt(){return this._rightAlt}get rightCtrl(){return this._rightCtrl}get insert(){return this._insert}get home(){return this._home}get pageUp(){return this._pageUp}get delete(){return this._delete}get end(){return this._end}get pageDown(){return this._pageDown}get up(){return this._up}get left(){return this._left}get down(){return this._down}get right(){return this._right}get numlock(){return this._numlock}get numpadDivide(){return this._numpadDivide}get numpadMultiply(){return this._numpadMultiply}get numpadSubtract(){return this._numpadSubtract}get numpad7(){return this._numpad7}get numpad8(){return this._numpad8}get numpad9(){return this._numpad9}get numpadAdd(){return this._numpadAdd}get numpad4(){return this._numpad4}get numpad5(){return this._numpad5}get numpad6(){return this._numpad6}get numpad1(){return this._numpad1}get numpad2(){return this._numpad2}get numpad3(){return this._numpad3}get numpadEnter(){return this._numpadEnter}get numpad0(){return this._numpad0}get numpadDecimal(){return this._numpadDecimal}activate(){return!this._activated&&(this._eventSubscriber.subscribe("keydown",this._onKeyDown),this._eventSubscriber.subscribe("keyup",this._onKeyUp),this._activated=!0,!0)}deactivate(){return!!this._activated&&(this._eventSubscriber.unsubscribe("keydown",this._onKeyDown),this._eventSubscriber.unsubscribe("keyup",this._onKeyUp),this._activated=!1,!0)}finish(){this._isFinished=!0,this.deactivate(),this.finished.trigger(new N(this))}withRef(t){return this._ref=t,this}_getButtonByEventCode(t){switch(t){case"F1":return this.f1;case"F2":return this.f2;case"F3":return this.f3;case"F4":return this.f4;case"F5":return this.f5;case"F6":return this.f6;case"F7":return this.f7;case"F8":return this.f8;case"F9":return this.f9;case"F10":return this.f10;case"F11":return this.f11;case"F12":return this.f12;case"Backquote":return this.backquote;case"Digit1":return this.numrow1;case"Digit2":return this.numrow2;case"Digit3":return this.numrow3;case"Digit4":return this.numrow4;case"Digit5":return this.numrow5;case"Digit6":return this.numrow6;case"Digit7":return this.numrow7;case"Digit8":return this.numrow8;case"Digit9":return this.numrow9;case"Digit0":return this.numrow0;case"Minus":return this.minus;case"Equal":return this.equal;case"Backspace":return this.backspace;case"Tab":return this.tab;case"KeyQ":return this.q;case"KeyW":return this.w;case"KeyE":return this.e;case"KeyR":return this.r;case"KeyT":return this.t;case"KeyY":return this.y;case"KeyU":return this.u;case"KeyI":return this.i;case"KeyO":return this.o;case"KeyP":return this.p;case"BracketLeft":return this.leftBracket;case"BracketRight":return this.rightBracket;case"Enter":return this.enter;case"CapsLock":return this.capslock;case"KeyA":return this.a;case"KeyS":return this.s;case"KeyD":return this.d;case"KeyF":return this.f;case"KeyG":return this.g;case"KeyH":return this.h;case"KeyJ":return this.j;case"KeyK":return this.k;case"KeyL":return this.l;case"Semicolon":return this.semicolon;case"Quote":return this.quote;case"Backslash":return this.backslash;case"ShiftLeft":return this.leftShift;case"IntlBackslash":return this.intlBackslash;case"KeyZ":return this.z;case"KeyX":return this.x;case"KeyC":return this.c;case"KeyV":return this.v;case"KeyB":return this.b;case"KeyN":return this.n;case"KeyM":return this.m;case"Comma":return this.comma;case"Period":return this.period;case"Slash":return this.slash;case"ShiftRight":return this.rightShift;case"ControlLeft":return this.leftCtrl;case"AltLeft":return this.leftAlt;case"Space":return this.space;case"AltRight":return this.rightAlt;case"ControlRight":return this.rightCtrl;case"Insert":return this.insert;case"Home":return this.home;case"PageUp":return this.pageUp;case"Delete":return this.delete;case"End":return this.end;case"PageDown":return this.pageDown;case"ArrowUp":return this.up;case"ArrowLeft":return this.left;case"ArrowDown":return this.down;case"ArrowRight":return this.right;case"NumLock":return this.numlock;case"NumpadDivide":return this.numpadDivide;case"NumpadMultiply":return this.numpadMultiply;case"NumpadSubtract":return this.numpadSubtract;case"Numpad7":return this.numpad7;case"Numpad8":return this.numpad8;case"Numpad9":return this.numpad9;case"NumpadAdd":return this.numpadAdd;case"Numpad4":return this.numpad4;case"Numpad5":return this.numpad5;case"Numpad6":return this.numpad6;case"Numpad1":return this.numpad1;case"Numpad2":return this.numpad2;case"Numpad3":return this.numpad3;case"NumpadEnter":return this.numpadEnter;case"Numpad0":return this.numpad0;case"NumpadDecimal":return this.numpadDecimal}return null}update(t){for(const e of this.buttons)e.update(t)}}var de=function(h,t,e,s){return new(e||(e=Promise))(function(i,n){function r(c){try{u(s.next(c))}catch(l){n(l)}}function a(c){try{u(s.throw(c))}catch(l){n(l)}}function u(c){var l;c.done?i(c.value):(l=c.value,l instanceof e?l:new e(function(_){_(l)})).then(r,a)}u((s=s.apply(h,t||[])).next())})};class kt extends k{constructor(t,e){super(t),this._port=e}get port(){return this._port}}class Pt extends P{}class lt{constructor(t){this._onBaseAccessStateChange=e=>{this.portChanged.trigger(new kt(this,e))},this._portChanged=new Pt,this._baseAccess=t,this._baseAccess.onstatechange=this._onBaseAccessStateChange}static request(){return de(this,void 0,void 0,function*(){const t=yield navigator.requestMIDIAccess();return new lt(t)})}get portChanged(){return this._portChanged}detach(){this._baseAccess&&(this._baseAccess.onstatechange=void 0,this._baseAccess=null)}getOutPort(t){let e=null;return this._baseAccess.outputs.forEach(s=>{s.name===t&&(e=s)}),e}getInPort(t){let e=null;return this._baseAccess.inputs.forEach(s=>{s.name===t&&(e=s)}),e}getOutPortNames(){const t=[];return this._baseAccess.outputs.forEach(e=>t.push(e.name)),t}getInPortNames(){const t=[];return this._baseAccess.inputs.forEach(e=>t.push(e.name)),t}}class p extends k{constructor(t,e){super(t),this._message=e}get message(){return this._message}}class f extends P{}class pe{constructor(t){this._noteOff=new f,this._noteOn=new f,this._notePressure=new f,this._controlChange=new f,this._programChange=new f,this._channelPressure=new f,this._pitchBend=new f,this._tick=new f,this._songPosition=new f,this._start=new f,this._continue=new f,this._stop=new f,this._previousStatus=null,this.port=t}get port(){return this._port}set port(t){this._port&&(this._port.onmidimessage=void 0),this._port=t,this._port&&(this._port.onmidimessage=e=>this._receiveMessage(e))}get noteOff(){return this._noteOff}get noteOn(){return this._noteOn}get notePressure(){return this._notePressure}get controlChange(){return this._controlChange}get programChange(){return this._programChange}get channelPressure(){return this._channelPressure}get pitchBend(){return this._pitchBend}get tick(){return this._tick}get songPosition(){return this._songPosition}get start(){return this._start}get continue(){return this._continue}get stop(){return this._stop}_receiveMessage(t){this.receiveData(t.data)}receiveData(t){if(t.length==0)return;if(t.length==1&&t[0]==248)return void this.tick.trigger(new p(this,new z));if(t[0]>=128)this._previousStatus=t[0];else{if(!this._previousStatus)return;t.unshift(this._previousStatus)}const e=16*Math.floor(t[0]/16),s=t[0]-e;e==128?this.noteOff.trigger(new p(this,new T(t[1],t[2],s))):e==144?this.noteOn.trigger(new p(this,new O(t[1],t[2],s))):e==160?this.notePressure.trigger(new p(this,new A(t[1],t[2],s))):e==176?this.controlChange.trigger(new p(this,new F(t[1],t[2],s))):e==192?this.programChange.trigger(new p(this,new G(t[1],s))):e==208?this.channelPressure.trigger(new p(this,new Y(t[1],s))):e==224?this.pitchBend.trigger(new p(this,new R(R.calculatePercent(t[1],t[2]),s))):e==240&&(s==2&&t.length==1?this.start.trigger(new p(this,new $)):s==2&&t.length==3?this.songPosition.trigger(new p(this,new X(128*t[2]+t[1]))):s==3&&t.length==1?this.continue.trigger(new p(this,new W)):s==4&&t.length==1&&this.stop.trigger(new p(this,new H)))}}class _e{constructor(){this._noteOff=new f,this._noteOn=new f,this._notePressure=new f,this._controlChange=new f,this._programChange=new f,this._channelPressure=new f,this._pitchBend=new f,this._tick=new f,this._songPosition=new f,this._start=new f,this._continue=new f,this._stop=new f,this._previousStatus=null,this._notes=[],this._isFinished=!1,this._finished=new B}get noteOff(){return this._noteOff}get noteOn(){return this._noteOn}get notePressure(){return this._notePressure}get controlChange(){return this._controlChange}get programChange(){return this._programChange}get channelPressure(){return this._channelPressure}get pitchBend(){return this._pitchBend}get tick(){return this._tick}get songPosition(){return this._songPosition}get start(){return this._start}get continue(){return this._continue}get stop(){return this._stop}receiveData(t){if(t.length==0)return;if(t.length==1&&t[0]==248)return void this.tick.trigger(new p(this,new z));if(t[0]>=128)this._previousStatus=t[0];else{if(!this._previousStatus)return;t.unshift(this._previousStatus)}const e=16*Math.floor(t[0]/16),s=t[0]-e;e==128?this.noteOff.trigger(new p(this,new T(t[1],t[2],s))):e==144?this.noteOn.trigger(new p(this,new O(t[1],t[2],s))):e==160?this.notePressure.trigger(new p(this,new A(t[1],t[2],s))):e==176?this.controlChange.trigger(new p(this,new F(t[1],t[2],s))):e==192?this.programChange.trigger(new p(this,new G(t[1],s))):e==208?this.channelPressure.trigger(new p(this,new Y(t[1],s))):e==224?this.pitchBend.trigger(new p(this,new R(R.calculatePercent(t[1],t[2]),s))):e==240&&(s==2&&t.length==1?this.start.trigger(new p(this,new $)):s==2&&t.length==3?this.songPosition.trigger(new p(this,new X(128*t[2]+t[1]))):s==3&&t.length==1?this.continue.trigger(new p(this,new W)):s==4&&t.length==1&&this.stop.trigger(new p(this,new H)))}get notes(){return this._notes}addNote(t){return this._notes.push(t),t}stopNotes(t){for(const e of this._notes)t&&!t(e)||e.stop()}sendMessage(t){t instanceof T?this.noteOff.trigger(new p(this,t)):t instanceof O?this.noteOn.trigger(new p(this,t)):t instanceof A?this.notePressure.trigger(new p(this,t)):t instanceof F?this.controlChange.trigger(new p(this,t)):t instanceof G?this.programChange.trigger(new p(this,t)):t instanceof Y?this.channelPressure.trigger(new p(this,t)):t instanceof R?this.pitchBend.trigger(new p(this,t)):t instanceof z?this.tick.trigger(new p(this,t)):t instanceof X?this.songPosition.trigger(new p(this,t)):t instanceof $?this.start.trigger(new p(this,t)):t instanceof W?this.continue.trigger(new p(this,t)):t instanceof H&&this.stop.trigger(new p(this,t))}sendRawData(t){if(!t||t.length===0)throw new Error("No data specified to send");this.receiveData(t)}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}finish(){this._isFinished=!0,this.stopNotes(t=>!0),this.finished.trigger(new N(this))}withRef(t){return this._ref=t,this}update(t){let e=!1;for(let s=0;s<this._notes.length;s++){const i=this._notes[s];if(!i.on){if(i.onTracker.isDirty){let n=!0;for(let r=s+1;r<this.notes.length;r++){const a=this.notes[r];if(i.pitch===a.pitch&&i.channel===a.channel&&a.on&&!a.onTracker.isDirty){n=!1;break}}n&&this.sendMessage(new T(i.pitch,i.velocity,i.channel)),i.onTracker.accept()}e=!0}}for(const s of this._notes)s.on&&(s.onTracker.isDirty?(this.sendMessage(new O(s.pitch,s.velocity,s.channel)),s.onTracker.accept(),s.velocityTracker.accept()):s.velocityTracker.isDirty&&(this.sendMessage(new A(s.pitch,s.velocity,s.channel)),s.velocityTracker.accept()));e&&(this._notes=this._notes.filter(s=>s.on))}}class ge{constructor(t){this._notes=[],this._isFinished=!1,this._finished=new B,this.suppressPortValidationErrors=!1,this.port=t}get notes(){return this._notes}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}finish(){this._isFinished=!0,this.stopNotes(t=>!0),this.finished.trigger(new N(this))}withRef(t){return this._ref=t,this}addNote(t){return this._notes.push(t),t.on&&(this.sendMessage(new O(t.pitch,t.velocity,t.channel)),t.onTracker.accept()),t}stopNotes(t){for(const e of this._notes)t&&!t(e)||e.stop()}sendMessage(t){return!!this.validatePort()&&(this.port.send(t.toArray()),!0)}sendRawData(t){if(!this.validatePort())return!1;if(!t||t.length===0)throw new Error("No data specified to send");return this.port.send(t),!0}validatePort(){if(!this.port){if(this.suppressPortValidationErrors)return!1;throw new Error("MidiOut has no port connected")}return!0}update(t){let e=!1;for(let s=0;s<this._notes.length;s++){const i=this._notes[s];if(!i.on){if(i.onTracker.isDirty){let n=!0;for(let r=s+1;r<this.notes.length;r++){const a=this.notes[r];if(i.pitch===a.pitch&&i.channel===a.channel&&a.on&&!a.onTracker.isDirty){n=!1;break}}n&&this.sendMessage(new T(i.pitch,i.velocity,i.channel)),i.onTracker.accept()}e=!0}}for(const s of this._notes)s.on&&(s.onTracker.isDirty?(this.sendMessage(new O(s.pitch,s.velocity,s.channel)),s.onTracker.accept(),s.velocityTracker.accept()):s.velocityTracker.isDirty&&(this.sendMessage(new A(s.pitch,s.velocity,s.channel)),s.velocityTracker.accept()));e&&(this._notes=this._notes.filter(s=>s.on))}}class Nt extends k{constructor(t){super(t)}}class Bt extends P{}class Q{constructor(t){this._activeMs=0,this.changed=new Bt,this.valueTracker=new b(0),this._name=t}get value(){return this.valueTracker.value}get name(){return this._name}get activeMs(){return this._activeMs}update(t){this.value!=0&&(this._activeMs+=t),this.valueTracker.isDirty&&this.changed.trigger(new Nt(this)),this.value==0&&(this._activeMs=0),this.valueTracker.accept()}}class fe{constructor(t,e){for(let s=0;s<t.length;s++){for(let i=s+1;i<t.length;i++)if(t[s]==t[i])throw new Error(`The button name '${t[s]}' is repeated.`);for(let i=0;i<e.length;i++)if(t[s]==e[i])throw new Error(`The button name '${t[s]}' cannot also be used for an axis.`)}for(let s=0;s<e.length;s++)for(let i=s+1;i<e.length;i++)if(e[s]==e[i])throw new Error(`The axis name '${e[s]}' is repeated.`);this._buttons=t.map(s=>new o(s)),this._axes=e.map(s=>new Q(s));for(const s of this.buttons){if(this[s.name]!=null)throw new Error(`Cannot use'${s.name}' as a button name.`);this[s.name]=s}for(const s of this.axes){if(this[s.name]!=null)throw new Error(`Cannot use'${s.name}' as an axis name.`);this[s.name]=s}}get buttons(){return this._buttons}get axes(){return this._axes}update(t){for(const e of this.buttons)e.update(t);for(const e of this.axes)e.update(t)}canMatch(t){return t.buttons.length==this.buttons.length&&t.axes.length==this.axes.length}}class me{constructor(){this._l1=new o("L1"),this._l2=new o("L2"),this._r1=new o("R1"),this._r2=new o("R2"),this._x=new o("x"),this._square=new o("square"),this._circle=new o("circle"),this._triangle=new o("triangle"),this._up=new o("up"),this._left=new o("left"),this._right=new o("right"),this._down=new o("down"),this._share=new o("share"),this._options=new o("options"),this._l3=new o("L3"),this._l3_x=new Q("L3_X"),this._l3_y=new Q("L3_Y"),this._l3_magnitude=new Q("L3_magnitude"),this._l3_rotation=new Q("L3_rotation"),this._r3=new o("R3"),this._r3_x=new Q("R3_X"),this._r3_y=new Q("R3_Y"),this._r3_magnitude=new Q("R3_magnitude"),this._r3_rotation=new Q("R3_rotation"),this._ps=new o("PS"),this._touchpad=new o("touchpad"),this._buttons=[this.x,this.circle,this.square,this.triangle,this.L1,this.R1,this.L2,this.R2,this.share,this.options,this.L3,this.R3,this.up,this.down,this.left,this.right,this.PS,this.touchpad],this._axes=[this.L3_X,this.L3_Y,this.R3_X,this.R3_Y]}get buttons(){return this._buttons}get axes(){return this._axes}get L1(){return this._l1}get L2(){return this._l2}get R1(){return this._r1}get R2(){return this._r2}get x(){return this._x}get square(){return this._square}get circle(){return this._circle}get triangle(){return this._triangle}get up(){return this._up}get left(){return this._left}get right(){return this._right}get down(){return this._down}get share(){return this._share}get options(){return this._options}get L3(){return this._l3}get L3_X(){return this._l3_x}get L3_Y(){return this._l3_y}get L3_magnitude(){return this._l3_magnitude}get L3_rotation(){return this._l3_rotation}get R3(){return this._r3}get R3_X(){return this._r3_x}get R3_Y(){return this._r3_y}get R3_magnitude(){return this._r3_magnitude}get R3_rotation(){return this._r3_rotation}get PS(){return this._ps}get touchpad(){return this._touchpad}update(t){for(const e of this.buttons)e.update(t);for(const e of this.axes)e.update(t);this.L3_magnitude.valueTracker.value=Math.min(1,Math.sqrt(Math.pow(this.L3_X.value,2)+Math.pow(this.L3_Y.value,2))),this.L3_magnitude.update(t),this.R3_magnitude.valueTracker.value=Math.min(1,Math.sqrt(Math.pow(this.R3_X.value,2)+Math.pow(this.R3_Y.value,2))),this.R3_magnitude.update(t),this.L3_X.value==0&&this.L3_Y.value==0?this.L3_rotation.valueTracker.value=0:this.L3_rotation.valueTracker.value=180*Math.atan2(this.L3_X.value,-this.L3_Y.value)/Math.PI,this.L3_rotation.update(t),this.R3_X.value==0&&this.R3_Y.value==0?this.R3_rotation.valueTracker.value=0:this.R3_rotation.valueTracker.value=180*Math.atan2(this.R3_X.value,-this.R3_Y.value)/Math.PI,this.R3_rotation.update(t)}canMatch(t){return t.buttons.length==this.buttons.length&&t.axes.length==this.axes.length}}class dt{constructor(t){this._isFinished=!1,this._finished=new B,this._action=t}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}get action(){return this._action}update(t){}finish(){this._isFinished=!0,this.finished.trigger(new N(this))}withRef(t){return this._ref=t,this}}class St{constructor(t){this._ms=t}get ms(){return this._ms}}class we extends dt{constructor(t,e){super(e),this._countPassed=0,this._condition=t}get condition(){return this._condition}update(t){this._countPassed+=t,this.condition()?this.finish():this.action(new St(this._countPassed))}}class It extends St{constructor(t,e){super(t),this._percent=e}get percent(){return this._percent}}class ve extends dt{constructor(t,e){super(e),this._countPassed=0,this._msCount=t}get msCount(){return this._msCount}update(t){this._countPassed+=t,this._countPassed>=this.msCount?this.finish():this.action(new It(this._countPassed,this._countPassed/this.msCount))}}class be extends It{constructor(t,e,s){super(t,s),this._beat=e}get beat(){return this._beat}}class Me extends dt{constructor(t,e,s){super(s),this._beatsPassed=0,this._msPassed=0,this._metronome=t,this._beatCount=e}get metronome(){return this._metronome}get beatCount(){return this._beatCount}update(t){this._msPassed+=t,this._beatsPassed+=this.metronome.totalBeatTracker.value-this.metronome.totalBeatTracker.oldValue,this._beatsPassed>=this.beatCount?this.finish():this.action(new be(this._msPassed,this._beatsPassed,this._beatsPassed/this.beatCount))}}class ye{static until(t,e){return new we(t,e)}static forMs(t,e){return new ve(t,e)}static forBeats(t,e,s){return new Me(t,e,s)}}class Ce{constructor(t,e,s){this.pitch=t,this.letter=e,this.accidental=s}toString(){if(this.accidental==null)return this.letter;if(this.accidental==0)return this.letter+"‚ôÆ";let t=this.letter;return Math.abs(this.accidental)>=2&&(t+=(this.accidental>0?"ùÑ™":"ùÑ´").repeat(Math.abs(this.accidental/2))),Math.abs(this.accidental)%2==1&&(t+=this.accidental>0?"‚ôØ":"‚ô≠"),t}}class Z{constructor(t,e){let s=typeof e=="string"?w(e):e;s=g(s,12),this._pitches=t.shape.map(i=>(s+i)%12),this._template=t,this._generatePitchNames(),this.name=this.getPitchName(this.root)+" "+t.name}get name(){return this._name}set name(t){this._name=t}get pitches(){return this._pitches}get template(){return this._template}get length(){return this.pitches.length}get root(){return this.pitches[0]}contains(t){return typeof t=="string"&&(t=w(t)),t=g(t,12),this.pitches.find(e=>e==t)!=null}indexOf(t){typeof t=="string"&&(t=w(t)),t=g(t,12);for(let e=0;e<this.pitches.length;e++)if(this.pitches[e]==t)return e;return-1}degreeOf(t){let e=this.indexOf(t);return e>=0&&e++,e}getPitchName(t,e=!1){typeof t=="string"&&(t=w(t));let s=this._pitchNames[g(t,12)].toString();return e&&(s+=Math.floor(t/12)-1),s}degree(t,e=-1){t=Math.round(t-1);let s=Math.floor(t/this.length);t-=s*this.length;const i=this.pitches[g(t,this.length)];return i<this.root&&s++,i+12*s+12*(e+1)}degreeInOctave(t,e=-1){return this.pitches[g(t-1,this.pitches.length)]+12*(e+1)}pitchesInRange(t,e){if(typeof t=="string"&&(t=w(t)),typeof e=="string"&&(e=w(e)),t>e)return this.pitchesInRange(e,t);let s=[];const i=this.pitches.slice().sort((n,r)=>q(n,r,a=>a));for(let n=12*Math.floor(t/12);;n+=12){for(const r of i){const a=r+n;a>=t&&a<=e&&s.push(a)}if(n>e)break}return s}fitPitch(t,e){typeof t=="string"&&(t=w(t));let s=1;(e=new mt(e)).preferredDirection=="DOWN"?s=-1:e.preferredDirection=="RANDOM"&&(s=Math.random()>=.5?1:-1);let i=t,n=t;for(t%1!=0&&(i=s>0?Math.ceil(t):Math.floor(t),n=s>0?Math.floor(t):Math.ceil(t));;){const r=Math.abs(i-t)<=e.maxMovement,a=Math.abs(n-t)<=e.maxMovement;if(!r&&!a)break;if(e.preferRoot){if(r&&g(i,12)==this.root)return i;if(a&&g(n,12)==this.root)return n}const u=r&&this.contains(i),c=a&&this.contains(n);if(u||c)return u&&c?Math.abs(i-t)<=Math.abs(n-t)?i:n:u?i:n;i+=s,n-=s}return Math.round(t)}_generatePitchNames(){var t,e;const s=g(this.root-this.template.relativityToMajor,12),i=[0,7,2,9,4,11].find(_=>_==s)!=null?1:-1,n=(_,C,I)=>new Ce(_,C,I),r=[[n(0,"B",1),n(0,"C",0),n(0,"D",-2)],[n(1,"B",2),n(1,"C",1),n(1,"D",-1)],[n(2,"C",2),n(2,"D",0),n(2,"E",-2)],[n(3,"D",1),n(3,"E",-1),n(3,"F",-2)],[n(4,"D",2),n(4,"E",0),n(4,"F",-2)],[n(5,"E",1),n(5,"F",0),n(5,"G",-2)],[n(6,"E",2),n(6,"F",1),n(6,"G",-1)],[n(7,"F",2),n(7,"G",0),n(7,"A",-2)],[n(8,"G",1),n(8,"A",-1)],[n(9,"G",2),n(9,"A",0),n(9,"B",-2)],[n(10,"A",1),n(10,"B",-1),n(10,"C",-2)],[n(11,"A",2),n(11,"B",0),n(11,"C",-1)]],a=[null,-1,1,-1,1,null,null,null,-1,1,-1,1],u=[];let c=this.pitches.slice();for(const _ of c){let C=r[_];const I=C.find(E=>E.accidental==0&&this._notInUsedNames(E,u));if(I){u.push(n(_,I.letter));continue}const tt=(t=a[g(_-this.root,12)])!==null&&t!==void 0?t:i;let x=C.filter(E=>this._matchesPreference(E,tt)&&this._notInUsedNames(E,u));x.length==0&&(x=C.filter(E=>this._notInUsedNames(E,u)),x.length==0&&(x=C.filter(E=>this._matchesPreference(E,tt)))),u.push(x.sort((E,_t)=>q(E,_t,Ie=>Math.abs(Ie.accidental)))[0])}const l=[...Array(12).keys()].filter(_=>c.find(C=>_==C)==null);for(const _ of l){let C=r[_];const I=C.find(x=>x.accidental==0);if(I){u.push(I);continue}const tt=(e=a[g(_-this.root,12)])!==null&&e!==void 0?e:i;u.push(C.filter(x=>this._matchesPreference(x,tt)).sort((x,E)=>q(x,E,_t=>Math.abs(_t.accidental)))[0])}this._pitchNames=u.sort((_,C)=>q(_,C,I=>I.pitch))}_notInUsedNames(t,e){return!e.find(s=>s.letter==t.letter)}_matchesPreference(t,e){return t.accidental*e>=0}getDominantScale(){return new Z(this.template,this.root+7)}getSubdominantScale(){return new Z(this.template,this.root+5)}getRelativeScale(t){return t==this.template?this:new Z(t,this.root-this.template.relativityToMajor+t.relativityToMajor)}getParallelScale(t){return t==this.template?this:new Z(t,this.root)}}class d{constructor(t,e,s){if(this._shape=[],this._relativityToMajor=0,e.length==0)throw new Error("Invalid scale template, shape cannot be empty");if(e.find(i=>i<=0||i>=12)!=null)throw new Error("Invalid scale template shape, must contain unique numbers only between 0 - 11");(e=e.sort((i,n)=>i-n))[0]!=0&&e.unshift(0);for(let i=0;i+1<e.length;i++)if(e[i]==e[i+1])throw new Error("Invalid scale template, no duplicate numbers allowed in the shape");this.name=t,this._shape=e,this.relativityToMajor=s}get name(){return this._name}set name(t){this._name=t}get shape(){return this._shape}get relativityToMajor(){return this._relativityToMajor}set relativityToMajor(t){this._relativityToMajor=t}create(t){return new Z(this,t)}static get major(){return d._major}static get ionian(){return d._major}static get dorian(){return d._dorian}static get phrygian(){return d._phrygian}static get lydian(){return d._lydian}static get mixolydian(){return d._mixolydian}static get naturalMinor(){return d._naturalMinor}static get aeolian(){return d._naturalMinor}static get harmonicMinor(){return d._harmonicMinor}static get melodicMinor(){return d._melodicMinor}static get locrian(){return d._locrian}static get majorPentatonic(){return d._majorPentatonic}static get minorPentatonic(){return d._minorPentatonic}static get wholeTone(){return d._wholeTone}static get diminished(){return d._diminished}}d._major=new d("Major",[2,4,5,7,9,11],0),d._dorian=new d("Dorian",[2,3,5,7,9,10],2),d._phrygian=new d("Phrygian",[1,3,5,7,8,10],4),d._lydian=new d("Lydian",[2,4,6,7,9,11],5),d._mixolydian=new d("Mixolydian",[2,4,5,7,9,10],-5),d._naturalMinor=new d("Natural Minor",[2,3,5,7,8,10],-3),d._harmonicMinor=new d("Harmonic Minor",[2,3,5,7,8,11],-3),d._melodicMinor=new d("Melodic Minor",[2,3,5,7,9,11],-3),d._locrian=new d("Locrian",[1,3,5,6,8,10],-1),d._majorPentatonic=new d("Major Pentatonic",[2,4,7,9],0),d._minorPentatonic=new d("Minor Pentatonic",[3,5,8,10],-3),d._wholeTone=new d("Whole Tone",[2,4,6,8,10],0),d._diminished=new d("Diminished",[2,3,5,6,8,9,11],-3);class ke{constructor(t,e,s=24){this._newTicksReceived=0,this._onMidiTick=()=>{this._newTicksReceived++},this._onSongPosition=i=>{const n=6*i.message.value/this.ticksPerQuarterNote;this.metronome.setSongPosition(n)},this._isFinished=!1,this._finished=new B,this.midiIn=t,this.metronome=e,this.ticksPerQuarterNote=s}get midiIn(){return this._midiIn}set midiIn(t){if(!t)throw new Error("midiIn cannot be set to null");t!==this._midiIn&&(this._midiIn&&(this._midiIn.tick.remove(e=>e.logic==this._onMidiTick),this._midiIn.songPosition.remove(e=>e.logic==this._onSongPosition)),this._midiIn=t,this._midiIn.tick.add(this._onMidiTick),this._midiIn.songPosition.add(this._onSongPosition))}get metronome(){return this._metronome}set metronome(t){if(!t)throw new Error("metronome cannot be set to null");this._metronome=t}get ticksPerQuarterNote(){return this._ticksPerQuarterNote}set ticksPerQuarterNote(t){if(t<=0)throw new Error("ticksPerQuarterNote must be greater than 0");this._ticksPerQuarterNote=t}get newTicksReceived(){return this._newTicksReceived}get ref(){return this._ref}set ref(t){this._ref=t}withRef(t){return this._ref=t,this}get isFinished(){return this._isFinished}get finished(){return this._finished}finish(){this._isFinished=!0,this.midiIn.tick.remove(t=>t.logic==this._onMidiTick),this.midiIn.songPosition.remove(t=>t.logic==this._onSongPosition),this.finished.trigger(new N(this))}update(t){const e=this.newTicksReceived,s=e/this.ticksPerQuarterNote;this.metronome.updateFromQuarterNoteDelta(s),this._newTicksReceived-=e}}class Pe{constructor(t,e,s=24){this._onPositionChanged=()=>{this.midiOut.sendMessage(new X(this.ticksPerQuarterNote*this.metronome.totalQuarterNote/6))},this._onStarted=()=>{this.midiOut.sendMessage(new $)},this._onContinued=()=>{this.midiOut.sendMessage(new W)},this._onStopped=()=>{this.midiOut.sendMessage(new H)},this._isFinished=!1,this._finished=new B,this.metronome=t,this.midiOut=e,this.ticksPerQuarterNote=s}get metronome(){return this._metronome}set metronome(t){if(!t)throw new Error("metronome cannot be set to null");t!==this._metronome&&(this._metronome&&this._unsubscribeFromMetronomeEvents(),this._metronome=t,this._subscribeToMetronomeEvents())}get midiOut(){return this._midiOut}set midiOut(t){if(!t)throw new Error("midiOut cannot be set to null");this._midiOut=t}get ticksPerQuarterNote(){return this._ticksPerQuarterNote}set ticksPerQuarterNote(t){if(t<=0)throw new Error("ticksPerQuarterNote must be greater than 0");this._ticksPerQuarterNote=t}_unsubscribeFromMetronomeEvents(){this._metronome.positionChanged.remove(t=>t.logic==this._onPositionChanged),this._metronome.started.remove(t=>t.logic==this._onStarted),this._metronome.continued.remove(t=>t.logic==this._onContinued),this._metronome.stopped.remove(t=>t.logic==this._onStopped)}_subscribeToMetronomeEvents(){this._metronome.positionChanged.add(this._onPositionChanged),this._metronome.started.add(this._onStarted),this._metronome.continued.add(this._onContinued),this._metronome.stopped.add(this._onStopped)}get ref(){return this._ref}set ref(t){this._ref=t}withRef(t){return this._ref=t,this}get isFinished(){return this._isFinished}get finished(){return this._finished}finish(){this._isFinished=!0,this.finished.trigger(new N(this))}update(t){const e=this.metronome.totalQuarterNoteTracker.oldValue,s=this.metronome.totalQuarterNoteTracker.value,i=1/this.ticksPerQuarterNote;let n=Math.floor(e)+Math.floor(e%1/i)*i;for(;n+=i,!(n>=s);)this.midiOut.sendMessage(new z)}}class Ne{constructor(t,e){this._isPolyphonic=!1,this._pitchBendPercent=0,this.onControlChange=null,this._target=t,this._parent=e,this.controlValues=Array(128).fill(0),t.name!="Sampler"&&t.name!="PolySynth"||(this._isPolyphonic=!0)}get target(){return this._target}get isPolyphonic(){return this._isPolyphonic}get parent(){return this._parent}onNoteStart(t){this.target.name=="NoiseSynth"?this.target.triggerAttack(this.parent.toneJS.now(),t.velocity/127):this.target.triggerAttack(ot(t.pitch),this.parent.toneJS.now(),t.velocity/127)}onNoteStop(t){this._isPolyphonic?this.target.triggerRelease(ot(t.pitch),this.parent.toneJS.now()):this.target.triggerRelease(this.parent.toneJS.now())}onPitchBend(t){if(this._isPolyphonic)return!1;const e=t.percent-this._pitchBendPercent;this._pitchBendPercent=t.percent;const s=this.target.frequency.value*Math.pow(2,2*e/12);return this.target.frequency.value=s,!0}}class Be{constructor(t){if(this._channels=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this._notes=[],!t)throw new Error("toneJS reference cannot be falsy");this._toneJS=t}get channels(){return this._channels}get toneJS(){return this._toneJS}setChannel(t,e){if(t<0||t>15)throw new Error("Channel must be numbered 0 - 15");this._channels[t]=e?new Ne(e,this):null}get notes(){return this._notes}addNote(t){const e=this._channels[t.channel];if(e)return this._notes.push(t),t.on&&(e.onNoteStart(t),t.onTracker.accept()),t}update(t){let e=!1;for(let s=0;s<this._notes.length;s++){const i=this._notes[s];if(!i.on){if(i.onTracker.isDirty){let n=!0;const r=this._channels[i.channel];if(r)for(let a=s+1;a<this.notes.length;a++){const u=this.notes[a];if(i.channel==u.channel&&u.on&&!u.onTracker.isDirty&&(!r.isPolyphonic||i.pitch==u.pitch)){n=!1;break}}n&&r.onNoteStop(i),i.onTracker.accept()}e=!0}}e&&(this._notes=this._notes.filter(s=>s.on))}stopNotes(t){for(const e of this._notes)t&&!t(e)||e.stop()}sendMessage(t){if(t instanceof T)return this.stopNotes(e=>e.pitch==t.pitch&&e.channel==t.channel),!0;if(t instanceof O)return!!this.addNote(new et(t.pitch,t.velocity,t.channel));if(t instanceof F){const e=this._channels[t.channel];if(e){if(t.controller<0||t.controller>127)throw new Error("CC control must be between 0 & 127");if(t.value<0||t.value>127)throw new Error("CC value must be between 0 & 127");return e.controlValues[t.controller]=t.value,e.onControlChange&&e.onControlChange(t,e.target),!0}}else if(t instanceof R){const e=this._channels[t.channel];if(e)return e.onPitchBend(t)}return!1}sendRawData(t){if(t.length==0)return;const e=16*Math.floor(t[0]/16),s=t[0]-e;return e==128?this.sendMessage(new T(t[1],t[2],s)):e==144?this.sendMessage(new O(t[1],t[2],s)):e==176&&this.sendMessage(new F(t[1],t[2],s))}}class pt{constructor(t,e,s=.1){this.audioContext=t,this.type=e,this._gainNode=t.createGain(),this._gainNode.gain.value=s,this._gainNode.connect(this.audioContext.destination)}get gain(){return this._gainNode.gain.value}set gain(t){this._gainNode.gain.value=t}createOscillator(t){const e=this.audioContext.createOscillator();return e.type=this.type,e.connect(this._gainNode),e.frequency.value=t,e.start(),e}}class Se{constructor(t){this._channels=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this._notes=[],this._previousStatus=null,this._isFinished=!1,this._finished=new B,this._audioContext=t}get audioContext(){return this._audioContext}withChannel(t,e,s=.1){return this._channels[t]=new pt(this._audioContext,e,s),this}withDefaultChannels(){const t=["sine","square","sawtooth","triangle"];for(let e=0;e<16;e++)this._channels[e]||(this._channels[e]=new pt(this.audioContext,t[e%4]));return this}get notes(){return this._notes}addNote(t){return this._notes.push(t),t.on&&(this._createOscillator(t),t.onTracker.accept()),t}stopNotes(t){for(const e of this._notes)t&&!t(e)||(e.oscillator.stop(),delete e.oscillator,e.stop());this._notes=this._notes.filter(e=>e.on)}sendMessage(t){if(t instanceof T)this.stopNotes(e=>e.pitch==t.pitch&&e.channel==t.channel);else if(t instanceof O){const e=new et(t.pitch,t.velocity,t.channel);this.addNote(e)}}sendRawData(t){if(t.length==0||t[0]==248)return;if(t[0]>=128)this._previousStatus=t[0];else{if(!this._previousStatus)return;t.unshift(this._previousStatus)}const e=16*Math.floor(t[0]/16),s=t[0]-e;e==128?this.sendMessage(new T(t[1],t[2],s)):e==144?this.sendMessage(new O(t[1],t[2],s)):e==160?this.sendMessage(new A(t[1],t[2],s)):e==176?this.sendMessage(new F(t[1],t[2],s)):e==192?this.sendMessage(new G(t[1],s)):e==208?this.sendMessage(new Y(t[1],s)):e==224&&this.sendMessage(new R(R.calculatePercent(t[1],t[2]),s))}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}update(t){let e=!1;for(let s=0;s<this._notes.length;s++){const i=this._notes[s];i.on||(i.onTracker.isDirty&&(i.oscillator.stop(),delete i.oscillator,i.onTracker.accept()),e=!0)}e&&(this._notes=this._notes.filter(s=>s.on))}finish(){this.stopNotes(t=>!0),this._isFinished=!0,this.finished.trigger(new N(this))}withRef(t){return this._ref=t,this}_createOscillator(t){const e=this._channels[t.channel];t.oscillator=e.createOscillator(ot(t.pitch))}}return D})())})(Ot);var Qe=Ot.exports;export{Qe as d,De as e,Re as n,Fe as t};
//# sourceMappingURL=index-88dafb31.js.map
