import{u as Qe,f as Ae}from"./lit-element-b97bcfb0.js";import{c as Le}from"./_commonjsHelpers-725317a4.js";/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const Ue=O=>(E,P)=>{P!==void 0?P.addInitializer(()=>{customElements.define(O,E)}):customElements.define(O,E)};/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const qe={attribute:!0,type:String,converter:Qe,reflect:!1,hasChanged:Ae},We=(O=qe,E,P)=>{const{kind:x,metadata:q}=P;let y=globalThis.litPropertyMetadata.get(q);if(y===void 0&&globalThis.litPropertyMetadata.set(q,y=new Map),y.set(P.name,O),x==="accessor"){const{name:M}=P;return{set(W){const p=E.get.call(this);E.set.call(this,W),this.requestUpdate(M,p,O)},init(W){return W!==void 0&&this.C(M,void 0,O),W}}}if(x==="setter"){const{name:M}=P;return function(W){const p=this[M];E.call(this,W),this.requestUpdate(M,p,O)}}throw Error("Unsupported decorator location: "+x)};function Ve(O){return(E,P)=>typeof P=="object"?We(O,E,P):((x,q,y)=>{const M=q.hasOwnProperty(y);return q.constructor.createProperty(y,M?{...x,wrapped:!0}:x),M?Object.getOwnPropertyDescriptor(q,y):void 0})(O,E,P)}/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */function Je(O){return Ve({...O,state:!0,attribute:!1})}var At={exports:{}};(function(O,E){(function(P,x){O.exports=x()})(Le,()=>(()=>{var P={d:(h,t)=>{for(var e in t)P.o(t,e)&&!P.o(h,e)&&Object.defineProperty(h,e,{enumerable:!0,get:t[e]})},o:(h,t)=>Object.prototype.hasOwnProperty.call(h,t),r:h=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(h,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(h,"__esModule",{value:!0})}},x={};P.r(x),P.d(x,{Arpeggiator:()=>Lt,Arpeggio:()=>qt,ArpeggioNote:()=>Nt,ButtonEvent:()=>ct,ButtonEventData:()=>ut,ButtonInput:()=>u,ChannelPressureMessage:()=>Z,Chord:()=>j,ChordFinder:()=>jt,ChordProgression:()=>Kt,ChordProgressionChord:()=>It,ChordProgressionPlayer:()=>Gt,Clip:()=>ht,ClipBend:()=>H,ClipCC:()=>z,ClipNote:()=>Y,ClipPlayer:()=>ae,ClipRecorder:()=>oe,ClipRecorderEvent:()=>Ot,ClipRecorderEventData:()=>St,Clock:()=>p,ClockChildFinishedEvent:()=>I,ClockChildFinishedEventData:()=>B,ContinueMessage:()=>st,ControlChangeMessage:()=>J,Cue:()=>de,Drums:()=>ge,EventSubscriber:()=>pe,Flexinome:()=>me,Gamepads:()=>fe,Keyboard:()=>we,Metronome:()=>_e,MidiAccess:()=>ft,MidiAccessPortEvent:()=>Et,MidiAccessPortEventData:()=>xt,MidiBus:()=>Me,MidiIn:()=>ve,MidiInEvent:()=>w,MidiInEventData:()=>_,MidiMessageBase:()=>K,MidiOut:()=>ye,MiscController:()=>Ce,Note:()=>nt,NoteOffMessage:()=>A,NoteOnMessage:()=>D,NotePressureMessage:()=>U,PS4Controller:()=>ke,PitchBendMessage:()=>F,PitchFitter:()=>Ne,ProgramChangeMessage:()=>$,PropertyTracker:()=>N,Repeat:()=>Oe,Scale:()=>G,ScaleTemplate:()=>g,SliderEvent:()=>Dt,SliderEventData:()=>Rt,SliderInput:()=>Q,SongPositionMessage:()=>et,StartMessage:()=>it,StopMessage:()=>rt,TickMessage:()=>tt,TickReceiver:()=>xe,TickSender:()=>Ee,TimeSig:()=>at,TimeSigDivision:()=>mt,ToneJSMidiOut:()=>De,Tween:()=>k,WebAudioMidiOut:()=>Fe,WebAudioMidiOutChannel:()=>bt,pitch:()=>C});class q{constructor(t,e=5){if(this._useWebWorker=!0,this._running=!1,this._webWorker=null,this._timer=null,!t)throw new Error("ClockUpdateSource must take a callback function");this._msPerTick=e,this._callback=t}get useWebWorker(){return this._useWebWorker}get msPerTick(){return this._msPerTick}get callback(){return this._callback}get running(){return this._running}start(){return!this.running&&(this._running=!0,this._startRunning(),!0)}stop(){return!!this.running&&(this._running=!1,this._stopRunning(),!0)}_startRunning(){if(this.useWebWorker)try{this._startWebWorker()}catch{this._useWebWorker=!1,this._startRunning()}else this._setInterval()}_startWebWorker(){const t=new Blob([`
            let timeoutTime = ${this.msPerTick};
            
            function tick() {
                setTimeout(tick, timeoutTime);
                self.postMessage('tick');
            }
            tick();
            `],{type:"text/javascript"}),e=URL.createObjectURL(t),i=new Worker(e);i.onmessage=this.callback,this._webWorker=i}_setInterval(){this._timer=setInterval(this.callback,this.msPerTick)}_stopRunning(){this._timer&&clearTimeout(this._timer),this._webWorker&&(this._webWorker.terminate(),this._webWorker.onmessage=null)}}class y{constructor(t){this.cancel=!1,this.source=t}}class M{constructor(){this._handlers=[]}get handlers(){return this._handlers}add(t){if(!t)throw new Error("Invalid handler value");if(typeof t=="function"){const e=new W(t);return this.handlers.push(e),e}return this.handlers.push(t),t}remove(t){this._handlers=this._handlers.filter(e=>!t(e))}trigger(t){for(const e of this.handlers){if(t!=null&&t.cancel)break;e.on&&e.logic(t)}}}class W{constructor(t,e){this._on=!0,this._logic=t,this.ref=e}get logic(){return this._logic}get ref(){return this._ref}set ref(t){this._ref=t}get on(){return this._on}set on(t){this._on=t}withRef(t){return this.ref=t,this}}class p{constructor(t=5){this._children=[],this._updateSource=null,this._onUpdateSourceTick=()=>this.updateChildren(),this._updateSource=new q(this._onUpdateSourceTick,t)}get typeName(){return"shimi.Clock"}get msPerTick(){return this._updateSource.msPerTick}get children(){return this._children}get running(){return this._updateSource.running}start(){return!!this._updateSource.start()&&(this._lastUpdateTime=new Date().getTime(),!0)}stop(){return!!this._updateSource.stop()&&(this._lastUpdateTime=null,!0)}addChild(t){return this._children.push(t),t}stopChildren(t){for(const e of this._children)t(e)&&e.finish()}updateChildren(){const t=new Date().getTime(),e=t-this._lastUpdateTime;this._lastUpdateTime=t;for(const i of this._children)i.isFinished||i.update(e);this._children=this._children.filter(i=>!i.isFinished)}}p.default=null;class B extends y{constructor(t){super(t)}}class I extends M{}class N{constructor(t){this.value=t,this.oldValue=t}get isDirty(){return this.value!==this.oldValue}accept(){this.oldValue=this.value}undo(){this.value=this.oldValue}}class Lt{constructor(t,e,i){this._channel=0,this._speed=1,this._beatTracker=new N(0),this._running=!0,this._isFinished=!1,this._finished=new I,this._notes=[],this.arpeggio=t,this.metronome=e,this.midiOut=i,p.default&&p.default.addChild(this)}get typeName(){return"shimi.Arpeggiator"}get arpeggio(){return this._arpeggio}set arpeggio(t){this._arpeggio=t}get chord(){return this._chord}set chord(t){this._chord=t,this._endAllNotes()}get channel(){return this._channel}set channel(t){this._channel=t}get ref(){return this._ref}set ref(t){this._ref=t}get metronome(){return this._metronome}set metronome(t){this._metronome=t}get midiOut(){return this._midiOut}set midiOut(t){this._midiOut=t}get speed(){return this._speed}set speed(t){this._speed=t}get beat(){return this._beatTracker.value}set beat(t){this._beatTracker.value=t}get beatTracker(){return this._beatTracker}get running(){return this._running}set running(t){this._running=t}get noteModifier(){return this._noteModifier}set noteModifier(t){this._noteModifier=t}get isFinished(){return this._isFinished}get finished(){return this._finished}update(t){if(!(this.running&&this.arpeggio&&this.metronome&&this.midiOut))return;const e=(this.metronome.totalBeat-this.metronome.totalBeatTracker.oldValue)*this.speed;if(e==0)return;this.beatTracker.accept(),this.beatTracker.value=(this.beatTracker.value+e)%this.arpeggio.duration;const i=this.beatTracker.oldValue,s=this.beatTracker.value;i>s&&this._endAllNotes();for(const r of this._notes){const n=r.arpNote;!n.contains(s)||s<i?r.stop():typeof n.velocity!="number"&&(r.velocity=n.velocity.update((s-n.start)/n.duration))}if(this._notes=this._notes.filter(r=>r.on),this.chord)for(const r of this.arpeggio.getNotesStartingInRange(i,s)){const n=r.createNote(this.chord,this.channel,(s-r.start)/r.duration);n&&(n.arpNote=r,this.noteModifier&&this.noteModifier(n),this._notes.push(n),this.midiOut.addNote(n))}}finish(){this._isFinished=!0,this._endAllNotes(),this.finished.trigger(new B(this))}withRef(t){return this._ref=t,this}_endAllNotes(){for(const t of this._notes)t.stop();this._notes=[]}}class V{constructor(t,e){this.start=t,this.duration=e}get start(){return this._start}set start(t){this._start=t}get duration(){return this._duration}set duration(t){if(t<0)throw new Error("Cannot set duration to negative value");this._duration=t}get end(){return this._start+this._duration}set end(t){this.duration=t-this._start}getPercent(t){return this.duration==0?0:(t-this.start)/this.duration}contains(t){return t>=this.start&&t<=this.end}}function m(h,t){return(h%t+t)%t}function R(h,t,e){const i=e(h),s=e(t);return i<s?-1:i>s?1:0}function C(h){const t=lt(h);let e=-1;if(t.parseEndIndex<h.length&&(e=Number(h.substring(t.parseEndIndex))),Number.isNaN(e))throw new Error(h+" is not a valid pitch name");return t.pitch+12*(e+1)}function lt(h){let t={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[h[0]];if(t==null)throw new Error(h+" is not a valid pitch name");let e=1;for(;e<h.length;e++){const i=h[e];if(i!="‚ôÆ")if(i=="b"||i=="‚ô≠")t--;else if(i=="#"||i=="‚ôØ")t++;else if(i=="x")t+=2;else if(i=="ùÑ™"[0]&&h.length>e+1&&h[e+1]=="ùÑ™"[1])t+=2,e++;else{if(!(i=="ùÑ´"[0]&&h.length>e+1&&h[e+1]=="ùÑ´"[1]))break;t-=2,e++}}return{pitch:m(t,12),parseEndIndex:e}}function Ct(h,t){if(!t)throw Error("scale must be provided");if(t.length!=7)throw Error("scale provided must have length 7");let e=0,i=0;for(;e<h.length;e++){const l=h[e];if(l=="b"||l=="‚ô≠")i-=1;else{if(l!="#"&&l!="‚ôØ")break;i+=1}}if(e>1)throw Error("Expected at most one accidental symbol");let s=e;const r=["i","I","v","V"];for(;e<h.length;e++){const l=h[e];if(!r.includes(l))break}let n=h.substring(s,e),o=!0;if(n==n.toLowerCase())o=!1;else if(n!=n.toUpperCase())throw Error("Invalid mixed casing of roman numerals");n=n.toUpperCase();let a=0;switch(n){case"I":a=1;break;case"II":a=2;break;case"III":a=3;break;case"IV":a=4;break;case"V":a=5;break;case"VI":a=6;break;case"VII":a=7;break;default:throw Error("Unrecognised roman numerals")}let c=t.getPitchByDegree(a)+i;switch(a){case 1:c=Math.max(t.root,Math.min(c,t.root+1));break;case 2:c=Math.max(t.root+1,Math.min(c,t.root+2));break;case 3:c=Math.max(t.root+3,Math.min(c,t.root+4));break;case 4:c=Math.max(t.root+5,Math.min(c,t.root+6));break;case 5:c=Math.max(t.root+6,Math.min(c,t.root+8));break;case 6:c=Math.max(t.root+8,Math.min(c,t.root+9));break;case 7:c=Math.max(t.root+10,Math.min(c,t.root+11))}return{pitch:c,isMajor:o,parseEndIndex:e}}function dt(h){return typeof h=="string"&&(h=C(h)),440*Math.pow(2,(h-69)/12)}class nt{constructor(t,e,i,s){this._pitch=typeof t=="string"?C(t):t,this.velocityTracker=new N(Math.round(e)),this.onTracker=new N(!1),this.on=!0,this._channel=i,this.ref=s}get typeName(){return"shimi.Note"}get pitch(){return this._pitch}set pitch(t){this._pitch=t}get velocity(){return this.velocityTracker.value}set velocity(t){this.velocityTracker.value=Math.round(t)}get on(){return this.onTracker.value}set on(t){this.onTracker.value=t}get channel(){return this._channel}set channel(t){this._channel=t}start(){return!this.on&&(this.on=!0,!0)}stop(){return!!this.on&&(this.on=!1,!0)}}class Nt extends V{constructor(t,e,i,s,r=null){super(t,e),this._channel=null,this.pitch=i,this.velocity=s,this.channel=r}get typeName(){return"shimi.ArpeggioNote"}get pitch(){return this._pitch}set pitch(t){this._pitch=t}get velocity(){return this._velocity}set velocity(t){this._velocity=t}get channel(){return this._channel}set channel(t){this._channel=t}createNote(t,e,i){var s;if(!t)return null;const r=this.pitch(t);return r==null||r<0||r>127?null:new nt(r,typeof this.velocity=="number"?this.velocity:this.velocity.update(i),(s=this.channel)!==null&&s!==void 0?s:e)}}class qt extends V{constructor(t){super(0,t),this.notes=[]}get typeName(){return"shimi.Arpeggio"}addNote(t,e,i,s,r=null){typeof t=="number"&&(t=[t]);for(const n of t)this.notes.push(new Nt(n,e,i,s,r));return this}getNotesStartingInRange(t,e){return t<=e?this.notes.filter(i=>i.start>=t&&i.start<e):this.notes.filter(i=>i.start>=t||i.start<e)}getNotesEndingInRange(t,e){return t<=e?this.notes.filter(i=>i.end>=t&&i.end<e):this.notes.filter(i=>i.end>=t||i.end<e)}}class ut extends y{constructor(t){super(t)}}class ct extends M{}class u{constructor(t){this._activeMs=0,this.pressed=new ct,this.released=new ct,this.changed=new ct,this.valueTracker=new N(0),this._name=t}get typeName(){return"shimi.ButtonInput"}get value(){return this.valueTracker.value}get isPressed(){return this.valueTracker.value!=0}get name(){return this._name}get activeMs(){return this._activeMs}update(t){this.isPressed&&(this._activeMs+=t),this.valueTracker.isDirty&&(this.isPressed?this.valueTracker.oldValue==0?this.pressed.trigger(new ut(this)):this.changed.trigger(new ut(this)):(this.released.trigger(new ut(this)),this._activeMs=0)),this.valueTracker.accept()}}class kt{constructor(t){this.maxMovement=2,this.preferRoot=!0,this.preferredDirection="DOWN",this.precision="TIGHT",this.scale=null,t&&Object.assign(this,t)}}class j{constructor(){this._pitches=[],this._root=null,this._name=null}get typeName(){return"shimi.Chord"}get pitches(){return this._pitches}get root(){return this._root}set root(t){this.setRoot(t)}get bass(){return Math.min(...this._pitches)}get name(){return this._name==null&&j.nameGenerator!=null&&(this._name=j.nameGenerator(this)),this._name}addPitch(t){if(typeof t=="string"&&(t=C(t)),!this._pitches.find(e=>e==t)){this._name=null;for(let e=0;e<this._pitches.length;e++)if(this._pitches[e]>t)return this._pitches.splice(e,0,t),this;this._pitches.push(t)}return this}addPitches(t){for(const e of t)this.addPitch(e);return this}removePitches(t){const e=this._pitches.length;return this._pitches=this._pitches.filter(i=>!t(i)),this._pitches.length<e&&(this._name=null),this.root&&!this._pitches.find(i=>i==this.root)&&(this.root=null),this}setRoot(t){return typeof t=="string"&&(t=C(t)),this._root!=t&&(t==null||t==null?this._root=null:(this._root=t,this.addPitch(t)),this._name=null),this}getPitchByIndex(t){t=Math.round(t);const e=Math.floor(t/this.pitches.length);return t-=e*this.pitches.length,this.pitches[t]+12*e}getPitchByDegree(t,e){var i,s,r,n,o,a,c,l,d,f;if(this.root==null)throw Error("Cannot call getPitchByDegree without root being set");if((t=Math.round(t))==1)return this.root;const b=(v,X)=>{var ot,vt,Mt;return(Mt=(vt=(ot=this.pitches.find(yt=>yt==v))!==null&&ot!==void 0?ot:this.pitches.find(yt=>yt==X))!==null&&vt!==void 0?vt:this.contains(v)?v:null)!==null&&Mt!==void 0?Mt:this.contains(X)?X:null};if(t==2){let v=b(this.root+2,this.root+1);if(v==null){if(this.getPitchByDegree(3,e)==this.root+4)return this.root+2;v=(i=e==null?void 0:e.fitPitch(this.root+2,{preferredDirection:"DOWN",maxMovement:1}))!==null&&i!==void 0?i:this.root+2}return v}if(t==3)return(r=(s=b(this.root+4,this.root+3))!==null&&s!==void 0?s:e==null?void 0:e.fitPitch(this.root+4,{preferredDirection:"DOWN",maxMovement:1}))!==null&&r!==void 0?r:this.root+4;if(t==4)return this.getPitchByDegree(5,e)==this.root+6?this.root+5:(o=(n=b(this.root+5,this.root+6))!==null&&n!==void 0?n:e==null?void 0:e.fitPitch(this.root+5,{preferredDirection:"UP",maxMovement:1}))!==null&&o!==void 0?o:this.root+5;if(t==5)return(c=(a=b(this.root+7,this.root+6))!==null&&a!==void 0?a:e==null?void 0:e.fitPitch(this.root+7,{preferredDirection:"DOWN",maxMovement:1}))!==null&&c!==void 0?c:this.root+7;if(t==6){let v=b(this.root+9,this.root+8);if(v==null){if(this.getPitchByDegree(7,e)-this.getPitchByDegree(5,e)==4)return this.getPitchByDegree(5,e)+2;v=(l=e==null?void 0:e.fitPitch(this.root+9,{preferredDirection:"DOWN",maxMovement:1}))!==null&&l!==void 0?l:this.root+9}return v}if(t==7)return(f=(d=b(this.root+10,this.root+11))!==null&&d!==void 0?d:e==null?void 0:e.fitPitch(this.root+10,{preferredDirection:"UP",maxMovement:1}))!==null&&f!==void 0?f:this.root+10;const L=Math.floor((t-1)/7),S=new j;return S._pitches=this._pitches.slice(),S.setRoot(this.root+12*L),S.getPitchByDegree(t-7*L,e)}contains(t){return typeof t=="string"&&(t=C(t)),t=m(t,12),this.pitches.find(e=>m(e,12)==t)!=null}transpose(t){this.root!=null&&(this.root=this.root+t);for(let e=0;e<this.pitches.length;e++)this.pitches[e]=this.pitches[e]+t;this._name=null}duplicate(){const t=new j;return t._pitches=this.pitches.slice(),t._root=this.root,t._name=this.name,t}addDegrees(t,e=null){if(this.root==null)throw new Error("You cannot add degrees to the chord before its root has been set");for(let i of t){let s=!1;i<0&&(s=!0,i=Math.abs(i)),i--;let r=this.root;i>=7&&(r+=12*Math.floor(i/7));let n={main:0,fallback:0};switch(i%7){case 1:n={main:2,fallback:1};break;case 2:n={main:4,fallback:3};break;case 3:n={main:5,fallback:6};break;case 4:n={main:7,fallback:6};break;case 5:n={main:9,fallback:8};break;case 6:n={main:11,fallback:10}}s?r+=n.fallback:e==null||e.contains(r+n.main)||!e.contains(r+n.fallback)?r+=n.main:r+=n.fallback,this.addPitch(r)}return this}near(t,e=!1){typeof t=="string"&&(t=C(t));const i=this.pitches.reduce((r,n)=>r+n,0)/this.pitches.length;let s=Math.round((t-i)/6);if(s%2==1&&(s=s<0?s+1:s-1),s/=2,s!=0)for(let r=0;r<this.pitches.length;r++)this.pitches[r]+=12*s;if(e){for(let r=0;r<this.pitches.length;r++)t-this.pitches[r]>6?this.pitches[r]+=12:this.pitches[r]-t>6&&(this.pitches[r]-=12);this._pitches=this.pitches.sort((r,n)=>R(r,n,o=>o))}return this}fitPitch(t,e){typeof t=="string"&&(t=C(t));const i=new kt(e);let s=a=>this._isTightFit(a,i);i.precision=="MEDIUM"&&(s=a=>this._isMediumFit(a,i)),i.precision=="LOOSE"&&(s=a=>this._isLooseFit(a,i));let r=1;i.preferredDirection=="DOWN"?r=-1:i.preferredDirection=="RANDOM"&&(r=Math.random()>=.5?1:-1);let n=t,o=t;for(t%1!=0&&(n=r>0?Math.ceil(t):Math.floor(t),o=r>0?Math.floor(t):Math.ceil(t));;){const a=Math.abs(n-t)<=i.maxMovement,c=Math.abs(o-t)<=i.maxMovement;if(!a&&!c)break;const l=a?s(n):0,d=c?s(o):0;if(l+d>0){if(l>d)return n;if(d>l)return o;if(i.preferRoot){if(a&&m(n,12)==m(this.root,12))return n;if(c&&m(o,12)==m(this.root,12))return o}return Math.abs(n-t)<=Math.abs(o-t)?n:o}n+=r,o-=r}return Math.round(t)}_isTightFit(t,e){return this.contains(t)?1:0}_isMediumFit(t,e){if(this.contains(t))return 1;const i=e.scale;return i&&!i.contains(t)||this.contains(t+1)||this.contains(t-1)?0:.5}_isLooseFit(t,e){if(this.contains(t))return 1;const i=e.scale;return i?i.contains(t)?.5:0:.5}}function gt(h,t){t||(t=i=>Number(i));let e=0;for(const i of h)e+=t(i);return e}function Pt(h){const t=[];for(let e=0;e<h.length;e++)h.indexOf(h[e])==e&&t.push(h[e]);return t}function Wt(h,t){if(!h||h.length==0)return null;let e=[];for(const i of h){const s=t(i),r=e.find(n=>n.value===s);return r?r.count++:e.push({value:s,count:1}),e.sort((n,o)=>R(n,o,a=>a.count)),e.pop().value}}j.nameGenerator=null;class Vt{constructor(t,e,i,s,r,n){this.shapeName="",this.name="",this.inverseName="",this.pitchMap=0,this.preference=0,this.intervals=[],this.root=0,this.shapeName=t,this.name=i,this.inverseName=s,this.pitchMap=this._getPitchMap(n,e),this.preference=r,this.intervals=e,this.root=n}_getPitchMap(t,e){const i=Pt(e.map(r=>m(t+r,12)));let s=0;for(let r of i)s+=Math.pow(2,r);return s}}class Bt{constructor(){this.shapeName="",this.name="",this.root=0,this.bass=0,this.pitches=[],this.pitchesAdded=[],this.pitchesRemoved=[]}}class jt{constructor(){this.lookupData=[]}get typeName(){return"shimi.ChordFinder"}addChordLookup(t,e,i,s,r){if(!e||e.length==0)throw new Error("No intervals specified in chord lookup");if(e.find(n=>n==0)==null)throw new Error("Chord lookup intervals parameter must contain 0");if(this.lookupData.find(n=>n.shapeName==t))throw new Error("Attempted to add duplicate chord lookup");for(let n=0;n<12;n++)this.lookupData.push(new Vt(t,e,i,s,r,n));return this}removeChordLookup(t){return this.lookupData=this.lookupData.filter(e=>e.shapeName!=t),this}replaceChordLookup(t,e,i,s,r){return this.removeChordLookup(t),this.addChordLookup(t,e,i,s,r),this}withDefaultChordLookups(){return this.addChordLookup("M",[0,4,7],"{r}","{r}/{b}",10),this.addChordLookup("m",[0,3,7],"{r}m","{r}m/{b}",9),this.addChordLookup("M7",[0,4,7,11],"{r}M7","{r}M7/{b}",8),this.addChordLookup("7",[0,4,7,10],"{r}7","{r}7/{b}",8),this.addChordLookup("m7",[0,3,7,10],"{r}m7","{r}m7/{b}",8),this.addChordLookup("dim",[0,3,6],"{r}dim","{r}dim/{b}",7),this.addChordLookup("aug",[0,4,8],"{r}aug","{r}aug/{b}",7),this.addChordLookup("5",[0,7],"{r}5","{r}5",6),this.addChordLookup("sus2",[0,2,7],"{r}sus2","{r}sus2/{b}",6),this.addChordLookup("sus4",[0,5,7],"{r}sus4","{r}sus4/{b}",6),this.addChordLookup("dim7",[0,3,6,9],"{r}dim7","{r}dim7/{b}",5),this.addChordLookup("m7‚ô≠5",[0,3,6,10],"{r}m7‚ô≠5","{r}m7‚ô≠5/{b}",5),this.addChordLookup("M9",[0,4,7,11,14],"{r}M9","{r}M9/{b}",4),this.addChordLookup("9",[0,4,7,10,14],"{r}9","{r}9/{b}",4),this.addChordLookup("m9",[0,3,7,10,14],"{r}m9","{r}m9/{b}",4),this.addChordLookup("add9",[0,4,7,14],"{r}add9","{r}add9/{b}",4),this.addChordLookup("madd9",[0,3,7,14],"{r}madd9","{r}madd9/{b}",4),this.addChordLookup("M11",[0,4,7,11,14,17],"{r}M11","{r}M11/{b}",3),this.addChordLookup("11",[0,4,7,10,14,17],"{r}11","{r}11/{b}",3),this.addChordLookup("m11",[0,3,7,10,14,17],"{r}m11","{r}m11/{b}",3),this.addChordLookup("add11",[0,4,7,17],"{r}add11","{r}add11/{b}",3),this.addChordLookup("madd11",[0,3,7,17],"{r}madd11","{r}madd11/{b}",3),this.addChordLookup("mM7",[0,3,7,11],"{r}mM7","{r}mM7/{b}",2),this.addChordLookup("7‚ôØ5",[0,4,8,10],"{r}7‚ôØ5","{r}7‚ôØ5/{b}",2),this.addChordLookup("7‚ôØ9",[0,4,7,10,15],"{r}7‚ôØ9","{r}7‚ôØ9/{b}",2),this}findChord(t,e=null,i=null,s=null){if(t.length==0)return null;if(e!=null&&t.find(l=>l==e)==null)throw new Error("The root is not contained in the passed in pitches");t.length==1&&e==null&&(e=t[0]);const r=this._getAllPotentialChords(t,e,i,s),n=this._getPitchMap(t);let o=null;for(const l of r){const d=this._getPitchMapDistance(l.pitchMap,n);(o==null||d<o.distance||d==o.distance&&l.preference>o.chord.preference)&&(o={distance:d,chord:l})}if(o==null)return null;const a=new Bt;a.shapeName=o.chord.shapeName;const c=[];for(const l of t)if((o.chord.pitchMap|Math.pow(2,m(l,12)))==o.chord.pitchMap){a.pitches.push(l);for(let d of o.chord.intervals)if(m(o.chord.root+d,12)==m(l,12)){c.push({interval:d,pitch:l});break}}else a.pitchesRemoved.push(l);for(const l of o.chord.intervals)if(!a.pitches.find(d=>m(d,12)==m(o.chord.root+l,12))){const d=[];for(const b of c){const L=l-b.interval;d.push(b.pitch+L)}const f=Wt(d,b=>b);a.pitches.push(f),a.pitchesAdded.push(f)}return a.pitches.sort((l,d)=>R(l,d,f=>f)),a.bass=a.pitches[0],a.root=a.pitches.find(l=>m(l,12)==m(o.chord.root,12)),a.name=a.bass==a.root?o.chord.name:o.chord.inverseName,a}_getAllPotentialChords(t,e=null,i=null,s=null){const r=this._getPitchMap(t);let n=this.lookupData;return e!=null&&(e=m(e,12),n=n.filter(o=>o.root==e)),i!=null&&(n=n.filter(o=>i.find(a=>a==o.shapeName))),s!=null&&(n=n.filter(o=>{const a=this._getPitchMap(s.pitches);return((o.pitchMap|r)-r|a)-a==0})),n}_getPitchMap(t){const e=Pt(t.map(s=>m(s,12)));let i=0;for(let s of e)i+=Math.pow(2,s);return i}_getPitchMapDistance(t,e){let i=t^e,s=0;for(;i!=0;)i&=i-1,s++;return s}findChordByName(t,e){let i=0,s="",r=null;try{const n=lt(t);i=n.pitch,s=t.substring(n.parseEndIndex)}catch(n){if(!e)throw n;{const o=Ct(t,e);i=o.pitch,s=t.substring(o.parseEndIndex),r=o.isMajor,r||s.startsWith("m")||(s="m"+s),t=e.getPitchName(i)+s}}for(const n of this.lookupData.filter(o=>o.root==i)){if(r!=null){if(r&&!n.intervals.includes(4)||!r&&!n.intervals.includes(3))continue}else if(s.length>0&&!s.startsWith(n.shapeName))continue;const o=this._tryLookupMatchToChordName(n,t,e);if(o)return o}return null}_tryLookupMatchToChordName(t,e,i){const s=new Bt;s.shapeName=t.shapeName;let r=this._getRegexStringFromLookupDataName(t.name),n=new RegExp(r).exec(e);if(n)s.name=t.name;else{if(r=this._getRegexStringFromLookupDataName(t.inverseName),n=new RegExp(r).exec(e),!n)return null;s.name=t.inverseName}if(s.root=C(n.groups.r)+12,n.groups.b!=null?s.bass=function(o,a){try{const c=lt(o);return{pitch:c.pitch,isMajor:null,parseEndIndex:c.parseEndIndex}}catch{return Ct(o,a)}}(n.groups.b,i).pitch:s.bass=s.root,s.pitches=t.intervals.map(o=>o+s.root),s.bass!=s.root){const o=s.pitches.findIndex(a=>a%12==s.bass);o<0?s.pitches.push(s.bass):s.pitches[o]=s.bass}return s.pitches=s.pitches.sort((o,a)=>R(o,a,c=>c)),s}_getRegexStringFromLookupDataName(t){let e=t;for(;;){const i=e.indexOf("{"),s=e.indexOf("}");if(i<0&&s<0)break;if(i<0!=s<0||s<i)throw new Error(`'${t}' contains unmatched braces`);const r=e.slice(i+1,s);e=e.slice(0,i)+`(?<${r}>(?:[A-G](?:‚ôÆ|b|#|‚ô≠|‚ôØ|x|ùÑ™|ùÑ´)*)|(?:(?:b|#|‚ô≠|‚ôØ)?(?:i|I|v|V)+))`+e.slice(s+1)}return"^"+e+"$"}newChord(t,e){const i=this.findChordByName(t,e);return i==null?null:new j().addPitches(i.pitches).setRoot(i.root)}}class It extends V{constructor(t,e,i){super(t,e),this._chord=i}get typeName(){return"shimi.ChordProgressionChord"}get chord(){return this._chord}set chord(t){this._chord=t}}class Kt extends V{constructor(t){super(0,t),this.chords=[]}get typeName(){return"shimi.ChordProgression"}addChord(t,e,i){const s=new It(t,e,i);let r=!1;for(const n of this.chords)if(n.start>=s.start&&n.end<=s.end)n.duration=0,r=!0;else if(n.end>s.start&&n.end<s.end)n.end=s.start;else if(n.start<s.end&&n.start>s.start){const o=n.end;n.start=s.end,n.end=o}return r&&this.removeChords(n=>n.duration==0),this.chords.push(s),this}removeChords(t){this.chords=this.chords.filter(e=>!t(e))}getChordsInRange(t,e){const i=[];for(const s of this.chords)t<=e?Math.max(t,s.start)<Math.min(e,s.end)&&i.push(s):(s.start<e||s.end>t)&&i.push(s);return i}getChordAt(t){return t=m(t,this.duration),this.chords.find(e=>e.start<=t&&e.end>t)}}class Ut extends y{constructor(t,e){super(t),this._chord=e}get chord(){return this._chord}}class Jt extends M{}class Gt{constructor(t,e){this._speed=1,this._startBeat=0,this._beatCount=null,this._beatsPassed=0,this._isFinished=!1,this._finished=new I,this._chordChanged=new Jt,this.chordProgression=t,this.metronome=e,p.default&&p.default.addChild(this)}get typeName(){return"shimi.ChordProgressionPlayer"}get chordProgression(){return this._chordProgression}set chordProgression(t){this._chordProgression!==t&&(this._chordProgression=t)}get metronome(){return this._metronome}set metronome(t){this._metronome=t}get speed(){return this._speed}set speed(t){this._speed=t}get startBeat(){return this._startBeat}set startBeat(t){this._startBeat=t}get beatCount(){return this._beatCount}set beatCount(t){this._beatCount=t}get beatsPassed(){return this._beatsPassed}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}get currentChord(){return this._currentChord}get chordChanged(){return this._chordChanged}update(t){const e=(this.metronome.totalBeat-this.metronome.totalBeatTracker.oldValue)*this.speed;if(e==0)return;const i=this.beatsPassed+e,s=(this.startBeat+i)%this.chordProgression.duration;if(this._beatsPassed+=e,typeof this.beatCount=="number"&&this.beatsPassed>=this.beatCount)return void this.finish();const r=this.chordProgression.getChordAt(s);r!==this.currentChord&&(this._currentChord=r,this.chordChanged.trigger(new Ut(this,r==null?void 0:r.chord)))}finish(){this._isFinished=!0,this.finished.trigger(new B(this))}withRef(t){return this._ref=t,this}}class T{constructor(t,e){this._from=t,this._to=e}get typeName(){return"shimi.LinearTween"}get from(){return this._from}get to(){return this._to}update(t){return this.from+this.tweenEquation(t)*(this.to-this.from)}tweenEquation(t){return t}then(t,e=1){return new pt(this).then(t,e)}toJSON(){return{type:"Linear",from:this.from,to:this.to}}}class pt{constructor(t,e=1){this._children=[],this._children.push({tween:t,weight:e})}get typeName(){return"shimi.MultiTween"}get from(){return this._children[0].tween.from}get to(){return this._children[this._children.length-1].tween.to}update(t){const e=gt(this._children,s=>s.weight)*t;let i=0;for(const s of this._children){if(i<=e&&i+s.weight>=e){const r=(e-i)/s.weight;return s.tween.update(r)}i+=s.weight}}then(t,e=1){return this._children.push({tween:t,weight:e}),this}toJSON(){return{type:"Multi",children:this._children.map(t=>{const e=t.tween.toJSON();return e.weight=t.weight,e})}}}class Yt extends T{get typeName(){return"shimi.SineInOutTween"}constructor(t,e){super(t,e)}tweenEquation(t){return-(Math.cos(Math.PI*t)-1)/2}toJSON(){return{type:"SineInOut",from:this.from,to:this.to}}}class zt extends T{get typeName(){return"shimi.SineInTween"}constructor(t,e){super(t,e)}tweenEquation(t){return 1-Math.cos(t*Math.PI/2)}toJSON(){return{type:"SineIn",from:this.from,to:this.to}}}class Ht extends T{get typeName(){return"shimi.SineOutTween"}constructor(t,e){super(t,e)}tweenEquation(t){return Math.sin(t*Math.PI/2)}toJSON(){return{type:"SineOut",from:this.from,to:this.to}}}class Xt extends T{constructor(t,e,i){super(t,e),this.steps=i}get typeName(){return"shimi.StepsTween"}get steps(){return this._steps}set steps(t){this._steps=t}tweenEquation(t){return t=Math.min(t,.999),Math.floor(t*(this.steps+1))/this.steps}toJSON(){return{type:"Steps",from:this.from,to:this.to,steps:this.steps}}}class $t extends T{get typeName(){return"shimi.QuadraticInOutTween"}constructor(t,e){super(t,e)}tweenEquation(t){if(t<.5)return 2*t*t;{const e=1-t;return 1-2*e*e}}toJSON(){return{type:"QuadraticInOut",from:this.from,to:this.to}}}class Zt extends T{get typeName(){return"shimi.QuadraticInTween"}constructor(t,e){super(t,e)}tweenEquation(t){return t*t}toJSON(){return{type:"QuadraticIn",from:this.from,to:this.to}}}class te extends T{get typeName(){return"shimi.QuadraticOutTween"}constructor(t,e){super(t,e)}tweenEquation(t){const e=1-t;return 1-e*e}toJSON(){return{type:"QuadraticOut",from:this.from,to:this.to}}}class ee extends T{get typeName(){return"shimi.CubicInOutTween"}constructor(t,e){super(t,e)}tweenEquation(t){return t<.5?(t*=2,Math.pow(t,3)/2):(t=2*(1-t),1-Math.pow(t,3)/2)}toJSON(){return{type:"CubicInOut",from:this.from,to:this.to}}}class ie extends T{get typeName(){return"shimi.CubicInTween"}constructor(t,e){super(t,e)}tweenEquation(t){return Math.pow(t,3)}toJSON(){return{type:"CubicIn",from:this.from,to:this.to}}}class se extends T{get typeName(){return"shimi.CubicOutTween"}constructor(t,e){super(t,e)}tweenEquation(t){const e=1-t;return 1-Math.pow(e,3)}toJSON(){return{type:"CubicOut",from:this.from,to:this.to}}}class re extends T{get typeName(){return"shimi.QuarticInOutTween"}constructor(t,e){super(t,e)}tweenEquation(t){return t<.5?(t*=2,Math.pow(t,4)/2):(t=2*(1-t),1-Math.pow(t,4)/2)}toJSON(){return{type:"QuarticInOut",from:this.from,to:this.to}}}class ne extends T{get typeName(){return"shimi.QuarticInTween"}constructor(t,e){super(t,e)}tweenEquation(t){return Math.pow(t,4)}toJSON(){return{type:"QuarticIn",from:this.from,to:this.to}}}class he extends T{get typeName(){return"shimi.QuarticOutTween"}constructor(t,e){super(t,e)}tweenEquation(t){const e=1-t;return 1-Math.pow(e,4)}toJSON(){return{type:"QuarticOut",from:this.from,to:this.to}}}class k{static multi(t,e=1){return new pt(t,e)}static linear(t,e){return new T(t,e)}static sineInOut(t,e){return new Yt(t,e)}static sineIn(t,e){return new zt(t,e)}static sineOut(t,e){return new Ht(t,e)}static steps(t,e,i){return new Xt(t,e,i)}static quadraticInOut(t,e){return new $t(t,e)}static quadraticIn(t,e){return new Zt(t,e)}static quadraticOut(t,e){return new te(t,e)}static cubicInOut(t,e){return new ee(t,e)}static cubicIn(t,e){return new ie(t,e)}static cubicOut(t,e){return new se(t,e)}static quarticInOut(t,e){return new re(t,e)}static quarticIn(t,e){return new ne(t,e)}static quarticOut(t,e){return new he(t,e)}static load(t){const e=t.type;if(e=="Multi"){const r=t.children.map(o=>({tween:k.load(o),weight:o.weight})),n=new pt(r[0].tween,r[0].weight);for(let o=1;o<r.length;o++)n.then(r[o].tween,r[o].weight);return n}const i=t.from,s=t.to;switch(e){case"Linear":return k.linear(i,s);case"SineInOut":return k.sineInOut(i,s);case"SineIn":return k.sineIn(i,s);case"SineOut":return k.sineOut(i,s);case"Steps":return k.steps(i,s,t.steps);case"QuadraticInOut":return k.quadraticInOut(i,s);case"QuadraticIn":return k.quadraticIn(i,s);case"QuadraticOut":return k.quadraticOut(i,s);case"CubicInOut":return k.cubicInOut(i,s);case"CubicIn":return k.cubicIn(i,s);case"CubicOut":return k.cubicOut(i,s);case"QuarticInOut":return k.quarticInOut(i,s);case"QuarticIn":return k.quarticIn(i,s);case"QuarticOut":return k.quarticOut(i,s)}throw new Error("Unrecognised tween type: "+e)}}class Y extends V{constructor(t,e,i,s,r=null,n=null){super(t,e),this._channel=null,this.pitch=typeof i=="string"?C(i):i,this.velocity=s,this.channel=r,this.ref=n}get typeName(){return"shimi.ClipNote"}get pitch(){return this._pitch}set pitch(t){this._pitch=t}get velocity(){return this._velocity}set velocity(t){this._velocity=t}get channel(){return this._channel}set channel(t){this._channel=t}createNote(t,e){var i;return new nt(this.pitch,typeof this.velocity=="number"?this.velocity:this.velocity.update(e),(i=this.channel)!==null&&i!==void 0?i:t,this.ref)}duplicate(){return new Y(this.start,this.duration,this.pitch,this.velocity,this.channel,this.ref)}toJSON(){const t={start:this.start,duration:this.duration,pitch:this.pitch,velocity:this.velocity};return this.channel&&(t.channel=this.channel),this.ref&&(t.ref=this.ref),t}static load(t){const e=typeof t.velocity=="number"?t.velocity:k.load(t.velocity);return new Y(t.start,t.duration,t.pitch,e,t.channel,t.ref)}}class z extends V{constructor(t,e,i,s,r=null){super(t,e),this._channel=null,this.controller=i,this.value=s,this.channel=r}get typeName(){return"shimi.ClipCC"}get controller(){return this._controller}set controller(t){this._controller=t}get value(){return this._value}set value(t){this._value=t}get channel(){return this._channel}set channel(t){this._channel=t}duplicate(){return new z(this.start,this.duration,this.controller,this.value,this.channel)}toJSON(){const t={start:this.start,duration:this.duration,controller:this.controller,value:this.value};return this.channel&&(t.channel=this.channel),t}static load(t){const e=typeof t.value=="number"?t.value:k.load(t.value);return new z(t.start,t.duration,t.controller,e,t.channel)}}class H extends V{constructor(t,e,i,s=null){super(t,e),this._channel=null,this.percent=i,this.channel=s}get typeName(){return"shimi.ClipBend"}get percent(){return this._percent}set percent(t){this._percent=t}get channel(){return this._channel}set channel(t){this._channel=t}duplicate(){return new H(this.start,this.duration,this.percent,this.channel)}toJSON(){const t={start:this.start,duration:this.duration,percent:this.percent};return this.channel&&(t.channel=this.channel),t}static load(t){const e=typeof t.percent=="number"?t.percent:k.load(t.percent);return new H(t.start,t.duration,e,t.channel)}}class ht extends V{constructor(t){super(0,t),this.notes=[],this.controlChanges=[],this.bends=[]}get typeName(){return"shimi.Clip"}addNote(t,e,i,s,r=null,n=null){typeof t=="number"&&(t=[t]),typeof i!="number"&&typeof i!="string"||(i=[i]);for(const o of t)for(const a of i)this.notes.push(new Y(o,e,a,s,r,n));return this}addCC(t,e,i,s,r=null){typeof t=="number"&&(t=[t]);for(const n of t)this.controlChanges.push(new z(n,e,i,s,r));return this}addBend(t,e,i,s=null){typeof t=="number"&&(t=[t]);for(const r of t)this.bends.push(new H(r,e,i,s));return this}duplicate(){const t=new ht(this.duration);return t.notes.push(...this.notes.map(e=>e.duplicate())),t.controlChanges.push(...this.controlChanges.map(e=>e.duplicate())),t.bends.push(...this.bends.map(e=>e.duplicate())),t}quantize(t,e=1){if(!t||t.length==0)throw new Error("You must provide a rhythm to quantize notes to");if(t.find(s=>s<=0)!=null)throw new Error("Quantize rhythm must contain only positive non-zero values");e=Math.min(1,Math.max(0,e));const i=gt(t,s=>s);for(const s of this.notes){let r=Math.floor(s.start/i)*i,n=r;for(const o of t)r+=o,Math.abs(r-s.start)<Math.abs(n-s.start)&&(n=r);n%=this.duration,s.start+=e*(n-s.start)}return this}transpose(t){for(const e of this.notes)e.pitch+=t;return this}invert(t){for(const e of this.notes)e.pitch=2*t-e.pitch;return this}reverse(){for(const t of this.notes)t.start=this.end-t.end;for(const t of this.controlChanges)t.start=this.end-t.end;for(const t of this.bends)t.start=this.end-t.end;return this}getNotesStartingInRange(t,e){return this._getChildrenStartingInRange(this.notes,t,e)}getNotesEndingInRange(t,e){return this._getChildrenEndingInRange(this.notes,t,e)}getControlChangesIntersectingRange(t,e){return this._getChildrenIntersectingRange(this.controlChanges,t,e)}getBendsIntersectingRange(t,e){return this._getChildrenIntersectingRange(this.bends,t,e)}_getChildrenStartingInRange(t,e,i){return e<=i?t.filter(s=>s.start>=e&&s.start<i):t.filter(s=>s.start>=e||s.start<i)}_getChildrenEndingInRange(t,e,i){return e<=i?t.filter(s=>s.end>=e&&s.end<i):t.filter(s=>s.end>=e||s.end<i)}_getChildrenIntersectingRange(t,e,i){return e<=i?t.filter(s=>Math.min(i,s.end)>=Math.max(e,s.start)):t.filter(s=>s.end>=e||s.start<=i)}toJSON(){return{start:this.start,duration:this.duration,notes:this.notes,controlChanges:this.controlChanges,bends:this.bends}}static load(t){const e=new ht(t.duration);return e.start=t.start,e.notes.push(...t.notes.map(i=>Y.load(i))),e.controlChanges.push(...t.controlChanges.map(i=>z.load(i))),e.bends.push(...t.bends.map(i=>H.load(i))),e}}class K{validateIntInRange(t,e,i,s){if((t=Math.round(t))<e)throw new Error(s+" cannot be less than "+e);if(t>i)throw new Error(s+" cannot be greater than "+i);return t}}class A extends K{constructor(t,e,i){super(),this.pitch=0,this.velocity=0,this.channel=0,this.pitch=typeof t=="string"?C(t):t,this.velocity=e,this.channel=i}get typeName(){return"shimi.NoteOffMessage"}toArray(){return[128+this.validateIntInRange(this.channel,0,15,"channel"),this.validateIntInRange(this.pitch,0,127,"pitch"),this.validateIntInRange(this.velocity,0,127,"velocity")]}duplicate(){return new A(this.pitch,this.velocity,this.channel)}}class D extends K{constructor(t,e,i){super(),this.pitch=0,this.velocity=0,this.channel=0,this.pitch=typeof t=="string"?C(t):t,this.velocity=e,this.channel=i}get typeName(){return"shimi.NoteOnMessage"}toArray(){return[144+this.validateIntInRange(this.channel,0,15,"channel"),this.validateIntInRange(this.pitch,0,127,"pitch"),this.validateIntInRange(this.velocity,0,127,"velocity")]}duplicate(){return new D(this.pitch,this.velocity,this.channel)}}class U extends K{constructor(t,e,i){super(),this.pitch=0,this.velocity=0,this.channel=0,this.pitch=typeof t=="string"?C(t):t,this.velocity=e,this.channel=i}get typeName(){return"shimi.NotePressureMessage"}toArray(){return[160+this.validateIntInRange(this.channel,0,15,"channel"),this.validateIntInRange(this.pitch,0,127,"pitch"),this.validateIntInRange(this.velocity,0,127,"velocity")]}duplicate(){return new U(this.pitch,this.velocity,this.channel)}}class J extends K{constructor(t,e,i){super(),this.controller=0,this.value=0,this.channel=0,this.controller=t,this.value=e,this.channel=i}get typeName(){return"shimi.ControlChangeMessage"}toArray(){return[176+this.validateIntInRange(this.channel,0,15,"channel"),this.validateIntInRange(this.controller,0,127,"controller"),this.validateIntInRange(this.value,0,127,"value")]}duplicate(){return new J(this.controller,this.value,this.channel)}}class $ extends K{constructor(t,e){super(),this.program=0,this.channel=0,this.program=t,this.channel=e}get typeName(){return"shimi.ProgramChangeMessage"}toArray(){return[192+this.validateIntInRange(this.channel,0,15,"channel"),this.validateIntInRange(this.program,0,127,"program")]}duplicate(){return new $(this.program,this.channel)}}class Z extends K{constructor(t,e){super(),this.value=t,this.channel=e}get typeName(){return"shimi.ChannelPressureMessage"}toArray(){return[208+this.validateIntInRange(this.channel,0,15,"channel"),this.validateIntInRange(this.value,0,127,"value")]}duplicate(){return new Z(this.value,this.channel)}}class F extends K{constructor(t,e){super(),this.percent=t,this.channel=e}get typeName(){return"shimi.PitchBendMessage"}toArray(){if(this.percent<-1)throw new Error("percent cannot be less than -1");if(this.percent>1)throw new Error("percent cannot be greater than 1");const t=Math.min(16383,this.validateIntInRange(8192*this.percent+8192,0,16384,"bend"));return[224+this.validateIntInRange(this.channel,0,15,"channel"),t%128,Math.floor(t/128)]}duplicate(){return new F(this.percent,this.channel)}static calculatePercent(t,e){let i=128*e+t;return i>=16383&&i<16384&&(i=16384),(i-8192)/8192}}class tt{get typeName(){return"shimi.TickMessage"}constructor(){}toArray(){return[248]}duplicate(){return new tt}}class et{constructor(t){this.value=t}get typeName(){return"shimi.SongPositionMessage"}toArray(){if(this.value<0)throw new Error("value cannot be less than 0");if(this.value>16383)throw new Error("value cannot be greater than 16383");return[242,this.value%128,Math.floor(this.value/128)]}duplicate(){return new et(this.value)}}class it{get typeName(){return"shimi.StartMessage"}constructor(){}toArray(){return[250]}duplicate(){return new it}}class st{get typeName(){return"shimi.ContinueMessage"}constructor(){}toArray(){return[251]}duplicate(){return new st}}class rt{get typeName(){return"shimi.StopMessage"}constructor(){}toArray(){return[252]}duplicate(){return new rt}}class ae{constructor(t,e,i){this._channel=0,this._speed=1,this._startBeat=0,this._beatCount=null,this._running=!0,this._beatsPassed=0,this._isFinished=!1,this._finished=new I,this._muteNotes=!1,this._muteCCs=!1,this._muteBends=!1,this._notes=[],this.clip=t,this.metronome=e,this.midiOut=i,p.default&&p.default.addChild(this)}get typeName(){return"shimi.ClipPlayer"}get clip(){return this._clip}set clip(t){this._clip!==t&&(this._endAllNotes(),this._clip=t)}get channel(){return this._channel}set channel(t){this._channel=t}get ref(){return this._ref}set ref(t){this._ref=t}get metronome(){return this._metronome}set metronome(t){this._metronome=t}get midiOut(){return this._midiOut}set midiOut(t){this._midiOut=t}get speed(){return this._speed}set speed(t){this._speed=t}get startBeat(){return this._startBeat}set startBeat(t){this._startBeat=t}get beatCount(){return this._beatCount}set beatCount(t){this._beatCount=t}get running(){return this._running}set running(t){this._running=t}get noteModifier(){return this._noteModifier}set noteModifier(t){this._noteModifier=t}get beatsPassed(){return this._beatsPassed}get isFinished(){return this._isFinished}get finished(){return this._finished}get muteNotes(){return this._muteNotes}set muteNotes(t){this._muteNotes=t,this._muteNotes&&this._endAllNotes()}get muteCCs(){return this._muteCCs}set muteCCs(t){this._muteCCs=t}get muteBends(){return this._muteBends}set muteBends(t){this._muteBends=t}get muteAll(){return this.muteNotes&&this.muteCCs&&this.muteBends}set muteAll(t){this.muteNotes=t,this.muteCCs=t,this.muteBends=t}start(){this.running=!0}pause(){this.running=!1}stop(){this.running=!1,this._beatsPassed=0}update(t){var e,i;if(!(this.running&&this.clip&&this.metronome&&this.midiOut))return;const s=(this.metronome.totalBeat-this.metronome.totalBeatTracker.oldValue)*this.speed;if(s==0)return;const r=this.beatsPassed,n=this.beatsPassed+s,o=(this.startBeat+r)%this.clip.duration,a=(this.startBeat+n)%this.clip.duration;if(o>a&&this._endAllNotes(),this._beatsPassed+=s,typeof this.beatCount=="number"&&this.beatsPassed>=this.beatCount)this.finish();else{for(const c of this._notes){const l=c.clipNote;l.contains(a)&&this.clip.notes.find(d=>d===l)?typeof l.velocity!="number"&&(c.velocity=l.velocity.update((a-l.start)/l.duration)):c.stop()}if(this._notes=this._notes.filter(c=>c.on),!this.muteNotes)for(const c of this.clip.getNotesStartingInRange(o,a)){const l=c.createNote(this.channel,(a-c.start)/c.duration);l.clipNote=c,this.noteModifier&&this.noteModifier(l),this._notes.push(l),this.midiOut.addNote(l)}if(!this.muteCCs)for(const c of this.clip.getControlChangesIntersectingRange(o,a)){const l=typeof c.value=="function";a>c.end&&c.start<o&&!l||this.midiOut.sendMessage(new J(c.controller,typeof c.value=="number"?c.value:c.value.update(Math.min(1,(a-c.start)/c.duration)),(e=c.channel)!==null&&e!==void 0?e:this.channel))}if(!this.muteBends)for(const c of this.clip.getBendsIntersectingRange(o,a)){const l=typeof c.percent=="function";a>c.end&&c.start<o&&!l||this.midiOut.sendMessage(new F(typeof c.percent=="number"?c.percent:c.percent.update(Math.min(1,(a-c.start)/c.duration)),(i=c.channel)!==null&&i!==void 0?i:this.channel))}}}finish(){this._isFinished=!0,this._endAllNotes(),this.finished.trigger(new B(this))}withRef(t){return this._ref=t,this}_endAllNotes(){for(const t of this._notes)t.stop();this._notes=[]}}class St extends y{constructor(t,e){super(t),this._clip=e}get clip(){return this._clip}}class Ot extends M{}class oe{constructor(t,e){this._beatCount=4,this._beatsPassed=0,this._clip=new ht(4),this._newClip=new Ot,this._inProgressNotes=[],this._onNoteOn=i=>{const s=i.message;this._inProgressNotes.push(new Y(this._getClipPosition(this.beatsPassed),0,s.pitch,s.velocity,s.channel))},this._onNoteOff=i=>{const s=i.message,r=this._inProgressNotes.find(n=>n.pitch==s.pitch&&n.channel==s.channel);r&&(r.end=this._getClipPosition(this.beatsPassed),this._clip.notes.push(r),this._inProgressNotes=this._inProgressNotes.filter(n=>n.pitch!=s.pitch||n.channel!=s.channel))},this._onControlChange=i=>{const s=i.message;this._clip.controlChanges.push(new z(this._getClipPosition(this.beatsPassed),0,s.controller,s.value,s.channel))},this._onPitchBend=i=>{const s=i.message;this._clip.bends.push(new H(this._getClipPosition(this.beatsPassed),0,s.percent,s.channel))},this._isFinished=!1,this._finished=new I,this.metronome=t,this.midiIn=e,p.default&&p.default.addChild(this)}get typeName(){return"shimi.ClipRecorder"}get metronome(){return this._metronome}set metronome(t){this._metronome=t}get midiIn(){return this._midiIn}set midiIn(t){this._midiIn!=t&&(this._removeMidiInSubscriptions(),this._midiIn=t,this._addMidiInSubscriptions())}_addMidiInSubscriptions(){this._midiIn&&!this.isFinished&&(this._midiIn.noteOn.add(this._onNoteOn),this._midiIn.noteOff.add(this._onNoteOff),this._midiIn.controlChange.add(this._onControlChange),this._midiIn.pitchBend.add(this._onPitchBend))}_removeMidiInSubscriptions(){this._midiIn&&(this._midiIn.noteOn.remove(t=>t.logic==this._onNoteOn),this._midiIn.noteOff.remove(t=>t.logic==this._onNoteOff),this._midiIn.controlChange.remove(t=>t.logic==this._onControlChange),this._midiIn.pitchBend.remove(t=>t.logic==this._onPitchBend))}get beatCount(){return this._beatCount}set beatCount(t){this._beatCount=t,this._clip.duration=t??0}get beatsPassed(){return this._beatsPassed}get newClip(){return this._newClip}_getClipPosition(t){return this.beatCount==null?t:t%this._clip.duration}get ref(){return this._ref}set ref(t){this._ref=t}update(t){if(this.isFinished||!this.midiIn||!this.metronome)return;const e=this.metronome.totalBeat-this.metronome.totalBeatTracker.oldValue;if(e==0)return;const i=this.beatsPassed,s=this.beatsPassed+e;this._getClipPosition(i),this._getClipPosition(s),this._beatsPassed+=e,this.beatCount!=null&&this.beatsPassed>=this.beatCount&&this.finish()}get isFinished(){return this._isFinished}get finished(){return this._finished}finish(){this._isFinished=!0,this._removeMidiInSubscriptions(),this.beatCount==null&&(this._clip.duration=this.beatsPassed);for(const t of this._inProgressNotes)t.end=this._clip.duration,this._clip.notes.push(t);this._inProgressNotes=[],this.newClip.trigger(new St(this,this._clip)),this.finished.trigger(new B(this))}withRef(t){return this._ref=t,this}}class _t{constructor(t){this._isFinished=!1,this._finished=new I,this._action=t,p.default&&p.default.addChild(this)}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}get action(){return this._action}update(t){}finish(){this._isFinished=!0,this.finished.trigger(new B(this))}withRef(t){return this._ref=t,this}}class ue extends _t{constructor(t,e){super(e),this._countPassed=0,this._msCount=t}get typeName(){return"shimi.MsCue"}get msCount(){return this._msCount}update(t){this._countPassed+=t,this._countPassed>=this.msCount&&(this.action(),this.finish())}}class ce extends _t{constructor(t,e){super(e),this._condition=t}get typeName(){return"shimi.ConditionalCue"}get condition(){return this._condition}update(t){this.condition()&&(this.action(),this.finish())}}class le extends _t{constructor(t,e,i){super(i),this._beatsPassed=0,this._metronome=t,this._beatCount=e}get typeName(){return"shimi.BeatCue"}get metronome(){return this._metronome}get beatCount(){return this._beatCount}update(t){this._beatsPassed+=this.metronome.totalBeatTracker.value-this.metronome.totalBeatTracker.oldValue,this._beatsPassed>=this.beatCount&&(this.action(),this.finish())}}class de{static when(t,e){return new ce(t,e)}static afterMs(t,e){return new ue(t,e)}static afterBeats(t,e,i){return new le(t,e,i)}}class ge{static get acousticBass(){return 35}static get bass1(){return 36}static get sideStick(){return 37}static get acousticSnare(){return 38}static get handClap(){return 39}static get electricSnare(){return 40}static get lowFloorTom(){return 41}static get closedHiHat(){return 42}static get highFloorTom(){return 43}static get pedalHiHat(){return 44}static get lowTom(){return 45}static get openHiHat(){return 46}static get lowMidTom(){return 47}static get hiMidTom(){return 48}static get crashCymbal1(){return 49}static get highTom(){return 50}static get rideCymbal1(){return 51}static get chineseCymbal(){return 52}static get rideBell(){return 53}static get tambourine(){return 54}static get splashCymbal(){return 55}static get cowbell(){return 56}static get crashCymbal2(){return 57}static get vibraslap(){return 58}static get rideCymbal2(){return 59}static get hiBongo(){return 60}static get lowBongo(){return 61}static get muteHiConga(){return 62}static get openHiConga(){return 63}static get lowConga(){return 64}static get highTimbale(){return 65}static get lowTimbale(){return 66}static get highAgogo(){return 67}static get lowAgogo(){return 68}static get cabasa(){return 69}static get maracas(){return 70}static get shortWhistle(){return 71}static get longWhistle(){return 72}static get shortGuiro(){return 73}static get longGuiro(){return 74}static get claves(){return 75}static get hiWoodBlock(){return 76}static get lowWoodBlock(){return 77}static get muteCuica(){return 78}static get openCuica(){return 79}static get muteTriangle(){return 80}static get openTriangle(){return 81}}class pe{constructor(t){this.target=t}subscribe(t,e){this.target.addEventListener(t,e)}unsubscribe(t,e){this.target.removeEventListener(t,e)}}Number.prototype.near=function(h){typeof h=="string"&&(h=C(h));let t=h-this;return m(t,12)==6&&(t>0?t--:t++),this+12*Math.round(t/12)},Object.defineProperty(Number.prototype,"octave",{get:function(){return Math.floor(this/12)-1}}),Number.prototype.toOctave=function(h){return 12*(h+1)+m(this,12)};class mt{constructor(t,e=null){this.count=1,this.swing=null,this.count=t,this.swing=e}get typeName(){return"shimi.TimeSigDivision"}}class at{constructor(t,e,i=.5){if(this.divisions=[],this.denominator=4,this.swing=0,e<=0||Math.log2(e)%1!=0)throw new Error("Invalid denominator");if(this.denominator=e,t.length==0)throw new Error("Expected at least one division");for(const s of t){let r;if(r=typeof s=="number"?new mt(s):new mt(s.count,s.swing),r.count<=0)throw new Error("Invalid division count");this.divisions.push(r)}this.swing=i}get typeName(){return"shimi.TimeSig"}get beatsPerBar(){return this.divisions.length}get quarterNotesPerBar(){return gt(this.divisions,t=>t.count)*(4/this.denominator)}applySwing(t,e=null){let i=e??this.swing;if(i==0)return t;let s=Math.floor(t);return t%=1,i=Math.max(-.99,Math.min(.99,i)),s+=t<=i?t/i*.5:.5+(t-i)/(1-i)*.5,s}quarterNoteToBeat(t){var e;const i=this.beatsPerBar,s=this.quarterNotesPerBar,r=Math.floor(t/s)*i;t%=s;let n=0;for(const o of this.divisions){if(!(t>=o.count)){let a=(e=o.swing)!==null&&e!==void 0?e:this.swing;if(a==0)n+=t/o.count;else{a=Math.max(-.99,Math.min(.99,a));const c=a*o.count;n+=t<=c?t/c*.5:.5+(t-c)/(o.count-c)*.5}break}t-=o.count,n++}return r+n}beatToQuarterNote(t){var e;const i=this.beatsPerBar,s=this.quarterNotesPerBar,r=Math.floor(t/i)*s;t%=i;let n=0;for(const o of this.divisions){if(!(t>=1)){let a=(e=o.swing)!==null&&e!==void 0?e:this.swing;if(a==.5)n+=t*o.count;else{a=Math.max(-.99,Math.min(.99,a));const c=a*o.count;n+=t<=.5?2*t*c:c+2*(t-.5)*(o.count-c)}break}n+=o.count,t--}return r+n}static commonTime(t=.5){return new at([1,1,1,1],4,t)}}class Tt{_atBarPosition(t,e){return e.oldValue===e.value?e.value===t:e.oldValue<e.value?t>e.oldValue&&t<=e.value:t<=e.value||t>e.oldValue}_atBarPositionMultiple(t,e){var i=e.oldValue/t,s=e.value/t;return s%1==0?s:Math.floor(i)===Math.floor(s)?-1:Math.floor(s)}}class _e extends Tt{constructor(t,e=null){if(super(),this._tempo=120,this._tempoMultiplier=1,this._timeSig=new N,this._totalQuarterNote=new N(0),this._totalBeat=new N(0),this._bar=new N(1),this._barQuarterNote=new N(0),this._barBeat=new N(0),this._enabled=new N(!0),this._isFinished=!1,this._finished=new I,this._positionChanged=new M,this._started=new M,this._continued=new M,this._stopped=new M,!t||t<0)throw new Error("Invalid tempo provided");this.timeSig=e||at.commonTime(),this._timeSig.accept(),this.tempo=t,p.default&&p.default.addChild(this)}get typeName(){return"shimi.Metronome"}get tempo(){return this._tempo}set tempo(t){this._tempo=t}get tempoMultiplier(){return this._tempoMultiplier}set tempoMultiplier(t){if(t<=0)throw new Error("Invalid tempoMultiplier.");this._tempoMultiplier=t}get ref(){return this._ref}set ref(t){this._ref=t}get timeSig(){return this._timeSig.oldValue}set timeSig(t){this._timeSig.value=t}get totalQuarterNote(){return this._totalQuarterNote.value}get totalQuarterNoteTracker(){return this._totalQuarterNote}get totalBeat(){return this._totalBeat.value}get totalBeatTracker(){return this._totalBeat}get bar(){return this._bar.value}get barTracker(){return this._bar}get barQuarterNote(){return this._barQuarterNote.value}get barQuarterNoteTracker(){return this._barQuarterNote}get barBeat(){return this._barBeat.value}get barBeatTracker(){return this._barBeat}get enabled(){return this._enabled.value}set enabled(t){this._enabled.value!=t&&(this._enabled.value=t,t?this.continued.trigger(new y(this)):this.stopped.trigger(new y(this)))}get isFinished(){return this._isFinished}get finished(){return this._finished}atBarBeat(t){return super._atBarPosition(t,this._barBeat)}atBarQuarterNote(t){return super._atBarPosition(t,this._barQuarterNote)}atBarBeatMultiple(t){return super._atBarPositionMultiple(t,this._barBeat)}atBarQuarterNoteMultiple(t){return super._atBarPositionMultiple(t,this._barQuarterNote)}update(t){const e=t*(this.tempo/6e4)*this.tempoMultiplier;return this.updateFromQuarterNoteDelta(e)}updateFromQuarterNoteDelta(t){if(this._enabled.accept(),!this.enabled)return!1;this._totalQuarterNote.oldValue==0&&this.started.trigger(new y(this)),this._totalQuarterNote.accept(),this._totalQuarterNote.value+=t,this._barQuarterNote.accept(),this._barQuarterNote.value+=t,this._bar.accept();let e=0;for(;e=this.timeSig.quarterNotesPerBar,!(this.barQuarterNote<e);)this._barQuarterNote.value-=e,this._bar.value++,this._timeSig.accept();this._barBeat.accept(),this._totalBeat.accept(),this._updateBeatValuesFromQuarterNoteValues()}_updateBeatValuesFromQuarterNoteValues(){this.timeSig.quarterNotesPerBar%1!=0&&Math.floor(this.barQuarterNote)+1>this.timeSig.quarterNotesPerBar?(this._barBeat.value=this.barQuarterNote,this._totalBeat.value=this.totalQuarterNote):(this._barBeat.value=this.timeSig.applySwing(this.barQuarterNote),this._totalBeat.value=this.totalQuarterNote-this.barQuarterNote+this.barBeat)}finish(){this._isFinished=!0,this._enabled.value=!1,this.finished.trigger(new B(this))}withRef(t){return this._ref=t,this}setSongPosition(t){this._timeSig.accept(),this._totalQuarterNote.value=t,this._totalQuarterNote.accept(),this._bar.value=Math.floor(t/this.timeSig.quarterNotesPerBar),this._bar.accept(),this._barQuarterNote.value=t-this.bar*this.timeSig.quarterNotesPerBar,this._barQuarterNote.accept(),this._updateBeatValuesFromQuarterNoteValues(),this._barBeat.accept(),this._totalBeat.accept(),this.positionChanged.trigger(new y(this))}get positionChanged(){return this._positionChanged}get started(){return this._started}get continued(){return this._continued}get stopped(){return this._stopped}}class me extends Tt{constructor(t,e=null){super(),this._tempo=120,this._tempoMultiplier=1,this._timeSig=new N,this._totalQuarterNote=new N(0),this._totalBeat=new N(0),this._bar=new N(1),this._barQuarterNote=new N(0),this._barBeat=new N(0),this._enabled=new N(!0),this._isFinished=!1,this._finished=new I,this._positionChanged=new M,this._started=new M,this._continued=new M,this._stopped=new M,this.timeSig=e||at.commonTime(),this._timeSig.accept(),this.tempo=t,p.default&&p.default.addChild(this)}get typeName(){return"shimi.Flexinome"}get tempo(){return this._tempo}set tempo(t){this._tempo=t}get tempoMultiplier(){return this._tempoMultiplier}set tempoMultiplier(t){if(t<=0)throw new Error("Invalid tempoMultiplier.");this._tempoMultiplier=t}get ref(){return this._ref}set ref(t){this._ref=t}get timeSig(){return this._timeSig.oldValue}set timeSig(t){this._timeSig.value=t}get totalQuarterNote(){return this._totalQuarterNote.value}get totalQuarterNoteTracker(){return this._totalQuarterNote}get totalBeat(){return this._totalBeat.value}get totalBeatTracker(){return this._totalBeat}get bar(){return this._bar.value}get barTracker(){return this._bar}get barQuarterNote(){return this._barQuarterNote.value}get barQuarterNoteTracker(){return this._barQuarterNote}get barBeat(){return this._barBeat.value}get barBeatTracker(){return this._barBeat}get enabled(){return this._enabled.value}set enabled(t){this._enabled.value!=t&&(this._enabled.value=t,t?this.continued.trigger(new y(this)):this.stopped.trigger(new y(this)))}get isFinished(){return this._isFinished}get finished(){return this._finished}atBarBeat(t){return super._atBarPosition(t,this._barBeat)}atBarQuarterNote(t){return super._atBarPosition(t,this._barQuarterNote)}atBarBeatMultiple(t){return super._atBarPositionMultiple(t,this._barBeat)}atBarQuarterNoteMultiple(t){return super._atBarPositionMultiple(t,this._barQuarterNote)}update(t){const e=t*(this.tempo/6e4)*this.tempoMultiplier;return this.updateFromQuarterNoteDelta(e)}updateFromQuarterNoteDelta(t){if(this._enabled.accept(),!this.enabled)return!1;this._totalQuarterNote.oldValue==0&&this.started.trigger(new y(this)),this._totalQuarterNote.accept(),this._totalQuarterNote.value+=t,this._barQuarterNote.accept(),this._barQuarterNote.value+=t,this._bar.accept();let e=0;for(;e=this.timeSig.quarterNotesPerBar,!(this.barQuarterNote<e);)this._barQuarterNote.value-=e,this._bar.value++,this._timeSig.accept();this._barBeat.accept(),this._totalBeat.accept(),this._barBeat.value=this.timeSig.quarterNoteToBeat(this.barQuarterNote),this._totalBeat.value=this.totalBeat-this._barBeat.oldValue+this.barBeat}finish(){this._isFinished=!0,this._enabled.value=!1,this.finished.trigger(new B(this))}withRef(t){return this._ref=t,this}setSongPosition(t){this._timeSig.accept(),this._totalQuarterNote.value=t,this._totalQuarterNote.accept(),this._bar.value=Math.floor(t/this.timeSig.quarterNotesPerBar),this._bar.accept(),this._barQuarterNote.value=t-this.bar*this.timeSig.quarterNotesPerBar,this._barQuarterNote.accept(),this._barBeat.value=this.timeSig.quarterNoteToBeat(this.barQuarterNote),this._barBeat.accept(),this._totalBeat.value=this.barBeat+this.bar*this.timeSig.beatsPerBar,this._totalBeat.accept(),this.positionChanged.trigger(new y(this))}get positionChanged(){return this._positionChanged}get started(){return this._started}get continued(){return this._continued}get stopped(){return this._stopped}}class fe{constructor(t){this._unmatched=[],this._matched=[null,null,null,null],this._isFinished=!1,this._finished=new I,this._updateProvider=t,p.default&&p.default.addChild(this)}get typeName(){return"shimi.Gamepads"}get activeGamepads(){return this._matched.filter(t=>t!==null)}add(t){this._unmatched.push(t)}update(t){const e=this._updateProvider();for(let i=0;i<e.length&&i<4;i++)if(this._matched[i]==null&&e[i]!=null)for(let s=0;s<this._unmatched.length;s++){const r=this._unmatched[s];if(r.canMatch(e[i])){this._matched[i]=r,this._unmatched=this._unmatched.filter(n=>n!==r);break}}for(let i=0;i<4;i++){const s=this._matched[i];if(!s)continue;const r=e[i];if(r){for(let n=0;n<s.buttons.length&&n<r.buttons.length;n++){const o=s.buttons[n],a=r.buttons[n];o.valueTracker.value=a.value}for(let n=0;n<s.axes.length&&n<r.axes.length;n++){const o=s.axes[n],a=r.axes[n];o.valueTracker.value=a}s.update(t)}else this._matched[i]=null,this._unmatched.push(s)}}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}finish(){this._isFinished=!0,this.finished.trigger(new B(this))}withRef(t){return this._ref=t,this}}class we{constructor(t){this._buttons=[],this._isFinished=!1,this._finished=new I,this._escape=new u("escape"),this._f1=new u("f1"),this._f2=new u("f2"),this._f3=new u("f3"),this._f4=new u("f4"),this._f5=new u("f5"),this._f6=new u("f6"),this._f7=new u("f7"),this._f8=new u("f8"),this._f9=new u("f9"),this._f10=new u("f10"),this._f11=new u("f11"),this._f12=new u("f12"),this._backquote=new u("backquote"),this._numrow1=new u("numrow1"),this._numrow2=new u("numrow2"),this._numrow3=new u("numrow3"),this._numrow4=new u("numrow4"),this._numrow5=new u("numrow5"),this._numrow6=new u("numrow6"),this._numrow7=new u("numrow7"),this._numrow8=new u("numrow8"),this._numrow9=new u("numrow9"),this._numrow0=new u("numrow0"),this._minus=new u("minus"),this._equal=new u("equal"),this._backspace=new u("backspace"),this._tab=new u("tab"),this._q=new u("q"),this._w=new u("w"),this._e=new u("e"),this._r=new u("r"),this._t=new u("t"),this._y=new u("y"),this._u=new u("u"),this._i=new u("i"),this._o=new u("o"),this._p=new u("p"),this._leftBracket=new u("leftBracket"),this._rightBracket=new u("rightBracket"),this._enter=new u("enter"),this._capslock=new u("capslock"),this._a=new u("a"),this._s=new u("s"),this._d=new u("d"),this._f=new u("f"),this._g=new u("g"),this._h=new u("h"),this._j=new u("j"),this._k=new u("k"),this._l=new u("l"),this._semicolon=new u("semicolon"),this._quote=new u("quote"),this._backslash=new u("backslash"),this._leftShift=new u("leftShift"),this._intlBackslash=new u("intlBackslash"),this._z=new u("z"),this._x=new u("x"),this._c=new u("c"),this._v=new u("v"),this._b=new u("b"),this._n=new u("n"),this._m=new u("m"),this._comma=new u("comma"),this._period=new u("period"),this._slash=new u("slash"),this._rightShift=new u("rightShift"),this._leftCtrl=new u("leftCtrl"),this._leftAlt=new u("leftAlt"),this._space=new u("space"),this._rightAlt=new u("rightAlt"),this._rightCtrl=new u("rightCtrl"),this._insert=new u("insert"),this._home=new u("home"),this._pageUp=new u("pageUp"),this._delete=new u("delete"),this._end=new u("end"),this._pageDown=new u("pageDown"),this._up=new u("up"),this._left=new u("left"),this._down=new u("down"),this._right=new u("right"),this._numlock=new u("numlock"),this._numpadDivide=new u("numpadDivide"),this._numpadMultiply=new u("numpadMultiply"),this._numpadSubtract=new u("numpadSubtract"),this._numpad7=new u("numpad7"),this._numpad8=new u("numpad8"),this._numpad9=new u("numpad9"),this._numpadAdd=new u("numpadAdd"),this._numpad4=new u("numpad4"),this._numpad5=new u("numpad5"),this._numpad6=new u("numpad6"),this._numpad1=new u("numpad1"),this._numpad2=new u("numpad2"),this._numpad3=new u("numpad3"),this._numpadEnter=new u("numpadEnter"),this._numpad0=new u("numpad0"),this._numpadDecimal=new u("numpadDecimal"),this._activated=!1,this._onKeyDown=e=>{const i=this._getButtonByEventCode(e.code);i&&(i.valueTracker.value=1,i.update(0))},this._onKeyUp=e=>{const i=this._getButtonByEventCode(e.code);i&&(i.valueTracker.value=0,i.update(0))},this._eventSubscriber=t,this.buttons.push(this.f1,this.f2,this.f3,this.f4,this.f5,this.f6,this.f7,this.f8,this.f9,this.f10,this.f11,this.f12),this.buttons.push(this.backquote,this.numrow1,this.numrow2,this.numrow3,this.numrow4,this.numrow5,this.numrow6,this.numrow7,this.numrow8,this.numrow9,this.numrow0,this.minus,this.equal,this.backspace),this.buttons.push(this.tab,this.q,this.w,this.e,this.r,this.t,this.y,this.u,this.i,this.o,this.p,this.leftBracket,this.rightBracket,this.enter),this.buttons.push(this.capslock,this.a,this.s,this.d,this.f,this.g,this.h,this.j,this.k,this.l,this.semicolon,this.quote,this.backslash),this.buttons.push(this.leftShift,this.intlBackslash,this.z,this.x,this.c,this.v,this.b,this.n,this.m,this.comma,this.period,this.slash,this.rightShift),this.buttons.push(this.leftCtrl,this.leftAlt,this.space,this.rightAlt,this.rightCtrl),this.buttons.push(this.insert,this.home,this.pageUp,this.delete,this.end,this.pageDown),this.buttons.push(this.up,this.left,this.down,this.right),this.buttons.push(this.numlock,this.numpadDivide,this.numpadMultiply,this.numpadSubtract,this.numpad7,this.numpad8,this.numpad9,this.numpadAdd,this.numpad4,this.numpad5,this.numpad6,this.numpad1,this.numpad2,this.numpad3,this.numpadEnter,this.numpad0,this.numpadDecimal),p.default&&p.default.addChild(this)}get typeName(){return"shimi.Keyboard"}get buttons(){return this._buttons}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}get escape(){return this._escape}get f1(){return this._f1}get f2(){return this._f2}get f3(){return this._f3}get f4(){return this._f4}get f5(){return this._f5}get f6(){return this._f6}get f7(){return this._f7}get f8(){return this._f8}get f9(){return this._f9}get f10(){return this._f10}get f11(){return this._f11}get f12(){return this._f12}get backquote(){return this._backquote}get numrow1(){return this._numrow1}get numrow2(){return this._numrow2}get numrow3(){return this._numrow3}get numrow4(){return this._numrow4}get numrow5(){return this._numrow5}get numrow6(){return this._numrow6}get numrow7(){return this._numrow7}get numrow8(){return this._numrow8}get numrow9(){return this._numrow9}get numrow0(){return this._numrow0}get minus(){return this._minus}get equal(){return this._equal}get backspace(){return this._backspace}get tab(){return this._tab}get q(){return this._q}get w(){return this._w}get e(){return this._e}get r(){return this._r}get t(){return this._t}get y(){return this._y}get u(){return this._u}get i(){return this._i}get o(){return this._o}get p(){return this._p}get leftBracket(){return this._leftBracket}get rightBracket(){return this._rightBracket}get enter(){return this._enter}get capslock(){return this._capslock}get a(){return this._a}get s(){return this._s}get d(){return this._d}get f(){return this._f}get g(){return this._g}get h(){return this._h}get j(){return this._j}get k(){return this._k}get l(){return this._l}get semicolon(){return this._semicolon}get quote(){return this._quote}get backslash(){return this._backslash}get leftShift(){return this._leftShift}get intlBackslash(){return this._intlBackslash}get z(){return this._z}get x(){return this._x}get c(){return this._c}get v(){return this._v}get b(){return this._b}get n(){return this._n}get m(){return this._m}get comma(){return this._comma}get period(){return this._period}get slash(){return this._slash}get rightShift(){return this._rightShift}get leftCtrl(){return this._leftCtrl}get leftAlt(){return this._leftAlt}get space(){return this._space}get rightAlt(){return this._rightAlt}get rightCtrl(){return this._rightCtrl}get insert(){return this._insert}get home(){return this._home}get pageUp(){return this._pageUp}get delete(){return this._delete}get end(){return this._end}get pageDown(){return this._pageDown}get up(){return this._up}get left(){return this._left}get down(){return this._down}get right(){return this._right}get numlock(){return this._numlock}get numpadDivide(){return this._numpadDivide}get numpadMultiply(){return this._numpadMultiply}get numpadSubtract(){return this._numpadSubtract}get numpad7(){return this._numpad7}get numpad8(){return this._numpad8}get numpad9(){return this._numpad9}get numpadAdd(){return this._numpadAdd}get numpad4(){return this._numpad4}get numpad5(){return this._numpad5}get numpad6(){return this._numpad6}get numpad1(){return this._numpad1}get numpad2(){return this._numpad2}get numpad3(){return this._numpad3}get numpadEnter(){return this._numpadEnter}get numpad0(){return this._numpad0}get numpadDecimal(){return this._numpadDecimal}activate(){return!this._activated&&(this._eventSubscriber.subscribe("keydown",this._onKeyDown),this._eventSubscriber.subscribe("keyup",this._onKeyUp),this._activated=!0,!0)}deactivate(){return!!this._activated&&(this._eventSubscriber.unsubscribe("keydown",this._onKeyDown),this._eventSubscriber.unsubscribe("keyup",this._onKeyUp),this._activated=!1,!0)}finish(){this._isFinished=!0,this.deactivate(),this.finished.trigger(new B(this))}withRef(t){return this._ref=t,this}_getButtonByEventCode(t){switch(t){case"F1":return this.f1;case"F2":return this.f2;case"F3":return this.f3;case"F4":return this.f4;case"F5":return this.f5;case"F6":return this.f6;case"F7":return this.f7;case"F8":return this.f8;case"F9":return this.f9;case"F10":return this.f10;case"F11":return this.f11;case"F12":return this.f12;case"Backquote":return this.backquote;case"Digit1":return this.numrow1;case"Digit2":return this.numrow2;case"Digit3":return this.numrow3;case"Digit4":return this.numrow4;case"Digit5":return this.numrow5;case"Digit6":return this.numrow6;case"Digit7":return this.numrow7;case"Digit8":return this.numrow8;case"Digit9":return this.numrow9;case"Digit0":return this.numrow0;case"Minus":return this.minus;case"Equal":return this.equal;case"Backspace":return this.backspace;case"Tab":return this.tab;case"KeyQ":return this.q;case"KeyW":return this.w;case"KeyE":return this.e;case"KeyR":return this.r;case"KeyT":return this.t;case"KeyY":return this.y;case"KeyU":return this.u;case"KeyI":return this.i;case"KeyO":return this.o;case"KeyP":return this.p;case"BracketLeft":return this.leftBracket;case"BracketRight":return this.rightBracket;case"Enter":return this.enter;case"CapsLock":return this.capslock;case"KeyA":return this.a;case"KeyS":return this.s;case"KeyD":return this.d;case"KeyF":return this.f;case"KeyG":return this.g;case"KeyH":return this.h;case"KeyJ":return this.j;case"KeyK":return this.k;case"KeyL":return this.l;case"Semicolon":return this.semicolon;case"Quote":return this.quote;case"Backslash":return this.backslash;case"ShiftLeft":return this.leftShift;case"IntlBackslash":return this.intlBackslash;case"KeyZ":return this.z;case"KeyX":return this.x;case"KeyC":return this.c;case"KeyV":return this.v;case"KeyB":return this.b;case"KeyN":return this.n;case"KeyM":return this.m;case"Comma":return this.comma;case"Period":return this.period;case"Slash":return this.slash;case"ShiftRight":return this.rightShift;case"ControlLeft":return this.leftCtrl;case"AltLeft":return this.leftAlt;case"Space":return this.space;case"AltRight":return this.rightAlt;case"ControlRight":return this.rightCtrl;case"Insert":return this.insert;case"Home":return this.home;case"PageUp":return this.pageUp;case"Delete":return this.delete;case"End":return this.end;case"PageDown":return this.pageDown;case"ArrowUp":return this.up;case"ArrowLeft":return this.left;case"ArrowDown":return this.down;case"ArrowRight":return this.right;case"NumLock":return this.numlock;case"NumpadDivide":return this.numpadDivide;case"NumpadMultiply":return this.numpadMultiply;case"NumpadSubtract":return this.numpadSubtract;case"Numpad7":return this.numpad7;case"Numpad8":return this.numpad8;case"Numpad9":return this.numpad9;case"NumpadAdd":return this.numpadAdd;case"Numpad4":return this.numpad4;case"Numpad5":return this.numpad5;case"Numpad6":return this.numpad6;case"Numpad1":return this.numpad1;case"Numpad2":return this.numpad2;case"Numpad3":return this.numpad3;case"NumpadEnter":return this.numpadEnter;case"Numpad0":return this.numpad0;case"NumpadDecimal":return this.numpadDecimal}return null}update(t){for(const e of this.buttons)e.update(t)}}var be=function(h,t,e,i){return new(e||(e=Promise))(function(s,r){function n(c){try{a(i.next(c))}catch(l){r(l)}}function o(c){try{a(i.throw(c))}catch(l){r(l)}}function a(c){var l;c.done?s(c.value):(l=c.value,l instanceof e?l:new e(function(d){d(l)})).then(n,o)}a((i=i.apply(h,t||[])).next())})};class xt extends y{constructor(t,e){super(t),this._port=e}get port(){return this._port}}class Et extends M{}class ft{constructor(t){this._onBaseAccessStateChange=e=>{this.portChanged.trigger(new xt(this,e))},this._portChanged=new Et,this._baseAccess=t,this._baseAccess.onstatechange=this._onBaseAccessStateChange}get typeName(){return"shimi.MidiAccess"}static request(){return be(this,void 0,void 0,function*(){const t=yield navigator.requestMIDIAccess();return new ft(t)})}get portChanged(){return this._portChanged}detach(){this._baseAccess&&(this._baseAccess.onstatechange=void 0,this._baseAccess=null)}getOutPort(t){let e=null;return this._baseAccess.outputs.forEach(i=>{i.name===t&&(e=i)}),e}getInPort(t){let e=null;return this._baseAccess.inputs.forEach(i=>{i.name===t&&(e=i)}),e}getOutPortNames(){const t=[];return this._baseAccess.outputs.forEach(e=>t.push(e.name)),t}getInPortNames(){const t=[];return this._baseAccess.inputs.forEach(e=>t.push(e.name)),t}}class _ extends y{constructor(t,e){super(t),this._message=e}get message(){return this._message}}class w extends M{}class ve{constructor(t){this._noteOff=new w,this._noteOn=new w,this._notePressure=new w,this._controlChange=new w,this._programChange=new w,this._channelPressure=new w,this._pitchBend=new w,this._tick=new w,this._songPosition=new w,this._start=new w,this._continue=new w,this._stop=new w,this._previousStatus=null,this.port=t}get typeName(){return"shimi.MidiIn"}get port(){return this._port}set port(t){this._port&&(this._port.onmidimessage=void 0),this._port=t,this._port&&(this._port.onmidimessage=e=>this._receiveMessage(e))}get noteOff(){return this._noteOff}get noteOn(){return this._noteOn}get notePressure(){return this._notePressure}get controlChange(){return this._controlChange}get programChange(){return this._programChange}get channelPressure(){return this._channelPressure}get pitchBend(){return this._pitchBend}get tick(){return this._tick}get songPosition(){return this._songPosition}get start(){return this._start}get continue(){return this._continue}get stop(){return this._stop}_receiveMessage(t){this.receiveData(t.data)}receiveData(t){if(t.length==0)return;if(t.length==1&&t[0]==248)return void this.tick.trigger(new _(this,new tt));if(t[0]>=128)this._previousStatus=t[0];else{if(!this._previousStatus)return;t.unshift(this._previousStatus)}const e=16*Math.floor(t[0]/16),i=t[0]-e;e==128?this.noteOff.trigger(new _(this,new A(t[1],t[2],i))):e==144?this.noteOn.trigger(new _(this,new D(t[1],t[2],i))):e==160?this.notePressure.trigger(new _(this,new U(t[1],t[2],i))):e==176?this.controlChange.trigger(new _(this,new J(t[1],t[2],i))):e==192?this.programChange.trigger(new _(this,new $(t[1],i))):e==208?this.channelPressure.trigger(new _(this,new Z(t[1],i))):e==224?this.pitchBend.trigger(new _(this,new F(F.calculatePercent(t[1],t[2]),i))):e==240&&(i==2&&t.length==1?this.start.trigger(new _(this,new it)):i==2&&t.length==3?this.songPosition.trigger(new _(this,new et(128*t[2]+t[1]))):i==3&&t.length==1?this.continue.trigger(new _(this,new st)):i==4&&t.length==1&&this.stop.trigger(new _(this,new rt)))}}class Me{constructor(){this._noteOff=new w,this._noteOn=new w,this._notePressure=new w,this._controlChange=new w,this._programChange=new w,this._channelPressure=new w,this._pitchBend=new w,this._tick=new w,this._songPosition=new w,this._start=new w,this._continue=new w,this._stop=new w,this._previousStatus=null,this._notes=[],this._isFinished=!1,this._finished=new I,p.default&&p.default.addChild(this)}get typeName(){return"shimi.MidiBus"}get noteOff(){return this._noteOff}get noteOn(){return this._noteOn}get notePressure(){return this._notePressure}get controlChange(){return this._controlChange}get programChange(){return this._programChange}get channelPressure(){return this._channelPressure}get pitchBend(){return this._pitchBend}get tick(){return this._tick}get songPosition(){return this._songPosition}get start(){return this._start}get continue(){return this._continue}get stop(){return this._stop}receiveData(t){if(t.length==0)return;if(t.length==1&&t[0]==248)return void this.tick.trigger(new _(this,new tt));if(t[0]>=128)this._previousStatus=t[0];else{if(!this._previousStatus)return;t.unshift(this._previousStatus)}const e=16*Math.floor(t[0]/16),i=t[0]-e;e==128?this.noteOff.trigger(new _(this,new A(t[1],t[2],i))):e==144?this.noteOn.trigger(new _(this,new D(t[1],t[2],i))):e==160?this.notePressure.trigger(new _(this,new U(t[1],t[2],i))):e==176?this.controlChange.trigger(new _(this,new J(t[1],t[2],i))):e==192?this.programChange.trigger(new _(this,new $(t[1],i))):e==208?this.channelPressure.trigger(new _(this,new Z(t[1],i))):e==224?this.pitchBend.trigger(new _(this,new F(F.calculatePercent(t[1],t[2]),i))):e==240&&(i==2&&t.length==1?this.start.trigger(new _(this,new it)):i==2&&t.length==3?this.songPosition.trigger(new _(this,new et(128*t[2]+t[1]))):i==3&&t.length==1?this.continue.trigger(new _(this,new st)):i==4&&t.length==1&&this.stop.trigger(new _(this,new rt)))}get notes(){return this._notes}addNote(t){return this._notes.push(t),t}stopNotes(t){for(const e of this._notes)t&&!t(e)||e.stop()}sendMessage(t){switch(t.typeName){case"shimi.NoteOffMessage":this.noteOff.trigger(new _(this,t));break;case"shimi.NoteOnMessage":this.noteOn.trigger(new _(this,t));break;case"shimi.NotePressureMessage":this.notePressure.trigger(new _(this,t));break;case"shimi.ControlChangeMessage":this.controlChange.trigger(new _(this,t));break;case"shimi.ProgramChangeMessage":this.programChange.trigger(new _(this,t));break;case"shimi.ChannelPressureMessage":this.channelPressure.trigger(new _(this,t));break;case"shimi.PitchBendMessage":this.pitchBend.trigger(new _(this,t));break;case"shimi.TickMessage":this.tick.trigger(new _(this,t));break;case"shimi.SongPositionMessage":this.songPosition.trigger(new _(this,t));break;case"shimi.StartMessage":this.start.trigger(new _(this,t));break;case"shimi.ContinueMessage":this.continue.trigger(new _(this,t));break;case"shimi.StopMessage":this.stop.trigger(new _(this,t))}}sendRawData(t){if(!t||t.length===0)throw new Error("No data specified to send");this.receiveData(t)}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}finish(){this._isFinished=!0,this.stopNotes(t=>!0),this.finished.trigger(new B(this))}withRef(t){return this._ref=t,this}update(t){let e=!1;for(let i=0;i<this._notes.length;i++){const s=this._notes[i];if(!s.on){if(s.onTracker.isDirty){let r=!0;for(let n=i+1;n<this.notes.length;n++){const o=this.notes[n];if(s.pitch===o.pitch&&s.channel===o.channel&&o.on&&!o.onTracker.isDirty){r=!1;break}}r&&this.sendMessage(new A(s.pitch,s.velocity,s.channel)),s.onTracker.accept()}e=!0}}for(const i of this._notes)i.on&&(i.onTracker.isDirty?(this.sendMessage(new D(i.pitch,i.velocity,i.channel)),i.onTracker.accept(),i.velocityTracker.accept()):i.velocityTracker.isDirty&&(this.sendMessage(new U(i.pitch,i.velocity,i.channel)),i.velocityTracker.accept()));e&&(this._notes=this._notes.filter(i=>i.on))}}class ye{constructor(t){this._notes=[],this._isFinished=!1,this._finished=new I,this.suppressPortValidationErrors=!1,this.port=t,p.default&&p.default.addChild(this)}get typeName(){return"shimi.MidiOut"}get notes(){return this._notes}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}finish(){this._isFinished=!0,this.stopNotes(t=>!0),this.finished.trigger(new B(this))}withRef(t){return this._ref=t,this}addNote(t){return this._notes.push(t),t.on&&(this.sendMessage(new D(t.pitch,t.velocity,t.channel)),t.onTracker.accept()),t}stopNotes(t){for(const e of this._notes)t&&!t(e)||e.stop()}sendMessage(t){return!!this.validatePort()&&(this.port.send(t.toArray()),!0)}sendRawData(t){if(!this.validatePort())return!1;if(!t||t.length===0)throw new Error("No data specified to send");return this.port.send(t),!0}validatePort(){if(!this.port){if(this.suppressPortValidationErrors)return!1;throw new Error("MidiOut has no port connected")}return!0}update(t){let e=!1;for(let i=0;i<this._notes.length;i++){const s=this._notes[i];if(!s.on){if(s.onTracker.isDirty){let r=!0;for(let n=i+1;n<this.notes.length;n++){const o=this.notes[n];if(s.pitch===o.pitch&&s.channel===o.channel&&o.on&&!o.onTracker.isDirty){r=!1;break}}r&&this.sendMessage(new A(s.pitch,s.velocity,s.channel)),s.onTracker.accept()}e=!0}}for(const i of this._notes)i.on&&(i.onTracker.isDirty?(this.sendMessage(new D(i.pitch,i.velocity,i.channel)),i.onTracker.accept(),i.velocityTracker.accept()):i.velocityTracker.isDirty&&(this.sendMessage(new U(i.pitch,i.velocity,i.channel)),i.velocityTracker.accept()));e&&(this._notes=this._notes.filter(i=>i.on))}}class Rt extends y{constructor(t){super(t)}}class Dt extends M{}class Q{constructor(t){this._activeMs=0,this.changed=new Dt,this.valueTracker=new N(0),this._name=t}get typeName(){return"shimi.SliderInput"}get value(){return this.valueTracker.value}get name(){return this._name}get activeMs(){return this._activeMs}update(t){this.value!=0&&(this._activeMs+=t),this.valueTracker.isDirty&&this.changed.trigger(new Rt(this)),this.value==0&&(this._activeMs=0),this.valueTracker.accept()}}class Ce{constructor(t,e){for(let i=0;i<t.length;i++){for(let s=i+1;s<t.length;s++)if(t[i]==t[s])throw new Error(`The button name '${t[i]}' is repeated.`);for(let s=0;s<e.length;s++)if(t[i]==e[s])throw new Error(`The button name '${t[i]}' cannot also be used for an axis.`)}for(let i=0;i<e.length;i++)for(let s=i+1;s<e.length;s++)if(e[i]==e[s])throw new Error(`The axis name '${e[i]}' is repeated.`);this._buttons=t.map(i=>new u(i)),this._axes=e.map(i=>new Q(i));for(const i of this.buttons){if(this[i.name]!=null)throw new Error(`Cannot use'${i.name}' as a button name.`);this[i.name]=i}for(const i of this.axes){if(this[i.name]!=null)throw new Error(`Cannot use'${i.name}' as an axis name.`);this[i.name]=i}}get typeName(){return"shimi.MiscController"}get buttons(){return this._buttons}get axes(){return this._axes}update(t){for(const e of this.buttons)e.update(t);for(const e of this.axes)e.update(t)}canMatch(t){return t.buttons.length==this.buttons.length&&t.axes.length==this.axes.length}}class Ne{constructor(t,e,i){this.optimize(t,e,i)}optimize(t,e,i){const s=[];for(let a=12;a<24;a++)e.contains(a)&&s.push(a);t=t.map(a=>m(a,12)+12).filter((a,c,l)=>l.indexOf(a)===c);const r=new Array;function n(a,c){let l=Math.abs(a-c);return l>6&&(l=12-l),l}function o(){for(const a of s){let c=r.find(d=>d.woman==a&&d.status==1);const l=r.filter(d=>d.woman==a&&d.status==0);if(c&&l.find(d=>d.distance<=c.distance)&&(c.status=-1,c=null),!c&&l.length>0){c=l.sort((d,f)=>R(d,f,b=>b.distance))[0],c.status=1;for(const d of l.filter(f=>f.status==0))d.status=-1}}}for(const a of t){const c=e.fitPitch(a,i);r.push({man:a,woman:c,status:0,distance:n(a,c)})}for(o();r.filter(a=>a.status==1).length<Math.min(t.length,s.length);){for(const a of t){if(r.find(d=>d.man==a&&d.status==1))continue;const c=r.filter(d=>d.man==a&&d.status==-1),l=s.filter(d=>!c.find(f=>f.woman==d)).map(d=>({woman:d,distance:n(a,d)})).sort((d,f)=>R(d,f,b=>b.distance))[0];r.push({man:a,woman:l.woman,status:0,distance:l.distance})}o()}this._map=new Map;for(const a of r.filter(c=>c.status==1))this._map.set(a.man,a.woman);for(const a of t)r.find(c=>c.man==a&&c.status==1)||this._map.set(a,e.fitPitch(a,i));for(let a=12;a<24;a++)t.find(c=>c==a)||this._map.set(a,e.fitPitch(a,i))}fitPitch(t){typeof t=="string"&&(t=C(t));const e=m(t,12)+12;return this._map.get(e)+t-e}}class ke{constructor(){this._l1=new u("L1"),this._l2=new u("L2"),this._r1=new u("R1"),this._r2=new u("R2"),this._x=new u("x"),this._square=new u("square"),this._circle=new u("circle"),this._triangle=new u("triangle"),this._up=new u("up"),this._left=new u("left"),this._right=new u("right"),this._down=new u("down"),this._share=new u("share"),this._options=new u("options"),this._l3=new u("L3"),this._l3_x=new Q("L3_X"),this._l3_y=new Q("L3_Y"),this._l3_magnitude=new Q("L3_magnitude"),this._l3_rotation=new Q("L3_rotation"),this._r3=new u("R3"),this._r3_x=new Q("R3_X"),this._r3_y=new Q("R3_Y"),this._r3_magnitude=new Q("R3_magnitude"),this._r3_rotation=new Q("R3_rotation"),this._ps=new u("PS"),this._touchpad=new u("touchpad"),this._buttons=[this.x,this.circle,this.square,this.triangle,this.L1,this.R1,this.L2,this.R2,this.share,this.options,this.L3,this.R3,this.up,this.down,this.left,this.right,this.PS,this.touchpad],this._axes=[this.L3_X,this.L3_Y,this.R3_X,this.R3_Y]}get typeName(){return"shimi.PS4Controller"}get buttons(){return this._buttons}get axes(){return this._axes}get L1(){return this._l1}get L2(){return this._l2}get R1(){return this._r1}get R2(){return this._r2}get x(){return this._x}get square(){return this._square}get circle(){return this._circle}get triangle(){return this._triangle}get up(){return this._up}get left(){return this._left}get right(){return this._right}get down(){return this._down}get share(){return this._share}get options(){return this._options}get L3(){return this._l3}get L3_X(){return this._l3_x}get L3_Y(){return this._l3_y}get L3_magnitude(){return this._l3_magnitude}get L3_rotation(){return this._l3_rotation}get R3(){return this._r3}get R3_X(){return this._r3_x}get R3_Y(){return this._r3_y}get R3_magnitude(){return this._r3_magnitude}get R3_rotation(){return this._r3_rotation}get PS(){return this._ps}get touchpad(){return this._touchpad}update(t){for(const e of this.buttons)e.update(t);for(const e of this.axes)e.update(t);this.L3_magnitude.valueTracker.value=Math.min(1,Math.sqrt(Math.pow(this.L3_X.value,2)+Math.pow(this.L3_Y.value,2))),this.L3_magnitude.update(t),this.R3_magnitude.valueTracker.value=Math.min(1,Math.sqrt(Math.pow(this.R3_X.value,2)+Math.pow(this.R3_Y.value,2))),this.R3_magnitude.update(t),this.L3_X.value==0&&this.L3_Y.value==0?this.L3_rotation.valueTracker.value=0:this.L3_rotation.valueTracker.value=180*Math.atan2(this.L3_X.value,-this.L3_Y.value)/Math.PI,this.L3_rotation.update(t),this.R3_X.value==0&&this.R3_Y.value==0?this.R3_rotation.valueTracker.value=0:this.R3_rotation.valueTracker.value=180*Math.atan2(this.R3_X.value,-this.R3_Y.value)/Math.PI,this.R3_rotation.update(t)}canMatch(t){return t.buttons.length==this.buttons.length&&t.axes.length==this.axes.length}}class wt{constructor(t){this._isFinished=!1,this._finished=new I,this._action=t,p.default&&p.default.addChild(this)}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}get action(){return this._action}update(t){}finish(){this._isFinished=!0,this.finished.trigger(new B(this))}withRef(t){return this._ref=t,this}}class Ft{constructor(t){this._ms=t}get ms(){return this._ms}}class Pe extends wt{constructor(t,e){super(e),this._countPassed=0,this._condition=t}get typeName(){return"shimi.ConditionalRepeat"}get condition(){return this._condition}update(t){this._countPassed+=t,this.condition()?this.finish():this.action(new Ft(this._countPassed))}}class Qt extends Ft{constructor(t,e){super(t),this._percent=e}get percent(){return this._percent}}class Be extends wt{constructor(t,e){super(e),this._countPassed=0,this._msCount=t}get typeName(){return"shimi.MsRepeat"}get msCount(){return this._msCount}update(t){this._countPassed+=t,this._countPassed>=this.msCount?this.finish():this.action(new Qt(this._countPassed,this._countPassed/this.msCount))}}class Ie extends Qt{constructor(t,e,i){super(t,i),this._beat=e}get beat(){return this._beat}}class Se extends wt{constructor(t,e,i){super(i),this._beatsPassed=0,this._msPassed=0,this._metronome=t,this._beatCount=e}get typeName(){return"shimi.BeatRepeat"}get metronome(){return this._metronome}get beatCount(){return this._beatCount}update(t){this._msPassed+=t,this._beatsPassed+=this.metronome.totalBeatTracker.value-this.metronome.totalBeatTracker.oldValue,this._beatsPassed>=this.beatCount?this.finish():this.action(new Ie(this._msPassed,this._beatsPassed,this._beatsPassed/this.beatCount))}}class Oe{static until(t,e){return new Pe(t,e)}static forMs(t,e){return new Be(t,e)}static forBeats(t,e,i){return new Se(t,e,i)}}class Te{constructor(t,e,i){this.pitch=t,this.letter=e,this.accidental=i}toString(){if(this.accidental==null)return this.letter;if(this.accidental==0)return this.letter+"‚ôÆ";let t=this.letter;return Math.abs(this.accidental)>=2&&(t+=(this.accidental>0?"ùÑ™":"ùÑ´").repeat(Math.abs(this.accidental/2))),Math.abs(this.accidental)%2==1&&(t+=this.accidental>0?"‚ôØ":"‚ô≠"),t}}class G{constructor(t,e){let i=typeof e=="string"?C(e):e;i=m(i,12),this._pitches=t.shape.map(s=>(i+s)%12),this._template=t,this._generatePitchNames(),this.name=this.getPitchName(this.root)+" "+t.name}get typeName(){return"shimi.Scale"}get name(){return this._name}set name(t){this._name=t}get pitches(){return this._pitches}get template(){return this._template}get length(){return this.pitches.length}get root(){return this.pitches[0]}contains(t){return typeof t=="string"&&(t=C(t)),t=m(t,12),this.pitches.find(e=>e==t)!=null}degreeOf(t){typeof t=="string"&&(t=C(t)),t=m(t,12);for(let e=0;e<this.pitches.length;e++)if(this.pitches[e]==t)return e+1;return-1}getPitchName(t,e=!1){typeof t=="string"&&(t=C(t));let i=this._pitchNames[m(t,12)].toString();return e&&(i+=Math.floor(t/12)-1),i}getPitchByDegree(t,e=-1){t=Math.round(t-1);let i=Math.floor(t/this.length);t-=i*this.length;const s=this.pitches[m(t,this.length)];return s<this.root&&i++,s+12*i+12*(e+1)}pitchesInRange(t,e){if(typeof t=="string"&&(t=C(t)),typeof e=="string"&&(e=C(e)),t>e)return this.pitchesInRange(e,t);let i=[];const s=this.pitches.slice().sort((r,n)=>R(r,n,o=>o));for(let r=12*Math.floor(t/12);;r+=12){for(const n of s){const o=n+r;o>=t&&o<=e&&i.push(o)}if(r>e)break}return i}fitPitch(t,e){typeof t=="string"&&(t=C(t));let i=1;(e=new kt(e)).preferredDirection=="DOWN"?i=-1:e.preferredDirection=="RANDOM"&&(i=Math.random()>=.5?1:-1);let s=t,r=t;for(t%1!=0&&(s=i>0?Math.ceil(t):Math.floor(t),r=i>0?Math.floor(t):Math.ceil(t));;){const n=Math.abs(s-t)<=e.maxMovement,o=Math.abs(r-t)<=e.maxMovement;if(!n&&!o)break;if(e.preferRoot){if(n&&m(s,12)==this.root)return s;if(o&&m(r,12)==this.root)return r}const a=n&&this.contains(s),c=o&&this.contains(r);if(a||c)return a&&c?Math.abs(s-t)<=Math.abs(r-t)?s:r:a?s:r;s+=i,r-=i}return Math.round(t)}_generatePitchNames(){var t,e;const i=m(this.root-this.template.relativityToMajor,12),s=[0,7,2,9,4,11].find(d=>d==i)!=null?1:-1,r=(d,f,b)=>new Te(d,f,b),n=[[r(0,"B",1),r(0,"C",0),r(0,"D",-2)],[r(1,"B",2),r(1,"C",1),r(1,"D",-1)],[r(2,"C",2),r(2,"D",0),r(2,"E",-2)],[r(3,"D",1),r(3,"E",-1),r(3,"F",-2)],[r(4,"D",2),r(4,"E",0),r(4,"F",-2)],[r(5,"E",1),r(5,"F",0),r(5,"G",-2)],[r(6,"E",2),r(6,"F",1),r(6,"G",-1)],[r(7,"F",2),r(7,"G",0),r(7,"A",-2)],[r(8,"G",1),r(8,"A",-1)],[r(9,"G",2),r(9,"A",0),r(9,"B",-2)],[r(10,"A",1),r(10,"B",-1),r(10,"C",-2)],[r(11,"A",2),r(11,"B",0),r(11,"C",-1)]],o=[null,-1,1,-1,1,null,null,null,-1,1,-1,1],a=[];let c=this.pitches.slice();for(const d of c){let f=n[d];const b=f.find(v=>v.accidental==0&&this._notInUsedNames(v,a));if(b){a.push(r(d,b.letter));continue}const L=(t=o[m(d-this.root,12)])!==null&&t!==void 0?t:s;let S=f.filter(v=>this._matchesPreference(v,L)&&this._notInUsedNames(v,a));S.length==0&&(S=f.filter(v=>this._notInUsedNames(v,a)),S.length==0&&(S=f.filter(v=>this._matchesPreference(v,L)))),a.push(S.sort((v,X)=>R(v,X,ot=>Math.abs(ot.accidental)))[0])}const l=[...Array(12).keys()].filter(d=>c.find(f=>d==f)==null);for(const d of l){let f=n[d];if(m(d-this.root,12)==11&&a[0].accidental==1){a.push(f.filter(S=>S.accidental>0)[0]);continue}const b=f.find(S=>S.accidental==0);if(b){a.push(b);continue}const L=(e=o[m(d-this.root,12)])!==null&&e!==void 0?e:s;a.push(f.filter(S=>this._matchesPreference(S,L)).sort((S,v)=>R(S,v,X=>Math.abs(X.accidental)))[0])}this._pitchNames=a.sort((d,f)=>R(d,f,b=>b.pitch))}_notInUsedNames(t,e){return!e.find(i=>i.letter==t.letter)}_matchesPreference(t,e){return t.accidental*e>=0}getDominantScale(){return new G(this.template,this.root+7)}getSubdominantScale(){return new G(this.template,this.root+5)}getTransposedScale(t){return new G(this.template,this.root+t)}getRelativeScale(t){return t==this.template?this:new G(t,this.root-this.template.relativityToMajor+t.relativityToMajor)}getParallelScale(t){return t==this.template?this:new G(t,this.root)}}class g{constructor(t,e,i){if(this._shape=[],this._relativityToMajor=0,e.length==0)throw new Error("Invalid scale template, shape cannot be empty");if(e.find(s=>s<=0||s>=12)!=null)throw new Error("Invalid scale template shape, must contain unique numbers only between 0 - 11");(e=e.sort((s,r)=>s-r))[0]!=0&&e.unshift(0);for(let s=0;s+1<e.length;s++)if(e[s]==e[s+1])throw new Error("Invalid scale template, no duplicate numbers allowed in the shape");this.name=t,this._shape=e,this.relativityToMajor=i}get typeName(){return"shimi.ScaleTemplate"}get name(){return this._name}set name(t){this._name=t}get shape(){return this._shape}get relativityToMajor(){return this._relativityToMajor}set relativityToMajor(t){this._relativityToMajor=t}create(t){return new G(this,t)}static get major(){return g._major}static get ionian(){return g._major}static get dorian(){return g._dorian}static get phrygian(){return g._phrygian}static get lydian(){return g._lydian}static get mixolydian(){return g._mixolydian}static get naturalMinor(){return g._naturalMinor}static get aeolian(){return g._naturalMinor}static get harmonicMinor(){return g._harmonicMinor}static get melodicMinor(){return g._melodicMinor}static get locrian(){return g._locrian}static get majorPentatonic(){return g._majorPentatonic}static get minorPentatonic(){return g._minorPentatonic}static get wholeTone(){return g._wholeTone}static get diminished(){return g._diminished}}g._major=new g("Major",[2,4,5,7,9,11],0),g._dorian=new g("Dorian",[2,3,5,7,9,10],2),g._phrygian=new g("Phrygian",[1,3,5,7,8,10],4),g._lydian=new g("Lydian",[2,4,6,7,9,11],5),g._mixolydian=new g("Mixolydian",[2,4,5,7,9,10],-5),g._naturalMinor=new g("Natural Minor",[2,3,5,7,8,10],-3),g._harmonicMinor=new g("Harmonic Minor",[2,3,5,7,8,11],-3),g._melodicMinor=new g("Melodic Minor",[2,3,5,7,9,11],-3),g._locrian=new g("Locrian",[1,3,5,6,8,10],-1),g._majorPentatonic=new g("Major Pentatonic",[2,4,7,9],0),g._minorPentatonic=new g("Minor Pentatonic",[3,5,8,10],-3),g._wholeTone=new g("Whole Tone",[2,4,6,8,10],0),g._diminished=new g("Diminished",[2,3,5,6,8,9,11],-3);class xe{constructor(t,e,i=24){this._newTicksReceived=0,this._onMidiTick=()=>{this._newTicksReceived++},this._onSongPosition=s=>{const r=6*s.message.value/this.ticksPerQuarterNote;this.metronome.setSongPosition(r)},this._isFinished=!1,this._finished=new I,this.midiIn=t,this.metronome=e,this.ticksPerQuarterNote=i,p.default&&p.default.addChild(this)}get typeName(){return"shimi.TickReceiver"}get midiIn(){return this._midiIn}set midiIn(t){if(!t)throw new Error("midiIn cannot be set to null");t!==this._midiIn&&(this._midiIn&&(this._midiIn.tick.remove(e=>e.logic==this._onMidiTick),this._midiIn.songPosition.remove(e=>e.logic==this._onSongPosition)),this._midiIn=t,this._midiIn.tick.add(this._onMidiTick),this._midiIn.songPosition.add(this._onSongPosition))}get metronome(){return this._metronome}set metronome(t){if(!t)throw new Error("metronome cannot be set to null");this._metronome=t}get ticksPerQuarterNote(){return this._ticksPerQuarterNote}set ticksPerQuarterNote(t){if(t<=0)throw new Error("ticksPerQuarterNote must be greater than 0");this._ticksPerQuarterNote=t}get newTicksReceived(){return this._newTicksReceived}get ref(){return this._ref}set ref(t){this._ref=t}withRef(t){return this._ref=t,this}get isFinished(){return this._isFinished}get finished(){return this._finished}finish(){this._isFinished=!0,this.midiIn.tick.remove(t=>t.logic==this._onMidiTick),this.midiIn.songPosition.remove(t=>t.logic==this._onSongPosition),this.finished.trigger(new B(this))}update(t){const e=this.newTicksReceived,i=e/this.ticksPerQuarterNote;this.metronome.updateFromQuarterNoteDelta(i),this._newTicksReceived-=e}}class Ee{constructor(t,e,i=24){this._onPositionChanged=()=>{this.midiOut.sendMessage(new et(this.ticksPerQuarterNote*this.metronome.totalQuarterNote/6))},this._onStarted=()=>{this.midiOut.sendMessage(new it)},this._onContinued=()=>{this.midiOut.sendMessage(new st)},this._onStopped=()=>{this.midiOut.sendMessage(new rt)},this._isFinished=!1,this._finished=new I,this.metronome=t,this.midiOut=e,this.ticksPerQuarterNote=i,p.default&&p.default.addChild(this)}get typeName(){return"shimi.TickSender"}get metronome(){return this._metronome}set metronome(t){if(!t)throw new Error("metronome cannot be set to null");t!==this._metronome&&(this._metronome&&this._unsubscribeFromMetronomeEvents(),this._metronome=t,this._subscribeToMetronomeEvents())}get midiOut(){return this._midiOut}set midiOut(t){if(!t)throw new Error("midiOut cannot be set to null");this._midiOut=t}get ticksPerQuarterNote(){return this._ticksPerQuarterNote}set ticksPerQuarterNote(t){if(t<=0)throw new Error("ticksPerQuarterNote must be greater than 0");this._ticksPerQuarterNote=t}_unsubscribeFromMetronomeEvents(){this._metronome.positionChanged.remove(t=>t.logic==this._onPositionChanged),this._metronome.started.remove(t=>t.logic==this._onStarted),this._metronome.continued.remove(t=>t.logic==this._onContinued),this._metronome.stopped.remove(t=>t.logic==this._onStopped)}_subscribeToMetronomeEvents(){this._metronome.positionChanged.add(this._onPositionChanged),this._metronome.started.add(this._onStarted),this._metronome.continued.add(this._onContinued),this._metronome.stopped.add(this._onStopped)}get ref(){return this._ref}set ref(t){this._ref=t}withRef(t){return this._ref=t,this}get isFinished(){return this._isFinished}get finished(){return this._finished}finish(){this._isFinished=!0,this.finished.trigger(new B(this))}update(t){const e=this.metronome.totalQuarterNoteTracker.oldValue,i=this.metronome.totalQuarterNoteTracker.value,s=1/this.ticksPerQuarterNote;let r=Math.floor(e)+Math.floor(e%1/s)*s;for(;r+=s,!(r>=i);)this.midiOut.sendMessage(new tt)}}class Re{constructor(t,e){this._isPolyphonic=!1,this._pitchBendPercent=0,this.onControlChange=null,this._target=t,this._parent=e,this.controlValues=Array(128).fill(0),t.name!="Sampler"&&t.name!="PolySynth"||(this._isPolyphonic=!0)}get typeName(){return"shimi.ToneJSMidiOutChannel"}get target(){return this._target}get isPolyphonic(){return this._isPolyphonic}get parent(){return this._parent}onNoteStart(t){this.target.name=="NoiseSynth"?this.target.triggerAttack(this.parent.toneJS.now(),t.velocity/127):this.target.triggerAttack(dt(t.pitch),this.parent.toneJS.now(),t.velocity/127)}onNoteStop(t){this._isPolyphonic?this.target.triggerRelease(dt(t.pitch),this.parent.toneJS.now()):this.target.triggerRelease(this.parent.toneJS.now())}onPitchBend(t){if(this._isPolyphonic)return!1;const e=t.percent-this._pitchBendPercent;this._pitchBendPercent=t.percent;const i=this.target.frequency.value*Math.pow(2,2*e/12);return this.target.frequency.value=i,!0}}class De{constructor(t){if(this._channels=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this._notes=[],this._isFinished=!1,this._finished=new I,!t)throw new Error("toneJS reference cannot be falsy");this._toneJS=t,p.default&&p.default.addChild(this)}get typeName(){return"shimi.ToneJSMidiOut"}get channels(){return this._channels}get toneJS(){return this._toneJS}setChannel(t,e){if(t<0||t>15)throw new Error("Channel must be numbered 0 - 15");this._channels[t]=e?new Re(e,this):null}get notes(){return this._notes}addNote(t){const e=this._channels[t.channel];if(e)return this._notes.push(t),t.on&&(e.onNoteStart(t),t.onTracker.accept()),t}stopNotes(t){for(const e of this._notes)t&&!t(e)||e.stop()}sendMessage(t){const e=t.typeName;if(e=="shimi.NoteOffMessage"){const i=t;return this.stopNotes(s=>s.pitch==i.pitch&&s.channel==i.channel),!0}if(e=="shimi.NoteOnMessage"){const i=t;return!!this.addNote(new nt(i.pitch,i.velocity,i.channel))}if(e=="shimi.ControlChangeMessage"){const i=t,s=this._channels[i.channel];if(s){if(i.controller<0||i.controller>127)throw new Error("CC control must be between 0 & 127");if(i.value<0||i.value>127)throw new Error("CC value must be between 0 & 127");return s.controlValues[i.controller]=i.value,s.onControlChange&&s.onControlChange(i,s.target),!0}}else if(e=="shimi.PitchBendMessage"){const i=t,s=this._channels[i.channel];if(s)return s.onPitchBend(i)}return!1}sendRawData(t){if(t.length==0)return;const e=16*Math.floor(t[0]/16),i=t[0]-e;return e==128?this.sendMessage(new A(t[1],t[2],i)):e==144?this.sendMessage(new D(t[1],t[2],i)):e==176&&this.sendMessage(new J(t[1],t[2],i))}update(t){let e=!1;for(let i=0;i<this._notes.length;i++){const s=this._notes[i];if(!s.on){if(s.onTracker.isDirty){let r=!0;const n=this._channels[s.channel];if(n)for(let o=i+1;o<this.notes.length;o++){const a=this.notes[o];if(s.channel==a.channel&&a.on&&!a.onTracker.isDirty&&(!n.isPolyphonic||s.pitch==a.pitch)){r=!1;break}}r&&n.onNoteStop(s),s.onTracker.accept()}e=!0}}e&&(this._notes=this._notes.filter(i=>i.on))}get isFinished(){return this._isFinished}get finished(){return this._finished}finish(){this._isFinished=!0,this.stopNotes(),this.finished.trigger(new B(this))}get ref(){return this._ref}set ref(t){this._ref=t}withRef(t){return this._ref=t,this}}class bt{constructor(t,e,i=.1){this.audioContext=t,this.type=e,this._gainNode=t.createGain(),this._gainNode.gain.value=i,this._gainNode.connect(this.audioContext.destination)}get typeName(){return"shimi.WebAudioMidiOutChannel"}get gain(){return this._gainNode.gain.value}set gain(t){this._gainNode.gain.value=t}createOscillator(t){const e=this.audioContext.createOscillator();return e.type=this.type,e.connect(this._gainNode),e.frequency.value=t,e.start(),e}}class Fe{constructor(t){this._channels=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this._notes=[],this._previousStatus=null,this._isFinished=!1,this._finished=new I,this._audioContext=t,p.default&&p.default.addChild(this)}get typeName(){return"shimi.WebAudioMidiOut"}get audioContext(){return this._audioContext}withChannel(t,e,i=.1){return this._channels[t]=new bt(this._audioContext,e,i),this}withDefaultChannels(){const t=["sine","square","sawtooth","triangle"];for(let e=0;e<16;e++)this._channels[e]||(this._channels[e]=new bt(this.audioContext,t[e%4]));return this}get notes(){return this._notes}addNote(t){return this._notes.push(t),t.on&&(this._createOscillator(t),t.onTracker.accept()),t}stopNotes(t){for(const e of this._notes)t&&!t(e)||(e.oscillator.stop(),delete e.oscillator,e.stop());this._notes=this._notes.filter(e=>e.on)}sendMessage(t){const e=t.typeName;if(e=="shimi.NoteOffMessage"){const i=t;this.stopNotes(s=>s.pitch==i.pitch&&s.channel==i.channel)}else if(e=="shimi.NoteOnMessage"){const i=t,s=new nt(i.pitch,i.velocity,i.channel);this.addNote(s)}}sendRawData(t){if(t.length==0||t[0]==248)return;if(t[0]>=128)this._previousStatus=t[0];else{if(!this._previousStatus)return;t.unshift(this._previousStatus)}const e=16*Math.floor(t[0]/16),i=t[0]-e;e==128?this.sendMessage(new A(t[1],t[2],i)):e==144?this.sendMessage(new D(t[1],t[2],i)):e==160?this.sendMessage(new U(t[1],t[2],i)):e==176?this.sendMessage(new J(t[1],t[2],i)):e==192?this.sendMessage(new $(t[1],i)):e==208?this.sendMessage(new Z(t[1],i)):e==224&&this.sendMessage(new F(F.calculatePercent(t[1],t[2]),i))}get ref(){return this._ref}set ref(t){this._ref=t}get isFinished(){return this._isFinished}get finished(){return this._finished}update(t){let e=!1;for(let i=0;i<this._notes.length;i++){const s=this._notes[i];s.on||(s.onTracker.isDirty&&(s.oscillator.stop(),delete s.oscillator,s.onTracker.accept()),e=!0)}e&&(this._notes=this._notes.filter(i=>i.on))}finish(){this.stopNotes(t=>!0),this._isFinished=!0,this.finished.trigger(new B(this))}withRef(t){return this._ref=t,this}_createOscillator(t){const e=this._channels[t.channel];t.oscillator=e.createOscillator(dt(t.pitch))}}return x})())})(At);var Ge=At.exports;export{Ge as d,Ve as n,Je as r,Ue as t};
